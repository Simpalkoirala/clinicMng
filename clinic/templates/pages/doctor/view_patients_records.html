{% extends "pages/doctor/D_base.html" %}
{% load static %}

{% block titles %}View Patients Records|| Nepal's Care {% endblock titles %}

{% block pageof %} View Patients Records{% endblock pageof %}

{% block content %}
<div class="bg-gradient-to-b from-gray-50 to-gray-100 min-h-screen p-2 sm:p-4">
    <!-- Header -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 rounded-xl bg-white shadow-md hover:shadow-lg transition-shadow duration-300 mt-4 border border-gray-100">
        <div class="flex flex-col sm:flex-row items-center gap-6">
            <div class="flex-shrink-0">
                <img class="h-20 w-20 rounded-full border-4 border-blue-200 shadow" src="{{ patient.profile_pic.url }}" alt="Patient's Profile Picture">
            </div>
            <div class="flex-1 w-full">
                <h1 class="text-2xl font-bold text-gray-900 mb-1">
                    Records Of: <span class="text-blue-600">{{ patient.user.first_name }}</span>
                </h1>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-1 text-sm">
                    <div>
                        <span class="font-semibold text-gray-700">Patient ID:</span>
                        <span class="text-gray-600">{{ patient.user.username }}</span>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-700">Age:</span>
                        <span class="text-gray-600">{{ patient.date_of_birth }}</span>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-700">Gender:</span>
                        <span class="text-gray-600">{{ patient.gender }}</span>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-700">Blood Group:</span>
                        <span class="inline-block px-2 py-0.5 rounded bg-blue-50 text-blue-700 font-semibold">{{ patient.medical_info.blood_group }}</span>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-700">Allergies:</span>
                        <span class="text-gray-600">{{ patient.medical_info.allergies|default:"None" }}</span>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-700">Medical Conditions:</span>
                        <span class="text-gray-600">{{ patient.medical_info.medical_conditions|default:"None" }}</span>
                    </div>
                    <div class="sm:col-span-2">
                        <span class="font-semibold text-gray-700">Running Medications:</span>
                        <span class="text-gray-600">{{ patient.medical_info.on_going_medications|default:"None" }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Tabs -->
        <div class="border-b border-gray-200 flex justify-center sm:justify-start">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button id="tab-lab-reports" class="tab-button border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all duration-200 hover:text-blue-800" aria-current="page">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Lab Reports
                    </div>
                </button>
                <button id="tab-prescriptions" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all duration-200">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                        </svg>
                        Prescriptions
                    </div>
                </button>
            </nav>
        </div>

        <!-- Content Sections -->
        <div class="mt-6">
            <!-- Lab Reports Section -->
            <div id="section-lab-reports" class="tab-content">
                <div class="flex flex-col lg:flex-row gap-6">
                    <!-- Lab Reports List -->
                    <div class="w-full lg:w-1/3">
                        <div class="bg-white shadow-md hover:shadow-lg transition-shadow duration-300 overflow-hidden rounded-lg border border-gray-100">
                            <div class="px-4 py-5 border-b border-gray-200 sm:px-6 bg-gradient-to-r from-blue-50 to-white">
                                <h3 class="text-lg leading-6 font-medium text-gray-900 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                    </svg>
                                    Lab Reports
                                </h3>
                                <div class="mt-3 flex items-center">
                                    <span class="text-sm text-gray-500">Filter by:</span>
                                    <select id="lab-report-filter" class="ml-2 block pl-3 pr-10 py-1 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm">
                                        <option value="all">All</option>
                                        <option value="normal">Normal</option>
                                        <option value="abnormal">Abnormal</option>
                                        <option value="pending">Pending</option>
                                        <option value="neutral">Neutral</option>
                                    </select>
                                </div>
                            </div>
                            <ul class="divide-y divide-gray-200 max-h-[500px] overflow-y-auto" id="lab-reports-list">
                                {% for report in lab_reports %}
                                <li class="lab-report-item-container" data-status="{{ report.status }}">
                                    <a href="#" class="lab-report-item block hover:bg-blue-50 transition-colors duration-150" 
                                       data-id="{{ report.id }}"
                                       data-report-type="{{ report.report_type }}"
                                       data-report-date="{{ report.report_date }}"
                                       data-status="{{ report.status }}"
                                       data-description="{{ report.report_description }}">
                                        <div class="px-4 py-4 sm:px-6">
                                            <div class="flex items-center justify-between">
                                                <p class="text-sm font-medium text-blue-600 truncate">{{ report.report_type }}</p>
                                                <div class="ml-2 flex-shrink-0 flex">
                                                    {% if report.status == 'normal' %}
                                                    <p class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                                        Normal
                                                    </p>
                                                    {% elif report.status == 'abnormal' %}
                                                    <p class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                                        Abnormal
                                                    </p>
                                                    {% elif report.status == 'pending' %}
                                                    <p class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                                        Pending
                                                    </p>
                                                    {% else %}
                                                    <p class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                                        Neutral
                                                    </p>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="mt-2 sm:flex sm:justify-between">
                                                <div class="sm:flex">
                                                    <p class="flex items-center text-sm text-gray-500">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                        </svg>
                                                        <span>{{ report.report_date }}</span>
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                    <!-- Hidden parameters data -->
                                    <div class="hidden lab-report-parameters" data-report-id="{{ report.id }}">
                                        {% for param in report.parameters.all %}
                                        <div class="parameter-data"
                                             data-name="{{ param.parameter_name }}"
                                             data-result="{{ param.result }}"
                                             data-range="{{ param.reference_range }}"
                                             data-status="{{ param.status }}">
                                        </div>
                                        {% endfor %}
                                    </div>
                                </li>
                                {% empty %}
                                <li class="px-4 py-5 text-center">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    <p class="mt-2 text-sm text-gray-500">No lab reports found.</p>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <!-- Lab Report Details -->
                    <div class="w-full lg:w-2/3 bg-white shadow-md hover:shadow-lg transition-shadow duration-300 overflow-hidden rounded-lg border border-gray-100" id="lab-report-details">
                        <div class="px-4 py-5 sm:px-6 bg-gradient-to-r from-blue-50 to-white border-b border-gray-200">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Lab Report Details
                            </h3>
                            <p class="mt-1 max-w-2xl text-sm text-gray-500">Select a lab report to view details.</p>
                        </div>
                        <div class="border-t border-gray-200 px-4 py-5 sm:p-0 lab-report-content hidden">
                            <dl class="sm:divide-y sm:divide-gray-200">
                                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                        </svg>
                                        Report Type
                                    </dt>
                                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="detail-report-type"></dd>
                                </div>
                                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                        Date
                                    </dt>
                                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="detail-report-date"></dd>
                                </div>
                                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        Status
                                    </dt>
                                    <dd class="mt-1 text-sm sm:mt-0 sm:col-span-2" id="detail-report-status"></dd>
                                </div>
                                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        Description
                                    </dt>
                                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="detail-report-description"></dd>
                                </div>
                            </dl>
                            
                            <div class="px-4 py-5 sm:px-6 border-t border-gray-200 bg-gradient-to-r from-blue-50 to-white">
                                <h4 class="text-lg leading-6 font-medium text-gray-900 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                    </svg>
                                    Parameters
                                </h4>
                            </div>
                            <div class="px-4 pb-5 overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parameter</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Result</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reference Range</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="parameters-table-body">
                                        <!-- Parameters will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-200 px-4 py-5 sm:p-0 lab-report-empty">
                            <div class="py-10 text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h3 class="mt-2 text-sm font-medium text-gray-900">No lab report selected</h3>
                                <p class="mt-1 text-sm text-gray-500">Select a lab report from the list to view details.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Prescriptions Section -->
            <div id="section-prescriptions" class="tab-content hidden">
                <div class="flex flex-col lg:flex-row gap-6">
                    <!-- Prescriptions List -->
                    <div class="w-full lg:w-1/3">
                        <div class="bg-white shadow-md hover:shadow-lg transition-shadow duration-300 overflow-hidden rounded-lg border border-gray-100">
                            <div class="px-4 py-5 border-b border-gray-200 sm:px-6 bg-gradient-to-r from-blue-50 to-white">
                                <h3 class="text-lg leading-6 font-medium text-gray-900 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                                    </svg>
                                    Prescriptions
                                </h3>
                                <div class="mt-3 flex items-center">
                                    <span class="text-sm text-gray-500">Filter by:</span>
                                    <select id="prescription-filter" class="ml-2 block pl-3 pr-10 py-1 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm">
                                        <option value="all">All</option>
                                        <option value="active">Active</option>
                                        <option value="completed">Completed</option>
                                        <option value="discontinued">Discontinued</option>
                                        <option value="break">In Break</option>
                                    </select>
                                </div>
                            </div>
                            <ul class="divide-y divide-gray-200 max-h-[500px] overflow-y-auto" id="prescriptions-list">
                                {% for prescription in prescriptions %}
                                <li class="prescription-item-container" data-status="{{ prescription.status }}">
                                    <a href="#" class="prescription-item block hover:bg-blue-50 transition-colors duration-150" 
                                       data-id="{{ prescription.id }}"
                                       data-medicine-name="{{ prescription.medicine.name }}"
                                       data-brand-name="{{ prescription.medicine.brand_name }}"
                                       data-generic-name="{{ prescription.medicine.generic_name }}"
                                       data-dosage="{{ prescription.update_dosage }}"
                                       data-frequency="{{ prescription.update_frequency }}"
                                       data-start-date="{{ prescription.start_date|date:'Y-m-d' }}"
                                       data-end-date="{{ prescription.end_date|date:'Y-m-d' }}"
                                       data-status="{{ prescription.status }}"
                                       data-notes="{{ prescription.notes }}">
                                        <div class="px-4 py-4 sm:px-6">
                                            <div class="flex items-center justify-between">
                                                <p class="text-sm font-medium text-blue-600 truncate">{{ prescription.medicine.name }}</p>
                                                <div class="ml-2 flex-shrink-0 flex">
                                                    {% if prescription.status == 'active' %}
                                                    <p class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                                        Running
                                                    </p>
                                                    {% elif prescription.status == 'completed' %}
                                                    <p class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                                        Completed
                                                    </p>
                                                    {% elif prescription.status == 'discontinued' %}
                                                    <p class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                                        Discontinued
                                                    </p>
                                                    {% else %}
                                                    <p class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                                        In Break
                                                    </p>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="mt-2 sm:flex sm:justify-between">
                                                <div class="sm:flex">
                                                    <p class="flex items-center text-sm text-gray-500">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                        </svg>
                                                        <span>{{ prescription.update_dosage }} - {{ prescription.update_frequency }}</span>
                                                    </p>
                                                </div>
                                                <div class="mt-2 flex items-center text-sm text-gray-500 sm:mt-0">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                    </svg>
                                                    <span>{{ prescription.start_date|date:"M d, Y" }} - {{ prescription.end_date|date:"M d, Y" }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                    <!-- Hidden schedule data -->
                                    <div class="hidden prescription-schedule" data-prescription-id="{{ prescription.id }}">
                                        {% for schedule in prescription.timeschedule.all %}
                                        <div class="schedule-data"
                                             data-time="{{ schedule.time }}"
                                             data-had-taken="{{ schedule.had_taken }}">
                                        </div>
                                        {% endfor %}
                                    </div>
                                </li>
                                {% empty %}
                                <li class="px-4 py-5 text-center">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                                    </svg>
                                    <p class="mt-2 text-sm text-gray-500">No prescriptions found.</p>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <!-- Prescription Details -->
                    <div class="w-full lg:w-2/3 bg-white shadow-md hover:shadow-lg transition-shadow duration-300 overflow-hidden rounded-lg border border-gray-100" id="prescription-details">
                        <div class="px-4 py-5 sm:px-6 bg-gradient-to-r from-blue-50 to-white border-b border-gray-200">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                                </svg>
                                Prescription Details
                            </h3>
                            <p class="mt-1 max-w-2xl text-sm text-gray-500">Select a prescription to view details.</p>
                        </div>
                        <div class="border-t border-gray-200 px-4 py-5 sm:p-0 prescription-content hidden">
                            <dl class="sm:divide-y sm:divide-gray-200">
                                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                                        </svg>
                                        Medicine
                                    </dt>
                                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="detail-medicine-name"></dd>
                                </div>
                                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                        </svg>
                                        Generic Name
                                    </dt>
                                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="detail-generic-name"></dd>
                                </div>
                                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                                        </svg>
                                        Dosage
                                    </dt>
                                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="detail-dosage"></dd>
                                </div>
                                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        Frequency
                                    </dt>
                                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="detail-frequency"></dd>
                                </div>
                                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                        Duration
                                    </dt>
                                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="detail-duration"></dd>
                                </div>
                                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        Status
                                    </dt>
                                    <dd class="mt-1 text-sm sm:mt-0 sm:col-span-2" id="detail-prescription-status"></dd>
                                </div>
                                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                                        </svg>
                                        Notes
                                    </dt>
                                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="detail-notes"></dd>
                                </div>
                            </dl>
                            
                            <div class="px-4 py-5 sm:px-6 border-t border-gray-200 bg-gradient-to-r from-blue-50 to-white">
                                <h4 class="text-lg leading-6 font-medium text-gray-900 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    Schedule
                                </h4>
                            </div>
                            <div class="px-4 pb-5 overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="schedule-table-body">
                                        <!-- Schedule will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-200 px-4 py-5 sm:p-0 prescription-empty">
                            <div class="py-10 text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                                </svg>
                                <h3 class="mt-2 text-sm font-medium text-gray-900">No prescription selected</h3>
                                <p class="mt-1 text-sm text-gray-500">Select a prescription from the list to view details.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Tab switching
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        // Remove active class from all tabs
        tabButtons.forEach(btn => {
          btn.classList.remove('border-blue-500', 'text-blue-600');
          btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        });
        
        // Add active class to clicked tab
        button.classList.add('border-blue-500', 'text-blue-600');
        button.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        
        // Hide all tab contents
        tabContents.forEach(content => {
          content.classList.add('hidden');
        });
        
        // Show the corresponding content
        const contentId = button.id.replace('tab-', 'section-');
        document.getElementById(contentId).classList.remove('hidden');
      });
    });
    
    // Lab Report selection
    const labReportItems = document.querySelectorAll('.lab-report-item');
    labReportItems.forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        
        // Remove active class from all items
        labReportItems.forEach(i => i.classList.remove('bg-blue-50'));
        
        // Add active class to clicked item
        item.classList.add('bg-blue-50');
        
        // Get the lab report ID
        const reportId = item.getAttribute('data-id');
        
        // Show the lab report details
        document.querySelector('.lab-report-empty').classList.add('hidden');
        document.querySelector('.lab-report-content').classList.remove('hidden');
        
        // Get data from data attributes and update the details
        updateLabReportDetails({
          report_type: item.getAttribute('data-report-type'),
          report_date: item.getAttribute('data-report-date'),
          status: item.getAttribute('data-status'),
          report_description: item.getAttribute('data-description')
        });
        
        // Get parameters from hidden data
        const parametersContainer = document.querySelector(`.lab-report-parameters[data-report-id="${reportId}"]`);
        if (parametersContainer) {
          const parameters = [];
          parametersContainer.querySelectorAll('.parameter-data').forEach(param => {
            parameters.push({
              parameter_name: param.getAttribute('data-name'),
              result: param.getAttribute('data-result'),
              reference_range: param.getAttribute('data-range'),
              status: param.getAttribute('data-status')
            });
          });
          
          updateLabReportParameters(parameters);
        } else {
          // If no parameters found, show sample data for demonstration
          updateLabReportParameters([
            { parameter_name: 'Hemoglobin', result: '10.5 g/dL', reference_range: '13.5-17.5 g/dL', status: 'low' },
            { parameter_name: 'White Blood Cells', result: '11,000/µL', reference_range: '4,500-11,000/µL', status: 'normal' },
            { parameter_name: 'Platelets', result: '450,000/µL', reference_range: '150,000-450,000/µL', status: 'normal' },
            { parameter_name: 'Red Blood Cells', result: '4.2 million/µL', reference_range: '4.5-5.9 million/µL', status: 'low' }
          ]);
        }
      });
    });
    
    // Prescription selection
    const prescriptionItems = document.querySelectorAll('.prescription-item');
    prescriptionItems.forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        
        // Remove active class from all items
        prescriptionItems.forEach(i => i.classList.remove('bg-blue-50'));
        
        // Add active class to clicked item
        item.classList.add('bg-blue-50');
        
        // Get the prescription ID
        const prescriptionId = item.getAttribute('data-id');
        
        // Show the prescription details
        document.querySelector('.prescription-empty').classList.add('hidden');
        document.querySelector('.prescription-content').classList.remove('hidden');
        
        // Get data from data attributes and update the details
        updatePrescriptionDetails({
          medicine: {
            name: item.getAttribute('data-medicine-name'),
            generic_name: item.getAttribute('data-generic-name'),
            brand_name: item.getAttribute('data-brand-name')
          },
          update_dosage: item.getAttribute('data-dosage'),
          update_frequency: item.getAttribute('data-frequency'),
          start_date: item.getAttribute('data-start-date'),
          end_date: item.getAttribute('data-end-date'),
          status: item.getAttribute('data-status'),
          notes: item.getAttribute('data-notes')
        });
        
        // Get schedule from hidden data
        const scheduleContainer = document.querySelector(`.prescription-schedule[data-prescription-id="${prescriptionId}"]`);
        if (scheduleContainer) {
          const schedule = [];
          scheduleContainer.querySelectorAll('.schedule-data').forEach(scheduleItem => {
            schedule.push({
              time: scheduleItem.getAttribute('data-time'),
              had_taken: scheduleItem.getAttribute('data-had-taken') === 'True' || scheduleItem.getAttribute('data-had-taken') === 'true'
            });
          });
          
          updatePrescriptionSchedule(schedule);
        } else {
          // If no schedule found, show sample data for demonstration
          updatePrescriptionSchedule([
            { time: '08:00:00', had_taken: true },
            { time: '14:00:00', had_taken: true },
            { time: '20:00:00', had_taken: false }
          ]);
        }
      });
    });
    
    // Lab Report Filter
    const labReportFilter = document.getElementById('lab-report-filter');
    labReportFilter.addEventListener('change', function() {
      const selectedStatus = this.value;
      const labReportContainers = document.querySelectorAll('.lab-report-item-container');
      let visibleCount = 0;
      
      labReportContainers.forEach(container => {
        if (selectedStatus === 'all' || container.getAttribute('data-status') === selectedStatus) {
          container.style.display = '';
          visibleCount++;
        } else {
          container.style.display = 'none';
        }
      });
      
      // Reset details view if no items are visible
      if (visibleCount === 0) {
        document.querySelector('.lab-report-content').classList.add('hidden');
        document.querySelector('.lab-report-empty').classList.remove('hidden');
        
        // Update empty message
        const emptyMessage = document.querySelector('.lab-report-empty p');
        emptyMessage.textContent = `No ${selectedStatus !== 'all' ? selectedStatus + ' ' : ''}lab reports found.`;
      }
    });
    
    // Prescription Filter
    const prescriptionFilter = document.getElementById('prescription-filter');
    prescriptionFilter.addEventListener('change', function() {
      const selectedStatus = this.value;
      const prescriptionContainers = document.querySelectorAll('.prescription-item-container');
      let visibleCount = 0;
      
      prescriptionContainers.forEach(container => {
        if (selectedStatus === 'all' || container.getAttribute('data-status') === selectedStatus) {
          container.style.display = '';
          visibleCount++;
        } else {
          container.style.display = 'none';
        }
      });
      
      // Reset details view if no items are visible
      if (visibleCount === 0) {
        document.querySelector('.prescription-content').classList.add('hidden');
        document.querySelector('.prescription-empty').classList.remove('hidden');
        
        // Update empty message
        const emptyMessage = document.querySelector('.prescription-empty p');
        emptyMessage.textContent = `No ${selectedStatus !== 'all' ? selectedStatus + ' ' : ''}prescriptions found.`;
      }
    });
    
    // Function to update lab report details in the UI
    function updateLabReportDetails(data) {
      document.getElementById('detail-report-type').textContent = data.report_type || 'N/A';
      document.getElementById('detail-report-date').textContent = data.report_date || 'N/A';
      
      const statusElement = document.getElementById('detail-report-status');
      statusElement.innerHTML = '';
      
      if (data.status) {
        const statusBadge = document.createElement('span');
        statusBadge.classList.add('px-2', 'inline-flex', 'text-xs', 'leading-5', 'font-semibold', 'rounded-full');
        
        if (data.status === 'normal') {
          statusBadge.classList.add('bg-green-100', 'text-green-800');
          statusBadge.textContent = 'Normal';
        } else if (data.status === 'abnormal') {
          statusBadge.classList.add('bg-red-100', 'text-red-800');
          statusBadge.textContent = 'Abnormal';
        } else if (data.status === 'pending') {
          statusBadge.classList.add('bg-yellow-100', 'text-yellow-800');
          statusBadge.textContent = 'Pending';
        } else {
          statusBadge.classList.add('bg-gray-100', 'text-gray-800');
          statusBadge.textContent = 'Neutral';
        }
        
        statusElement.appendChild(statusBadge);
      } else {
        statusElement.textContent = 'N/A';
      }
      
      document.getElementById('detail-report-description').textContent = data.report_description || 'No description available.';
    }
    
    // Function to update lab report parameters in the UI
    function updateLabReportParameters(parameters) {
      const parametersTableBody = document.getElementById('parameters-table-body');
      parametersTableBody.innerHTML = '';
      
      if (!parameters || parameters.length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.setAttribute('colspan', '4');
        cell.classList.add('px-6', 'py-4', 'text-center', 'text-sm', 'text-gray-500');
        cell.textContent = 'No parameters available for this report.';
        row.appendChild(cell);
        parametersTableBody.appendChild(row);
        return;
      }
      
      parameters.forEach(param => {
        const row = document.createElement('tr');
        row.classList.add('hover:bg-gray-50', 'transition-colors', 'duration-150');
        
        // Parameter name
        const nameCell = document.createElement('td');
        nameCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'font-medium', 'text-gray-900');
        nameCell.textContent = param.parameter_name;
        row.appendChild(nameCell);
        
        // Result
        const resultCell = document.createElement('td');
        resultCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
        resultCell.textContent = param.result;
        row.appendChild(resultCell);
        
        // Reference range
        const rangeCell = document.createElement('td');
        rangeCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
        rangeCell.textContent = param.reference_range;
        row.appendChild(rangeCell);
        
        // Status
        const statusCell = document.createElement('td');
        statusCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
        
        const paramStatusBadge = document.createElement('span');
        paramStatusBadge.classList.add('px-2', 'inline-flex', 'text-xs', 'leading-5', 'font-semibold', 'rounded-full');
        
        if (param.status === 'normal') {
          paramStatusBadge.classList.add('bg-green-100', 'text-green-800');
          paramStatusBadge.textContent = 'Normal';
        } else if (param.status === 'high') {
          paramStatusBadge.classList.add('bg-red-100', 'text-red-800');
          paramStatusBadge.textContent = 'High';
        } else if (param.status === 'low') {
          paramStatusBadge.classList.add('bg-blue-100', 'text-blue-800');
          paramStatusBadge.textContent = 'Low';
        } else {
          paramStatusBadge.classList.add('bg-gray-100', 'text-gray-800');
          paramStatusBadge.textContent = param.status.charAt(0).toUpperCase() + param.status.slice(1);
        }
        
        statusCell.appendChild(paramStatusBadge);
        row.appendChild(statusCell);
        
        parametersTableBody.appendChild(row);
      });
    }
    
    // Function to update prescription details in the UI
    function updatePrescriptionDetails(data) {
      document.getElementById('detail-medicine-name').textContent = data.medicine && data.medicine.name ? 
        `${data.medicine.name}${data.medicine.brand_name ? ` (${data.medicine.brand_name})` : ''}` : 'N/A';
      document.getElementById('detail-generic-name').textContent = data.medicine && data.medicine.generic_name ? 
        data.medicine.generic_name : 'N/A';
      document.getElementById('detail-dosage').textContent = data.update_dosage || 'N/A';
      document.getElementById('detail-frequency').textContent = data.update_frequency || 'N/A';
      
      // Format dates for better readability
      let startDate = data.start_date ? formatDate(data.start_date) : 'N/A';
      let endDate = data.end_date ? formatDate(data.end_date) : 'N/A';
      document.getElementById('detail-duration').textContent = `${startDate} to ${endDate}`;
      
      const statusElement = document.getElementById('detail-prescription-status');
      statusElement.innerHTML = '';
      
      if (data.status) {
        const statusBadge = document.createElement('span');
        statusBadge.classList.add('px-2', 'inline-flex', 'text-xs', 'leading-5', 'font-semibold', 'rounded-full');
        
        if (data.status === 'active') {
          statusBadge.classList.add('bg-green-100', 'text-green-800');
          statusBadge.textContent = 'Running';
        } else if (data.status === 'completed') {
          statusBadge.classList.add('bg-blue-100', 'text-blue-800');
          statusBadge.textContent = 'Completed';
        } else if (data.status === 'discontinued') {
          statusBadge.classList.add('bg-red-100', 'text-red-800');
          statusBadge.textContent = 'Discontinued';
        } else if (data.status === 'break') {
          statusBadge.classList.add('bg-yellow-100', 'text-yellow-800');
          statusBadge.textContent = 'In Break';
        } else {
          statusBadge.classList.add('bg-gray-100', 'text-gray-800');
          statusBadge.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
        }
        
        statusElement.appendChild(statusBadge);
      } else {
        statusElement.textContent = 'N/A';
      }
      
      document.getElementById('detail-notes').textContent = data.notes || 'No notes available.';
    }
    
    // Function to update prescription schedule in the UI
    function updatePrescriptionSchedule(schedule) {
      const scheduleTableBody = document.getElementById('schedule-table-body');
      scheduleTableBody.innerHTML = '';
      
      if (!schedule || schedule.length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.setAttribute('colspan', '2');
        cell.classList.add('px-6', 'py-4', 'text-center', 'text-sm', 'text-gray-500');
        cell.textContent = 'No schedule available for this prescription.';
        row.appendChild(cell);
        scheduleTableBody.appendChild(row);
        return;
      }
      
      schedule.forEach(scheduleItem => {
        const row = document.createElement('tr');
        row.classList.add('hover:bg-gray-50', 'transition-colors', 'duration-150');
        
        // Time
        const timeCell = document.createElement('td');
        timeCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'font-medium', 'text-gray-900');
        
        // Format time (HH:MM:SS to HH:MM AM/PM)
        const formattedTime = formatTime(scheduleItem.time);
        
        timeCell.textContent = formattedTime;
        row.appendChild(timeCell);
        
        // Status
        const statusCell = document.createElement('td');
        statusCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
        
        const scheduleStatusBadge = document.createElement('span');
        scheduleStatusBadge.classList.add('px-2', 'inline-flex', 'text-xs', 'leading-5', 'font-semibold', 'rounded-full');
        
        if (scheduleItem.had_taken) {
          scheduleStatusBadge.classList.add('bg-green-100', 'text-green-800');
          scheduleStatusBadge.textContent = 'Taken';
        } else {
          scheduleStatusBadge.classList.add('bg-yellow-100', 'text-yellow-800');
          scheduleStatusBadge.textContent = 'Not Taken';
        }
        
        statusCell.appendChild(scheduleStatusBadge);
        row.appendChild(statusCell);
        
        scheduleTableBody.appendChild(row);
      });
    }
    
    // Helper function to format date (YYYY-MM-DD to Month DD, YYYY)
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString; // Return original if invalid
        
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        return date.toLocaleDateString('en-US', options);
      } catch (e) {
        return dateString; // Return original on error
      }
    }
    
    // Helper function to format time (HH:MM:SS to HH:MM AM/PM)
    function formatTime(timeString) {
      if (!timeString) return 'N/A';
      
      try {
        const timeParts = timeString.split(':');
        let hours = parseInt(timeParts[0]);
        const minutes = timeParts[1];
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12; // the hour '0' should be '12'
        return `${hours}:${minutes} ${ampm}`;
      } catch (e) {
        return timeString; // Return original on error
      }
    }
    
    // Check for mobile devices and adjust layout
    function checkMobileView() {
      const isMobile = window.innerWidth < 1024;
      const labReportsList = document.getElementById('lab-reports-list');
      const prescriptionsList = document.getElementById('prescriptions-list');
      
      if (isMobile) {
        // Add a message to help users understand how to view details
        if (!document.querySelector('.mobile-help-text')) {
          const labHelpText = document.createElement('div');
          labHelpText.className = 'mobile-help-text px-4 py-2 text-xs text-center text-blue-600 bg-blue-50';
          labHelpText.textContent = 'Tap on a report to view details below';
          
          const prescriptionHelpText = document.createElement('div');
          prescriptionHelpText.className = 'mobile-help-text px-4 py-2 text-xs text-center text-blue-600 bg-blue-50';
          prescriptionHelpText.textContent = 'Tap on a prescription to view details below';
          
          labReportsList.parentNode.insertBefore(labHelpText, labReportsList);
          prescriptionsList.parentNode.insertBefore(prescriptionHelpText, prescriptionsList);
        }
      } else {
        // Remove mobile help text if screen is larger
        document.querySelectorAll('.mobile-help-text').forEach(el => el.remove());
      }
    }
    
    // Run on load and on resize
    checkMobileView();
    window.addEventListener('resize', checkMobileView);
    
    // Auto-select first item in each list if available
    function selectFirstItems() {
      const firstLabReport = document.querySelector('.lab-report-item');
      const firstPrescription = document.querySelector('.prescription-item');
      
      if (firstLabReport) {
        firstLabReport.click();
      }
      
      // Don't auto-select prescription since lab reports tab is active by default
    }
    
    // Run after a short delay to ensure DOM is fully loaded
    setTimeout(selectFirstItems, 100);
  });
</script>
{% endblock %}