{% extends "pages/doctor/D_base.html" %}
{% load static %}

{% block titles %}Edit Schedules|| Nepal's Care {% endblock titles %}

{% block pageof %} Edit Schedules{% endblock pageof %}
{% block linkPageof %} /d/edit-schedules/ {% endblock linkPageof %}

{% block styles %}
<!-- <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script> -->

<style>
    /* Custom styles to complement Tailwind CSS */

    .drag-ghost {
        position: absolute;
        pointer-events: none;
        z-index: 1000;
        background-color: white;
        border: 1px solid #ccc;
        padding: 5px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }


    body.dragging .schedule-slot {
        cursor: grabbing !important;
    }

    /* Tab styles */
    .tab-list {
        display: grid;
        border-bottom: 1px solid #e2e8f0;
    }

    .tab-trigger {
        padding: 0.75rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #64748b;
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        border-bottom: none;
        cursor: pointer;
        transition: all 0.2s;
    }

    .tab-trigger:hover {
        background-color: #f1f5f9;
    }

    .tab-trigger.active {
        color: #3730a3;
        background-color: white;
        border-bottom: 2px solid #4f46e5;
    }

    .tab-content {
        display: none;
        padding-top: 1rem;
    }

    .tab-content.active {
        display: block;
    }

    /* Switch styles */
    .switch-container {
        position: relative;
        display: inline-block;
        width: 40px;
        height: 20px;
    }

    .switch-input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .switch {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #e2e8f0;
        transition: .4s;
        border-radius: 34px;
    }

    .switch:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    .switch-input:checked+.switch {
        background-color: #4f46e5;
    }

    .switch-input:checked+.switch:before {
        transform: translateX(20px);
    }

    /* Select styles */
    .select-input {
        width: 100%;
        padding: 0.5rem;
        border-radius: 0.375rem;
        border: 1px solid #e2e8f0;
        background-color: white;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .text-input {
        width: 100%;
        padding: 0.5rem;
        border-radius: 0.375rem;
        border: 1px solid #e2e8f0;
        background-color: white;
        font-size: 0.875rem;
    }

    /* Dialog styles */
    .dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
        z-index: 50;
    }

    .dialog-content {
        background-color: white;
        border-radius: 0.5rem;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .dialog-header {
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .dialog-body {
        padding: 1rem;
    }

    .dialog-footer {
        padding: 1rem;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }

    /* Dropdown menu styles */
    .dropdown-menu {
        position: absolute;
        background-color: white;
        border-radius: 0.375rem;
        border: 1px solid #e2e8f0;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        z-index: 40;
        width: 200px;
    }

    .dropdown-header {
        padding: 0.5rem 1rem;
        font-size: 0.75rem;
        font-weight: 600;
        color: #64748b;
    }

    .dropdown-divider {
        height: 1px;
        background-color: #e2e8f0;
        margin: 0.25rem 0;
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        width: 100%;
        text-align: left;
        background: none;
        border: none;
        cursor: pointer;
    }

    .dropdown-item:hover {
        background-color: #f1f5f9;
    }

    /* Tooltip styles */
    .tooltip {
        position: relative;
        display: inline-block;
    }

    .tooltip .tooltiptext {
        visibility: hidden;
        width: 120px;
        background-color: #1e293b;
        color: white;
        text-align: center;
        border-radius: 6px;
        padding: 5px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -60px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.75rem;
    }

    .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
    }

    .tooltip-box {
        position: absolute;
        background-color: #1e293b;
        color: white;
        border-radius: 0.375rem;
        padding: 0.5rem;
        z-index: 50;
        font-size: 0.75rem;
        max-width: 200px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    /* Schedule slot styles */
    .schedule-slot {
        height: 3.5rem;
        border: 1px solid;
        margin: 0.125rem;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.15s;
        transform-origin: center;
    }

    .schedule-slot:hover {
        transform: scale(1.05);
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }

    .schedule-slot.available {
        background-color: #d1fae5;
        border-color: #6ee7b7;
    }

    .schedule-slot.available:hover {
        background-color: #a7f3d0;
    }

    .schedule-slot.break {
        background-color: #fef3c7;
        border-color: #fcd34d;
    }

    .schedule-slot.break:hover {
        background-color: #fde68a;
    }

    .schedule-slot.booked {
        background-color: #fee2e2;
        border-color: #fca5a5;
        cursor: not-allowed;
    }

    .schedule-slot.unavailable {
        background-color: #f1f5f9;
        border-color: #cbd5e1;
    }

    .schedule-slot.unavailable:hover {
        background-color: #e2e8f0;
    }

    /* Day header styles */
    .day-header {
        height: 3rem;
        position: relative;
        border-radius: 0.5rem 0.5rem 0 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: #f8fafc;
    }

    .day-header.today {
        background-color: #e0e7ff;
    }

    .day-actions {
        position: absolute;
        top: 0.25rem;
        right: 0.25rem;
    }

    .day-selected {
        background-color: #4f46e5 !important;
        color: white !important;
        border-color: #4338ca !important;
    }


</style>

{% endblock styles %}

{% block content %}

<main>
    <div class="container mx-auto p-4">
        <div class="flex flex-col md:flex-row justify-between gap-4 items-start md:items-center mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Edit Your Schedule</h1>
                <p class="text-gray-500">Configure your availability, breaks, and working hours</p>
            </div>

            <div class="flex items-center gap-4">
                <span class="text-sm text-gray-500">
                    Weekly hours: <span id="total-weekly-hours" class="font-medium text-green-500">0h</span>
                </span>

                <button id="save-button"
                    class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-save">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                        <polyline points="17 21 17 13 7 13 7 21" />
                        <polyline points="7 3 7 8 15 8" />
                    </svg>
                    Save Changes
                </button>
            </div>
        </div>

        <div class="tabs">
            <!-- tabs list  -->
            <div class="tab-list grid w-full grid-cols-2 mb-6">
                <button class="tab-trigger active" data-tab="week">Weekly Calendar</button>
                <button class="tab-trigger" data-tab="settings">Settings & Presets</button>
                <!-- <button class="tab-trigger" data-tab="stats">Insights & Analytics</button> -->
            </div>

            <!-- week calender tab  -->
            <div class="tab-content active" id="week-tab">
                <div class="space-y-6">
                    <div class="shadow-md border border-slate-200 rounded-lg">
                        <!-- calender header  -->
                        <div
                            class="pb-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-t-lg p-4 border-b border-slate-200">
                            <div class="flex flex-col sm:flex-row gap-2 items-start sm:items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="bg-white p-2 rounded-full shadow-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="lucide lucide-calendar text-indigo-600">
                                            <rect width="18" height="18" x="3" y="4" rx="2" ry="2" />
                                            <line x1="16" x2="16" y1="2" y2="6" />
                                            <line x1="8" x2="8" y1="2" y2="6" />
                                            <line x1="3" x2="21" y1="10" y2="10" />
                                        </svg>
                                    </div>
                                    <h3 class="text-lg font-semibold text-indigo-900">Weekly Schedule</h3>
                                </div>

                                <div class="relative flex items-center gap-2 bg-white px-3 py-1.5 rounded-full shadow-sm">
                                    <a href="/d/edit-schedules/" id="reset-to-today"
                                        title="Redirect to today's Date slot"
                                    
                                    class="hidden w-6 h-6 text-xs font-medium text-red-500 absolute -top-2 bg-red-50 p-1 rounded-full" >
                                        <svg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>
                                            <g transform="matrix(2 0 0 2 12 12)" >
                                                <g style="" >
                                                    <g transform="matrix(1 0 0 1 0.25 0)" >
                                                        <path style="stroke: currentColor; stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-5.25, -5)" d="M 5.25 1 C 7.166096359608154 0.9996848994117354 8.813290162802168 2.3582058615158816 9.177665872420187 4.239337356343494 C 9.542041582038205 6.120468851171107 8.521242153349913 7.995780866849247 6.74361162156603 8.710941723623264 C 4.9659810897821455 9.426102580397284 2.930874936217567 8.780215923559776 1.8909847050437953 7.170851556580887 C 0.8510944738700239 5.561487189601997 1.0985364837583766 3.4407328234625414 2.4809999999999928 2.114000000000007" stroke-linecap="round" />
                                                    </g>
                                                    <g transform="matrix(1 0 0 1 -3.19 -2.11)" >
                                                     <path style="stroke: currentColor; stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-1.81, -2.89)" d="M 0.75 2.5 L 2.481 2.114 L 2.868 3.661" stroke-linecap="round" />
                                                    </g>
                                                    <g transform="matrix(1 0 0 1 0.75 -0.25)" >
                                                        <path style="stroke: currentColor; stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-5.75, -4.75)" d="M 5.25 3.5 L 5.25 5 L 6.25 6" stroke-linecap="round" />
                                                    </g>
                                                </g>
                                            </g>
                                        </svg>
                                    </a>


                                    <button id="prev-week"
                                        class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-indigo-50 text-indigo-700 h-8 w-8 p-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="lucide lucide-chevron-left">
                                            <path d="m15 18-6-6 6-6" />
                                        </svg>
                                    </button>
                                    <span id="week-range" class="text-sm font-medium text-indigo-900 px-2"></span>
                                    <button id="next-week"
                                        class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-indigo-50 text-indigo-700 h-8 w-8 p-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="lucide lucide-chevron-right">
                                            <path d="m9 18 6-6-6-6" />
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <div class="mt-2 flex flex-wrap items-center gap-2">
                                <span class="text-slate-600">Click or drag to manage your schedule:</span>
                                <div class="flex flex-wrap gap-1.5 mt-1">
                                    <span
                                        class="inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 bg-emerald-100 border-emerald-300 text-emerald-700 flex items-center gap-1">
                                        <div class="w-2 h-2 rounded-full bg-emerald-500"></div>Available
                                    </span>
                                    <span
                                        class="inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 bg-amber-100 border-amber-300 text-amber-700 flex items-center gap-1">
                                        <div class="w-2 h-2 rounded-full bg-amber-500"></div>Break
                                    </span>
                                    <span
                                        class="inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 bg-red-100 border-red-300 text-red-700 flex items-center gap-1">
                                        <div class="w-2 h-2 rounded-full bg-red-500"></div>Booked
                                    </span>
                                    <span
                                        class=" inline-flex  items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 bg-slate-100 border-slate-300 text-slate-700 flex items-center gap-1">
                                        <div class="w-2 h-2 rounded-full bg-slate-500"></div>Unavailable/Free
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- calender body  -->
                        <div class="p-4 relative overflow-x-auto">
                            <div id="schedule-grid" class="grid grid-cols-8 gap-1.5 min-w-[800px]">
                                <!-- Time column -->
                                <div class="text-center">

                                    <div class="h-16 mt-1 flex items-center flex-col justify-center pb-1">
                                        <span class="text-xs font-medium text-slate-500 mb-2">TIME</span>

                                        <div class="flex items-center ">
                                            <span class="mr-2 text-xs text-gray-500">12h</span>
                                            <div class="relative inline-block w-10 mr-2 align-middle select-none">
                                                <input type="checkbox" id="timeToggle" checked
                                                    class="absolute block w-5 h-5 bg-white border-4 rounded-full appearance-none cursor-pointer focus:outline-none transition-transform duration-200 ease-in translate-x-0 checked:translate-x-5 checked:border-blue-500 border-gray-300" />
                                                <label for="timeToggle"
                                                    class="block h-5 overflow-hidden bg-gray-300 rounded-full cursor-pointer"></label>
                                            </div>
                                            <span class="text-xs text-gray-500">24h</span>
                                        </div>
                                    </div>
                                    <div class="time-slots">
                                        <!-- Time slots will be generated by JavaScript -->
                                    </div>
                                </div>

                                <!-- Days columns will be generated by JavaScript -->
                            </div>
                        </div>

                        <!-- calender footer  -->
                        <div
                            class="flex justify-between items-center py-4 px-4 bg-gradient-to-r from-slate-50 to-blue-50 rounded-b-lg border-t border-slate-200">
                            <div class="text-sm text-slate-600 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" class="lucide lucide-info text-blue-500">
                                    <circle cx="12" cy="12" r="10" />
                                    <path d="M12 16v-4" />
                                    <path d="M12 8h.01" />
                                </svg>
                                <span>Drag to select multiple slots at once</span>
                            </div>
                            <div class="text-sm bg-white px-3 py-1.5 rounded-full shadow-sm text-slate-700">
                                <span class="font-medium">Weekly Hours:</span> <span id="footer-weekly-hours">0h</span>
                            </div>
                        </div>
                    </div>

                    <div id="schedule-warnings"
                        class="border-amber-300 bg-gradient-to-r from-amber-50 to-amber-100 shadow-md rounded-lg hidden">
                        <div class="pb-2 p-4 border-b border-amber-200">
                            <h3 class="text-lg font-semibold text-amber-800 flex items-center gap-2">
                                <div class="bg-white p-1.5 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="lucide lucide-info text-amber-500">
                                        <circle cx="12" cy="12" r="10" />
                                        <path d="M12 16v-4" />
                                        <path d="M12 8h.01" />
                                    </svg>
                                </div>
                                Scheduling Warnings
                            </h3>
                        </div>
                        <div class="p-4" id="warning-content">
                            <!-- Warning content will be generated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- setting tab -->
            <div class="tab-content" id="settings-tab">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="border rounded-lg shadow-sm bg-white">
                        <div class="p-4 border-b">
                            <h3 class="text-lg font-semibold">Quick Presets</h3>
                            <p class="text-sm text-gray-500">Apply predefined schedules to your week</p>
                        </div>
                        <div class="p-4 grid grid-cols-1 gap-4">
                            <button
                                class="preset-button inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2 justify-start"
                                data-preset="full-day">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" class="lucide lucide-clock mr-2">
                                    <circle cx="12" cy="12" r="10" />
                                    <polyline points="12 6 12 12 16 14" />
                                </svg>
                                Full Day (9 AM - 6 PM)
                            </button>
                            <button
                                class="preset-button inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2 justify-start"
                                data-preset="morning">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" class="lucide lucide-alarm-check mr-2">
                                    <circle cx="12" cy="13" r="8" />
                                    <path d="M5 3 2 6" />
                                    <path d="m22 6-3-3" />
                                    <path d="m6 19-2 2" />
                                    <path d="m18 19 2 2" />
                                    <path d="m9 13 2 2 4-4" />
                                </svg>
                                Morning Shift (8 AM - 12 PM)
                            </button>
                            <button
                                class="preset-button inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2 justify-start"
                                data-preset="evening">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" class="lucide lucide-moon mr-2">
                                    <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />
                                </svg>
                                Evening Shift (3 PM - 9 PM)
                            </button>
                            <button id="custom-template-btn"
                                class="inline-flex hidden items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2 justify-start">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" class="lucide lucide-plus mr-2">
                                    <path d="M5 12h14" />
                                    <path d="M12 5v14" />
                                </svg>
                                Create Custom Template
                            </button>
                        </div>
                    </div>

                    <div class="border rounded-lg shadow-sm bg-white">
                        <div class="p-4 border-b">
                            <h3 class="text-lg font-semibold">Break Settings</h3>
                            <p class="text-sm text-gray-500">Configure your regular breaks</p>
                        </div>
                        <div class="p-4 space-y-4">
                            <div class="flex items-center justify-between">
                                <div class="space-y-0.5">
                                    <label for="lunch-break"
                                        class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Lunch
                                        Break</label>
                                    <div class="text-sm text-muted-foreground">
                                        Set a daily lunch break
                                    </div>
                                </div>
                                <div class="switch-container">
                                    <input type="checkbox" id="lunch-break" class="switch-input" checked>
                                    <label for="lunch-break" class="switch"></label>
                                </div>
                            </div>

                            <div id="lunch-time-container">
                                <label for="lunch-time"
                                    class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Lunch
                                    Time</label>
                                <select id="lunch-time" class="select-input">
                                    <option value="11">11:00 AM</option>
                                    <option value="12" selected>12:00 PM</option>
                                    <option value="13">1:00 PM</option>
                                    <option value="14">2:00 PM</option>
                                </select>
                            </div>

                            <div class="flex items-center justify-between">
                                <div class="space-y-0.5">
                                    <label for="evening-break"
                                        class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Evening
                                        Break</label>
                                    <div class="text-sm text-muted-foreground">
                                        Set a daily evening break
                                    </div>
                                </div>
                                <div class="switch-container">
                                    <input type="checkbox" id="evening-break" class="switch-input">
                                    <label for="evening-break" class="switch"></label>
                                </div>
                            </div>

                            <div id="evening-time-container" class="hidden">
                                <label for="evening-time"
                                    class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Evening
                                    Break Time</label>
                                <select id="evening-time" class="select-input">
                                    <option value="15" selected>3:00 PM</option>
                                    <option value="16">4:00 PM</option>
                                    <option value="17">5:00 PM</option>
                                </select>
                            </div>

                            <button id="apply-breaks"
                                class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">Apply
                                Break Settings</button>
                        </div>
                    </div>

                    <!-- <div class="border rounded-lg shadow-sm bg-white">
                        <div class="p-4 border-b">
                            <h3 class="text-lg font-semibold">Appointment Settings</h3>
                            <p class="text-sm text-gray-500">Configure appointment duration and constraints</p>
                        </div>
                        <div class="p-4 space-y-4">
                            <div>
                                <label for="slot-duration"
                                    class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Default
                                    Appointment Duration</label>
                                <select id="slot-duration" class="select-input">
                                    <option value="15">15 minutes</option>
                                    <option value="30" selected>30 minutes</option>
                                    <option value="45">45 minutes</option>
                                    <option value="60">60 minutes</option>
                                </select>
                            </div>

                            <div class="flex items-center justify-between">
                                <div class="space-y-0.5">
                                    <label for="emergency-slots"
                                        class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Emergency
                                        Slots</label>
                                    <div class="text-sm text-muted-foreground">
                                        Reserve slots for emergency appointments
                                    </div>
                                </div>
                                <div class="switch-container">
                                    <input type="checkbox" id="emergency-slots" class="switch-input">
                                    <label for="emergency-slots" class="switch"></label>
                                </div>
                            </div>

                            <div class="flex items-center justify-between">
                                <div class="space-y-0.5">
                                    <label for="auto-fill"
                                        class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Auto-fill
                                        Gaps</label>
                                    <div class="text-sm text-muted-foreground">
                                        Automatically fill gaps between appointments
                                    </div>
                                </div>
                                <div class="switch-container">
                                    <input type="checkbox" id="auto-fill" class="switch-input">
                                    <label for="auto-fill" class="switch"></label>
                                </div>
                            </div>
                        </div>
                    </div> -->

                    <!-- <div class="border rounded-lg shadow-sm bg-white">
                        <div class="p-4 border-b">
                            <h3 class="text-lg font-semibold">Working Hour Constraints</h3>
                            <p class="text-sm text-gray-500">Set minimum and maximum working hours</p>
                        </div>
                        <div class="p-4 space-y-4">
                            <div>
                                <label for="min-hours"
                                    class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Minimum
                                    Hours Per Day</label>
                                <select id="min-hours" class="select-input">
                                    <option value="4">4 hours</option>
                                    <option value="5">5 hours</option>
                                    <option value="6" selected>6 hours</option>
                                    <option value="7">7 hours</option>
                                    <option value="8">8 hours</option>
                                </select>
                            </div>

                            <div>
                                <label for="max-hours"
                                    class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Maximum
                                    Hours Per Day</label>
                                <select id="max-hours" class="select-input">
                                    <option value="8">8 hours</option>
                                    <option value="9">9 hours</option>
                                    <option value="10" selected>10 hours</option>
                                    <option value="11">11 hours</option>
                                    <option value="12">12 hours</option>
                                </select>
                            </div>

                            <div class="border p-3 rounded-md bg-amber-50 border-amber-200">
                                <p class="text-sm text-amber-800">
                                    <span class="font-medium">Note:</span> These limits are for guidance only. You will
                                    receive a warning when they are exceeded but can still save your schedule.
                                </p>
                            </div>
                        </div>
                    </div> -->
                </div>
            </div>

            <div class="tab-content" id="stats-tab">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="border rounded-lg shadow-sm bg-white">
                        <div class="p-4 border-b">
                            <h3 class="text-lg font-semibold">Weekly Summary</h3>
                        </div>
                        <div class="p-4">
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm">Total Working Hours</span>
                                    <span id="stats-total-hours" class="font-medium">0 hours</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm">Average Per Day</span>
                                    <span id="stats-avg-hours" class="font-medium">0 hours</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm">Working Days</span>
                                    <span id="stats-working-days" class="font-medium">0 days</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm">Scheduled Breaks</span>
                                    <span id="stats-breaks" class="font-medium">0 slots</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="border rounded-lg shadow-sm bg-white">
                        <div class="p-4 border-b">
                            <h3 class="text-lg font-semibold">Workload Distribution</h3>
                        </div>
                        <div class="p-4">
                            <div id="workload-stats" class="space-y-3">
                                <!-- Workload stats will be generated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <div class="border rounded-lg shadow-sm bg-white">
                        <div class="p-4 border-b">
                            <h3 class="text-lg font-semibold">Recommendations</h3>
                        </div>
                        <div class="p-4">
                            <div id="recommendations" class="space-y-3">
                                <!-- Recommendations will be generated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="border rounded-lg shadow-sm bg-white mt-6">
                    <div class="p-4 border-b">
                        <h3 class="text-lg font-semibold">Patient Booking Patterns</h3>
                        <p class="text-sm text-gray-500">Historical analysis of appointment bookings</p>
                    </div>
                    <div class="p-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h3 class="text-sm font-medium mb-4">Peak Booking Times</h3>
                                <div class="space-y-4">
                                    <div>
                                        <div class="flex justify-between mb-1">
                                            <span class="text-sm">Morning (8 AM - 12 PM)</span>
                                            <span class="text-sm font-medium">42%</span>
                                        </div>
                                        <div class="w-full bg-gray-100 rounded-full h-2">
                                            <div class="bg-blue-500 h-2 rounded-full" style="width: 42%"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex justify-between mb-1">
                                            <span class="text-sm">Afternoon (12 PM - 4 PM)</span>
                                            <span class="text-sm font-medium">35%</span>
                                        </div>
                                        <div class="w-full bg-gray-100 rounded-full h-2">
                                            <div class="bg-blue-500 h-2 rounded-full" style="width: 35%"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex justify-between mb-1">
                                            <span class="text-sm">Evening (4 PM - 8 PM)</span>
                                            <span class="text-sm font-medium">23%</span>
                                        </div>
                                        <div class="w-full bg-gray-100 rounded-full h-2">
                                            <div class="bg-blue-500 h-2 rounded-full" style="width: 23%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h3 class="text-sm font-medium mb-4">No-Show Analysis</h3>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm">Monday morning</span>
                                        <span
                                            class="inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 bg-red-100 text-red-800 border-red-200">High
                                            (12%)</span>
                                    </div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm">Friday evening</span>
                                        <span
                                            class="inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 bg-red-100 text-red-800 border-red-200">High
                                            (15%)</span>
                                    </div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm">Wednesday afternoon</span>
                                        <span
                                            class="inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 bg-emerald-50 text-emerald-700 border-emerald-200">Low
                                            (3%)</span>
                                    </div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm">Overall no-show rate</span>
                                        <span class="font-medium">7%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Template Dialog -->
    <div id="custom-template-dialog" class="dialog-overlay hidden">
        <div class="dialog-content">
            <div class="dialog-header">
                <h3 class="text-lg font-semibold">Create Custom Template</h3>
                <p class="text-sm text-gray-500">Design a template schedule that you can apply anytime</p>
            </div>
            <div class="dialog-body">
                <div class="grid gap-4 py-4">
                    <div>
                        <label for="template-name" class="text-sm font-medium">Template Name</label>
                        <input type="text" id="template-name" placeholder="e.g., Summer Hours" class="text-input">
                    </div>
                    <div>
                        <label class="text-sm font-medium">Working Hours</label>
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <div>
                                <label for="start-time" class="text-xs font-medium">Start Time</label>
                                <select id="start-time" class="select-input">
                                    <option value="8">8:00 AM</option>
                                    <option value="9" selected>9:00 AM</option>
                                    <option value="10">10:00 AM</option>
                                    <option value="11">11:00 AM</option>
                                    <option value="12">12:00 PM</option>
                                    <option value="13">1:00 PM</option>
                                    <option value="14">2:00 PM</option>
                                </select>
                            </div>
                            <div>
                                <label for="end-time" class="text-xs font-medium">End Time</label>
                                <select id="end-time" class="select-input">
                                    <option value="14">2:00 PM</option>
                                    <option value="15">3:00 PM</option>
                                    <option value="16">4:00 PM</option>
                                    <option value="17" selected>5:00 PM</option>
                                    <option value="18">6:00 PM</option>
                                    <option value="19">7:00 PM</option>
                                    <option value="20">8:00 PM</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-medium">Apply to Days</label>
                        <div class="grid grid-cols-7 gap-1 mt-2">
                            <button
                                class="day-select inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-8"
                                data-day="Monday">M</button>
                            <button
                                class="day-select inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-8"
                                data-day="Tuesday">T</button>
                            <button
                                class="day-select inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-8"
                                data-day="Wednesday">W</button>
                            <button
                                class="day-select inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-8"
                                data-day="Thursday">T</button>
                            <button
                                class="day-select inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-8"
                                data-day="Friday">F</button>
                            <button
                                class="day-select inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-8"
                                data-day="Saturday">S</button>
                            <button
                                class="day-select inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-8"
                                data-day="Sunday">S</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="dialog-footer">
                <button id="cancel-template"
                    class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">Cancel</button>
                <button id="save-template"
                    class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">Save
                    Template</button>
            </div>
        </div>
    </div>

    <!-- Day Actions Menu -->
    <div id="day-actions-menu" class="dropdown-menu hidden">
        <div class="dropdown-header flex justify-between"><span>Day Actions</span>
            <span id="close_day-actions-menu" class="text-red-500 cursor-pointer">X</span>
        </div>
        <div class="dropdown-divider"></div>
        <button id="clear-day" class="dropdown-item text-red-600">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="lucide lucide-trash-2 mr-2">
                <path d="M3 6h18" />
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
                <line x1="10" x2="10" y1="11" y2="17" />
                <line x1="14" x2="14" y1="11" y2="17" />
            </svg>
            Clear All Slots
        </button>
        <div class="dropdown-divider"></div>
        <div class="dropdown-header flex justify-between">Copy Schedule From Date:</div>
        <div id="copy-day-options" class="max-h-40 overflow-y-auto custom-scrollbar">
            <!-- Copy options will be generated by JavaScript -->
        </div>
    </div>

    <!-- Tooltip -->
    <div id="tooltip" class="tooltip-box hidden">
        <div id="tooltip-content"></div>
    </div>
</main>









{% endblock content %}


{% block scripts %}
<script>

    function requestScheduleData(date = null ) {

        url = date ? `/d/get-dateTime-slots/${date}/` : '/d/get-dateTime-slots/';

        let todaysDate = new Date();
        if (date) {
            const reset_to_today_btn = document.getElementById("reset-to-today");
            let selectedDate = new Date(date);
            if (selectedDate != todaysDate) {
                reset_to_today_btn.classList.remove("hidden");
            }
        }

        return fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.success) {
                    // Initialize the schedule display
                    displayDate_Time(data.scheduleData)
                    
                } else if (data.message) {
                    showNotification({
                        color: "bg-red-500",
                        title: "Error fetching data",
                        message: "Error: " + data.message,
                    });
                } else if (data.error){
                        showNotification({
                            color: "bg-red-500",
                            title: "Error fetching data",
                            message:"Error: " + data.error,
                        });
                }
    
            } else {
                throw new Error(data.error || "Error fetching schedule data");
            }
        })
        .catch(error => {
            showNotification({
                color: "bg-red-500",
                title: "Error fetching data",
                message: "Please try again. Error: " + error,
            });
        });
    }


    document.addEventListener("DOMContentLoaded", () => {

    const urlParams = new URLSearchParams(window.location.search);
    const dateParam = urlParams.get('date');
    if (dateParam) {
        requestScheduleData(dateParam);
    } else {
        requestScheduleData();
    }
  
    });



    function displayDate_Time(scheduleDatas, ) {
        // Constants
        const DAYS = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        const HOURS = Array.from({ length: 14 }, (_, i) => i + 8); // 8 AM to 9 PM


        let scheduleData = scheduleDatas

        // State
        let currentWeekStart = new Date(Object.keys(scheduleData)[0]);
        let isDragging = false;
        let dragStatus = null;
        let dragOccurred = false;
        const workHourLimits = { min: 6, max: 10 };
        const breakSettings = {
            lunchBreak: true,
            lunchTime: "12",
            eveningBreak: false,
            eveningTime: "15",
        }
        let selectedDate = null;

        // Helper Functions
        function getDateString(date) {
            return date.toISOString().split("T")[0]; // e.g., "2023-10-01" from "2023-10-01T07:00:00.000Z"
        }

        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function formatDate(date, format) {
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const d = date.getDate();
            const m = months[date.getMonth()];
            const y = date.getFullYear();
            return format.replace("MMM", m).replace("d", d).replace("yyyy", y);
        }

        // Render time slots in the first column
        function renderTimeSlots(defaultTimeformat = "24") {
            const timeColumn = document.querySelector(".time-slots");
            timeColumn.innerHTML = "";
            HOURS.forEach((hour) => {
                const timeSlot = document.createElement("div");
                timeSlot.className = "h-14 flex items-center justify-center";

                let updated_hrs = defaultTimeformat === "12" ? (parseInt(hour, 10) % 12 || 12) : parseInt(hour, 10);

                timeSlot.innerHTML = `
                <div class="text-sm font-medium text-slate-600">
                    ${updated_hrs}:00
                    <span class="text-xs text-slate-400 ml-0.5">${hour < 12 ? "AM" : "PM"}</span>
                </div>
            `;
                timeColumn.appendChild(timeSlot);
            });
        }

        // Render day columns for the current week
        function renderDayColumns() {
            const scheduleGrid = document.getElementById("schedule-grid");
            const existingColumns = scheduleGrid.querySelectorAll(".day-column");
            existingColumns.forEach((col) => col.remove()); // Remove existing columns

            // Generate whole dates Object for the current week
            const dates = Array.from({ length: 7 }, (_, i) => addDays(currentWeekStart, i));

            dates.forEach((date) => {
                const dateString = getDateString(date);
                const schedule = scheduleData[dateString] || [];
                const dayName = DAYS[date.getDay()];
                const isToday = date.toDateString() === new Date().toDateString();

                const dayColumn = document.createElement("div");
                dayColumn.className = "day-column text-center";
                dayColumn.dataset.date = dateString;

                const dayHeader = document.createElement("div");
                dayHeader.className = `day-header ${isToday ? "today" : ""}`;
                dayHeader.innerHTML = `
                <span class="text-sm font-bold ${isToday ? "text-indigo-700" : "text-slate-700"}">
                    ${dayName.slice(0, 3)} ${date.getDate()}
                </span>
                ${isToday ? `<span class="text-xs bg-indigo-600 text-white px-1.5 py-0.5 rounded-full mt-0.5">Today</span>` : ""}
                <div class="day-actions">
                    <button class="day-menu-button inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors hover:bg-slate-200/70 rounded-full h-6 w-6 p-0" data-date="${dateString}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-more-horizontal text-slate-500"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
                    </button>
                </div>
            `;
                dayColumn.appendChild(dayHeader);

                schedule.forEach((slot, hourIndex) => {
                    const timeSlot = document.createElement("div");
                    timeSlot.className = `schedule-slot ${slot.status}`;
                    timeSlot.dataset.date = dateString;
                    timeSlot.dataset.hour = hourIndex;

                    let slotContent = "";
                    if (slot.status === "booked") {
                        slotContent = `
                        <div class="flex flex-col items-center justify-center h-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user text-red-500"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            <span class="text-xs mt-1 text-red-600 font-medium">Booked</span>
                        </div>
                    `;
                    } else if (slot.status === "break") {
                        slotContent = `
                        <div class="flex flex-col items-center justify-center h-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-coffee text-amber-500"><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="2" y2="4"/><line x1="10" x2="10" y1="2" y2="4"/><line x1="14" x2="14" y1="2" y2="4"/></svg>
                            <span class="text-xs mt-1 text-amber-600 font-medium">Break</span>
                        </div>
                    `;
                    } else if (slot.status === "available") {
                        slotContent = `
                        <div class="flex flex-col items-center justify-center h-full">
                            <div class="w-2 h-2 rounded-full bg-emerald-500 mb-1"></div>
                            <span class="text-xs text-emerald-600 font-medium">Available</span>
                        </div>
                    `;
                    } else {
                        slotContent = `
                        <div class="flex flex-col items-center justify-center h-full">
                            <span class="text-xs text-slate-400">Free</span>
                        </div>
                    `;
                    }
                    timeSlot.innerHTML = slotContent;
                    dayColumn.appendChild(timeSlot);
                });

                const workingHours = calculateWorkingHours(dateString);
                if (workingHours > workHourLimits.max) {
                    const warning = document.createElement("div");
                    warning.className = "mt-2 text-xs font-medium px-2 py-1 bg-red-100 text-red-600 rounded-full inline-block";
                    warning.textContent = "Exceeds max hours";
                    dayColumn.appendChild(warning);
                } else if (workingHours > 0 && workingHours < workHourLimits.min) {
                    const warning = document.createElement("div");
                    warning.className = "mt-2 text-xs font-medium px-2 py-1 bg-amber-100 text-amber-600 rounded-full inline-block";
                    warning.textContent = "Below min hours";
                    dayColumn.appendChild(warning);
                }

                scheduleGrid.appendChild(dayColumn);
            });
        }

        // Update the week range display
        function updateWeekRange() {
            const weekRangeElement = document.getElementById("week-range");
            const endOfWeek = addDays(currentWeekStart, 6);
            weekRangeElement.textContent = `${formatDate(currentWeekStart, "MMM d")} - ${formatDate(endOfWeek, "MMM d, yyyy")}`;


            // on previous and next week button click
            const prevWeekButton = document.getElementById("prev-week");
            const nextWeekButton = document.getElementById("next-week");

            prevWeekButton.addEventListener("click", () => {
                window.location.href = `/d/edit-schedules/?date=${getDateString(addDays(currentWeekStart, -7))}`;
            });

            nextWeekButton.addEventListener("click", () => {
                window.location.href = `/d/edit-schedules/?date=${getDateString(addDays(currentWeekStart, 7))}`;

            });

        }

        // Calculate working hours for a date
        function calculateWorkingHours(dateString) {
            const schedule = scheduleData[dateString] || [];
            return schedule.filter((slot) => slot.status === "available" || slot.status === "booked").length; // 30-min slots, so divide by 2 for hours
        }

        // Calculate total weekly hours
        function calculateTotalWeeklyHours() {
            const dates = Array.from({ length: 7 }, (_, i) => addDays(currentWeekStart, i));
            return dates.reduce((total, date) => total + calculateWorkingHours(getDateString(date)), 0);
        }

        // Update statistics
        function updateStats() {
            const totalWeeklyHours = calculateTotalWeeklyHours();
            document.getElementById("total-weekly-hours").textContent = `${totalWeeklyHours}h`;
            document.getElementById("footer-weekly-hours").textContent = `${totalWeeklyHours}h`;

            const workingDays = Array.from({ length: 7 }, (_, i) => addDays(currentWeekStart, i)).filter(
                (date) => calculateWorkingHours(getDateString(date)) >= 0
            ).length;
            document.getElementById("stats-working-days").textContent = `${workingDays} days`;

            const avgHoursPerDay = workingDays > 0 ? (totalWeeklyHours / workingDays).toFixed(1) : "0.0";
            document.getElementById("stats-avg-hours").textContent = `${avgHoursPerDay} hours`;

            const totalBreaks = Array.from({ length: 7 }, (_, i) => addDays(currentWeekStart, i)).reduce(
                (total, date) => total + (scheduleData[getDateString(date)] || []).filter((slot) => slot.status === "break").length,
                0
            );
            document.getElementById("stats-breaks").textContent = `${totalBreaks} slots`;

            const workloadStats = document.getElementById("workload-stats");
            workloadStats.innerHTML = "";
            const dates = Array.from({ length: 7 }, (_, i) => addDays(currentWeekStart, i));
            dates.forEach((date) => {
                const dateString = getDateString(date);
                const hours = calculateWorkingHours(dateString);
                const barColor =
                    hours > workHourLimits.max
                        ? "bg-red-400"
                        : hours < workHourLimits.min && hours >= 0
                            ? "bg-amber-400"
                            : "bg-emerald-400";
                const dayStats = document.createElement("div");
                dayStats.className = "space-y-1";
                dayStats.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="text-sm">${DAYS[date.getDay()]} ${date.getDate()}</span>
                    <span class="text-sm font-medium">${hours} hrs</span>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-2">
                    <div class="h-2 rounded-full ${barColor}" style="width: ${(hours / 12) * 100}%"></div>
                </div>
            `;
                workloadStats.appendChild(dayStats);
            });
        }

        // Set up event listeners
        function setupEventListeners() {

            // Tab switching
            const tabTriggers = document.querySelectorAll(".tab-trigger")
            tabTriggers.forEach((trigger) => {
                trigger.addEventListener("click", () => {
                    const tabId = trigger.dataset.tab

                    // Update active tab trigger
                    tabTriggers.forEach((t) => t.classList.remove("active"))
                    trigger.classList.add("active")

                    // Update active tab content
                    const tabContents = document.querySelectorAll(".tab-content")
                    tabContents.forEach((content) => content.classList.remove("active"))
                    document.getElementById(`${tabId}-tab`).classList.add("active")
                })
            })


            // status slots drag drop logic 
            document.addEventListener("mousedown", (event) => {
                const slot = event.target.closest(".schedule-slot");
                if (slot) {
                    startSlot = slot; // Store the starting slot
                    const dateString = slot.dataset.date;
                    const hourIndex = Number.parseInt(slot.dataset.hour);
                    handleDragStart(dateString, hourIndex);
                }
            });

            document.addEventListener("mousemove", (event) => {
                if (isDragging) {
                    dragOccurred = true;
                    const slot = event.target.closest(".schedule-slot");
                    if (slot) {
                        const dateString = slot.dataset.date;
                        const hourIndex = Number.parseInt(slot.dataset.hour);
                        handleDragOver(dateString, hourIndex);
                    }
                    // Update ghost position
                    const ghost = document.querySelector(".drag-ghost");
                    if (ghost) {
                        ghost.style.left = `${event.pageX + 10}px`;
                        ghost.style.top = `${event.pageY + 10}px`;
                    }
                }
            });

            document.addEventListener("mouseup", (event) => {
                if (isDragging) {
                    if (!dragOccurred && startSlot) {
                        // No drag occurred, treat it as a click
                        const dateString = startSlot.dataset.date;
                        const hourIndex = Number.parseInt(startSlot.dataset.hour);
                        handleSlotClick(dateString, hourIndex);
                    }
                    handleDragEnd();
                }
            });

            document.addEventListener("click", (event) => {
                const menuButton = event.target.closest(".day-menu-button");
                if (menuButton) {
                    const dateString = menuButton.dataset.date;
                    showDayMenu(dateString, menuButton);
                    event.stopPropagation();
                }
            });


            // Tool tip logic
            document.addEventListener("mouseover", (event) => {
                const slot = event.target.closest(".schedule-slot")
                // Show tooltip
                if (slot) {
                    showTooltip(slot, event)
                }
            })

            document.addEventListener("mouseout", (event) => {
                const slot = event.target.closest(".schedule-slot")
                if (slot) {
                    hideTooltip()
                }
            })


            document.getElementById('timeToggle').addEventListener('click', () => {
                renderTimeSlots(document.getElementById('timeToggle').checked ? "24" : "12")
            })

            document.getElementById("clear-day").addEventListener("click", () => {
                if (selectedDate) {
                    clearDay(selectedDate);
                    hideDayMenu();
                }
            });



            // Preset buttons for predefined schedules to week
            const presetButtons = document.querySelectorAll(".preset-button")
            presetButtons.forEach((button) => {
                button.addEventListener("click", () => {
                    presetButtons.forEach((btn) => btn.classList.remove("bg-blue-400", "hover:bg-blue-500"));
                    button.classList.add('bg-blue-400', "hover:bg-blue-500");
                    applyPreset(button)
                })
            })



            // Break settings
            document.getElementById("lunch-break").addEventListener("change", (event) => {
                breakSettings.lunchBreak = event.target.checked
                document.getElementById("lunch-time-container").style.display = event.target.checked ? "block" : "none"
            })

            document.getElementById("evening-break").addEventListener("change", (event) => {
                breakSettings.eveningBreak = event.target.checked
                document.getElementById("evening-time-container").style.display = event.target.checked ? "block" : "none"
            })

            document.getElementById("lunch-time").addEventListener("change", (event) => {
                breakSettings.lunchTime = event.target.value
            })

            document.getElementById("evening-time").addEventListener("change", (event) => {
                breakSettings.eveningTime = event.target.value
            })
            document.getElementById("apply-breaks").addEventListener("click", applyBreakSettings)


            // Custom template dialog
            document.getElementById("custom-template-btn").addEventListener("click", showCustomTemplateDialog)
            document.getElementById("cancel-template").addEventListener("click", hideCustomTemplateDialog)
            document.getElementById("save-template").addEventListener("click", saveCustomTemplate)


            // Day selection in custom template
            const daySelectButtons = document.querySelectorAll(".day-select")
            daySelectButtons.forEach((button) => {
                button.addEventListener("click", () => {
                    button.classList.toggle("day-selected")
                })
            })


            document.getElementById("save-button").addEventListener("click", saveSchedule);
        }

        // Handle slot click (called from mouseup if no drag)
        function handleSlotClick(dateString, hourIndex) {
            const currentStatus = scheduleData[dateString][hourIndex].status;
            if (currentStatus === "booked") return;
            const newStatus = currentStatus === "available" ? "break" :
                currentStatus === "break" ? "unavailable" : "available";
            scheduleData[dateString][hourIndex].status = newStatus;
            renderDayColumns();
            updateStats();
        }

        // Handle drag start
        function handleDragStart(dateString, hourIndex) {
            const status = scheduleData[dateString][hourIndex].status;
            if (status === "booked") return;
            isDragging = true;
            dragOccurred = false; // Reset at the start
            dragStatus = status;
            document.body.classList.add("dragging");

            // Create ghost element
            const ghost = document.createElement("div");
            ghost.className = "drag-ghost";
            ghost.innerHTML = getStatusIcon(dragStatus);
            document.body.appendChild(ghost);
        }

        // Handle drag over
        function handleDragOver(dateString, hourIndex) {
            if (!isDragging || scheduleData[dateString][hourIndex].status === "booked") return;
            scheduleData[dateString][hourIndex].status = dragStatus;

            renderDayColumns();
            updateStats();
        }

        // Handle drag end
        function handleDragEnd() {
            isDragging = false;
            dragStatus = null;
            dragOccurred = false;
            document.body.classList.remove("dragging");

            // Remove ghost element
            const ghost = document.querySelector(".drag-ghost");
            if (ghost) {
                ghost.remove();
            }
        }

        // Helper function for status icons
        function getStatusIcon(status) {
            switch (status) {
                case "available":
                    return '<div class="w-2 h-2 rounded-full bg-emerald-500"></div>';
                case "break":
                    return '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-coffee text-amber-500"><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="2" y2="4"/><line x1="10" x2="10" y1="2" y2="4"/><line x1="14" x2="14" y1="2" y2="4"/></svg>';
                case "unavailable":
                    return '<span class="text-xs text-slate-400">Free</span>';
                default:
                    return '';
            }
        }


        // Show day menu
        function showDayMenu(dateString, button) {
            selectedDate = dateString;
            const menu = document.getElementById("day-actions-menu");
            menu.classList.remove("hidden");
            const rect = button.getBoundingClientRect();
            menu.style.top = `${rect.bottom + window.scrollY}px`;
            menu.style.left = `${rect.left + window.scrollX}px`;

            // Generate copy options
            const copyOptions = document.getElementById("copy-day-options")
            copyOptions.innerHTML = ""

            Object.keys(scheduleData).forEach((date) => {
                if (date !== selectedDate) {
                    let clickedDate = date;
                    const copyOption = document.createElement("button");
                    copyOption.className = "dropdown-item";
                    copyOption.textContent = "Copy From " + formatDate(new Date(date), "MMM d");



                    copyOption.addEventListener("click", () => {
                        scheduleData[selectedDate] = scheduleData[clickedDate].map((slot, index) => {
                            const existingStatus = scheduleData[selectedDate]?.[index]?.status;
                            if (existingStatus === "booked") {
                                return { ...slot, status: "booked" };
                            }
                            // Otherwise copy from the source date, preserving booked status
                            return {
                                ...slot,
                                status: slot.status === "booked" ? "available" : slot.status
                            };
                        });

                        renderDayColumns();
                        updateStats();
                        hideDayMenu();
                    });
                    copyOptions.appendChild(copyOption);


                    close_day_actions_menu = document.getElementById("close_day-actions-menu");
                    close_day_actions_menu.addEventListener("click", () => {
                        hideDayMenu();
                    });
                }
            });
        }

        // Hide day menu
        function hideDayMenu() {
            document.getElementById("day-actions-menu").classList.add("hidden");
            selectedDate = null;
        }


        // Show tooltip
        function showTooltip(slot, event) {
            const tooltip = document.getElementById("tooltip")
            const tooltipContent = document.getElementById("tooltip-content")

            const date = slot.dataset.date
            const hourIndex = Number.parseInt(slot.dataset.hour)
            const status = scheduleData[date][hourIndex].status

            tooltipContent.innerHTML = `
                <div class="text-xs">
                    <div class="font-medium">${date}, ${hourIndex + 8}:00 ${hourIndex + 8 < 12 ? "AM" : "PM"}</div>
                    <div class="capitalize">${status}</div>
                    ${status !== "booked" ? '<div class="mt-1 text-slate-300">Click to change status</div>' : ""}
                </div>
                `

            tooltip.classList.remove("hidden")

            // Position the tooltip
            const rect = slot.getBoundingClientRect()
            tooltip.style.top = `${rect.top + window.scrollY - 5}px`
            tooltip.style.left = `${rect.right + window.scrollX + 10}px`
        }

        // Hide tooltip
        function hideTooltip() {
            document.getElementById("tooltip").classList.add("hidden")
        }

        // Apply preset
        function applyPreset(button) {
            let preset = button.dataset.preset
            Object.keys(scheduleData)
                .forEach((date) => {
                    scheduleData[date] = scheduleData[date].map((slot, index) => {
                        if (slot.status === "booked") return slot // Don't modify booked slots

                        let newStatus = "unavailable"

                        if (preset === "full-day" && index >= 1 && index <= 10) {
                            // 9 AM to 6 PM
                            newStatus = "available"
                        } else if (preset === "morning" && index >= 0 && index <= 4) {
                            // 8 AM to 12 PM
                            newStatus = "available"
                        } else if (preset === "evening" && index >= 7 && index <= 13) {
                            // 3 PM to 9 PM
                            newStatus = "available"
                        }

                        return {
                            ...slot,
                            status: newStatus,
                        }
                    })
                })

            renderDayColumns()
            updateStats()
        }

        // Apply break settings
        function applyBreakSettings() {
            Object.keys(scheduleData)
                .forEach((date) => {
                    // Apply lunch break
                    if (breakSettings.lunchBreak) {
                        const lunchHour = Number.parseInt(breakSettings.lunchTime) - 8 // Convert to array index
                        if (lunchHour >= 0 && lunchHour < scheduleData[date].length) {
                            scheduleData[date][lunchHour].status = "break"
                        }
                    }

                    // Apply evening break
                    if (breakSettings.eveningBreak) {
                        const eveningHour = Number.parseInt(breakSettings.eveningTime) - 8 // Convert to array index
                        if (eveningHour >= 0 && eveningHour < scheduleData[date].length) {
                            scheduleData[date][eveningHour].status = "break"
                        }
                    }
                })

            renderDayColumns()
            updateStats()
        }

        // Show custom template dialog
        function showCustomTemplateDialog() {
            document.getElementById("custom-template-dialog").classList.remove("hidden")
            document.getElementById("custom-template-dialog").classList.add("flex")
        }

        // Hide custom template dialog
        function hideCustomTemplateDialog() {
            document.getElementById("custom-template-dialog").classList.remove("flex")
            document.getElementById("custom-template-dialog").classList.add("hidden")
        }

        // Helper functions
        function getStartOfWeek(date) {
            const day = date.getDay()
            const diff = date.getDate() - day + (day === 0 ? -6 : 1) // Adjust when day is Sunday
            return new Date(date.setDate(diff))
        }

        function addDays(date, days) {
            const result = new Date(date)
            result.setDate(result.getDate() + days)
            return result
        }

        // Save custom template
        function saveCustomTemplate() {
            const templateName = document.getElementById("template-name").value
            const startTime = Number.parseInt(document.getElementById("start-time").value)
            const endTime = Number.parseInt(document.getElementById("end-time").value)

            const selectedDays = []
            document.querySelectorAll(".day-select.day-selected").forEach((button) => {
                selectedDays.push(button.dataset.day)
            })

            if (templateName && selectedDays.length > 0) {
                Object.keys(scheduleData)
                    .forEach((date) => {
                        scheduleData[date] = scheduleData[date].map((slot, index) => {
                            if (slot.status === "booked") return slot // Don't modify booked slots

                            const hour = index + 8
                            const newStatus = hour >= startTime && hour < endTime ? "available" : "unavailable"

                            return {
                                ...slot,
                                status: newStatus,
                            }
                        })
                    })

                renderDayColumns()
                updateStats()
                hideCustomTemplateDialog()

                // Reset form
                document.getElementById("template-name").value = ""
                document.querySelectorAll(".day-select").forEach((button) => {
                    button.classList.remove("day-selected")
                })
            } else {
                alert("Please enter a template name and select at least one day.")
            }
        }

        // Clear day
        function clearDay(dateString) {
            if (scheduleData[dateString]) {
                scheduleData[dateString] = scheduleData[dateString].map((slot) => ({
                    ...slot,
                    status: slot.status === "booked" ? "booked" : "unavailable",
                }));
                renderDayColumns();
                updateStats();
            }
        }

        // Save schedule as JSON
        function saveSchedule() {
            const jsonData = JSON.stringify(scheduleData, null, 2);
            console.log(jsonData);
             fetch('/d/submit-dateTime-slots/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: jsonData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification({
                        color: "bg-emerald-500",
                        title: "Schedule Saved",
                        message: "Your schedule has been saved successfully."
                    });
                } else {
                    showNotification({
                        color: "bg-red-500",
                        title: "Save Failed",
                        message: data.message || "Failed to save schedule."
                    });
                }
            })
            .catch(error => {
                showNotification({
                    color: "bg-red-500",
                    title: "Save Failed",
                    message: "Error: " + error
                });
            }); 
        }

        // Initialize the application
        renderTimeSlots();
        renderDayColumns();
        updateWeekRange();
        updateStats();
        setupEventListeners();
    };
</script>





<script>

    dashboard_nav_all = document.querySelectorAll('.edit_schedules-nav a');
    dashboard_nav_all.forEach((nav) => {
        nav_innertab =
            nav.classList.add('border-l-4', 'border-blue-500', 'bg-blue-50', 'rounded');
    });
</script>


{% endblock scripts %}