{% extends "pages/management/M_base.html" %}
{% load static %}

{% block titles %}View Patients || Nepal's Care {% endblock titles %}

{% block styles %}{% endblock styles %}

{% block pageof %} View Patients {% endblock pageof %}
{% block linkPageof %} {% url 'management:ViewPatients' %} {% endblock linkPageof %}

{% block content %}
  <!-- Main Content -->
  <div class="flex h-screen overflow-hidden">
      <!-- Main Content -->
      <div class="flex-1 overflow-y-auto">
          <div class="p-6 lg:p-10 w-full">
              <div class="mb-6 bg-white rounded-xl p-6 shadow-sm">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                    <div class="mb-4 md:mb-0">
                        <h2 class="text-3xl font-bold text-gray-800">Patient Management</h2>
                        <p class="text-gray-600 max-w-2xl">Manage all Patient, add new ones, and view or edit existing Patient with ease.</p>
                    </div>
                    <button id="add-patient-trigger" class="flex items-center justify-center px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        <span class="font-medium">Add New Patient</span>
                    </button>
                </div>
              </div>



              <!-- Search and Filters -->
              <div class="bg-white rounded-lg shadow p-4 mb-6">
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div class="relative">
                          <input type="text" id="searchInput" placeholder="Search patients..."
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent pl-10">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-3"
                              fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                          </svg>
                      </div>
                  </div>
              </div>

              <!-- Patients List -->
              <div class="bg-white rounded-lg shadow overflow-hidden">
                  <div class="overflow-x-auto">
                      <table class="w-full">
                          <thead class="bg-gray-50">
                              <tr>
                                  <th
                                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                      Patient</th>
                                  <th
                                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                      Total Appointment Booked</th>
                                  <th
                                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Contact</th>
                                  <th
                                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                      Actions</th>
                              </tr>
                          </thead>
                          <tbody id="patientTableBody" class="divide-y divide-gray-200">
                              {% for each_P in patients %}
                                  <tr class="hover:bg-gray-50 transition-all duration-200" >
                                      <!-- Patient Info -->
                                      <td class="table-cell px-4 py-4 whitespace-nowrap doctor-details"
                                          title="View Profile" data-patient="{{ each_P.user.first_name }}" >
                                          <a href="{% url 'ViewPatientsRecords' each_P.user.username %}" target="_blank_" class="bg-indigo-600 hover:bg-indigo-800">
                                              <div class="flex items-center">
                                                  <div class="flex-shrink-0 h-10 w-10">
                                                      <img class="h-10 w-10 rounded-full object-cover shadow-sm border border-gray-200 transition-transform duration-200 hover:scale-110"
                                                          src="{{ each_P.profile_pic.url }}"
                                                          alt="{{ each_P.user.first_name}}">
                                                  </div>
                                                  <div class="ml-4">
                                                      <p class="text-sm font-medium text-gray-900" data-doctor="{{ each_P.user.first_name }}"  >{{ each_P.user.first_name }}
                                                      </p>
                                                      <div class="text-sm text-gray-500" data-specialization='{{ each_P.user.username }}' >{{ each_P.user.username }}</div>
                                                  </div>
                                              </div>
                                          </a>
                                      </td>

                                      <!-- total appoinment booked -->
                                      <td class="table-cell px-4 py-4 whitespace-nowrap doctor-details">
                                          <p class="text-sm font-medium text-gray-900" data-patient="{{ each_P.user.first_name }}" >
                                              {{ each_P.patients_appointments.count }}
                                          </p>
                                      </td>

                                      <!-- Contact Info -->
                                      <td class="table-cell px-4 py-4 whitespace-nowrap">
                                          <div class="flex flex-col">
                                              <div class="flex items-center mb-1">
                                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                                      <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
                                                  </svg>
                                                  <span class="text-sm text-gray-700">{{ each_P.ph_number|default:"Null" }}</span>
                                              </div>
                                              <div class="flex items-center">
                                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                                      <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                                                      <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                                                  </svg>
                                                  <span class="text-sm text-gray-700">{{ each_P.user.email|default:'Null' }}</span>
                                              </div>
                                          </div>
                                      </td>

                                      <!-- Actions Btns -->
                                      <td class="px-4 py-4 whitespace-nowrap">
                                          <div class="flex space-x-2">
                                              <!-- View Full Info A link-->

                                              <a href="{% url 'ViewPatientsRecords' each_P.user.username %}" target="_blank"
                                                  class="text-blue-600 hover:text-blue-800 transition-colors">
                                                  <span class="">Medical-Rec</span>
                                              </a>

                                              <button class="bg-blue-500 text-white px-3 py-1 rounded patient-modal-trigger" data-username="{{ each_P.user.username }}">
                                                  View/Edit
                                                </button>
                                              
                                          </div>
                                      </td>
                                  </tr>
                              {% empty %}
                                  <tr class="col-span-full text-gray-500">
                                      <td>
                                          No Patients Found 
                                      </td>
                                  </tr>
                              {% endfor %}
                          </tbody>
                      </table>
                  </div>
              </div>

              <!-- Pagination and Show Entries -->
              <div class="bg-white border-t border-gray-200 rounded-b-lg">
                  <div class="flex flex-col lg:flex-row items-center justify-between py-4 px-4 md:px-6 space-y-4 lg:space-y-0">
              
                  <!-- Show Entries Selector -->
                  <form method="get" class="flex items-center space-x-3 w-full lg:w-auto" id="perPageForm">
                      <span class="text-gray-600 text-sm whitespace-nowrap">Show entries</span>
                      <div class="relative">
                      <select name="per_page" onchange="document.getElementById('perPageForm').submit()"
                              class="appearance-none pl-4 pr-10 py-2 border border-gray-300 bg-white rounded-full text-sm font-medium text-gray-700 shadow-sm hover:border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-200 cursor-pointer">
                          {% for n in per_page_options %}
                          <option value="{{ n }}" {% if per_page == n %}selected{% endif %}>{{ n }}</option>
                          {% endfor %}
                      </select>
                      <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-indigo-500">
                          <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd"
                                  d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                  clip-rule="evenodd"/>
                          </svg>
                      </div>
                      </div>
                      {# preserve current page when changing per_page #}
                      <input type="hidden" name="page" value="{{ appointments.number }}">
                  </form>
              
                  <!-- Results Counter -->
                  <div class="hidden sm:block text-center lg:text-left text-sm text-gray-500">
                      Showing
                      <span class="font-semibold text-gray-700">
                      {{ appointments.start_index }}
                      </span>
                      to
                      <span class="font-semibold text-gray-700">
                      {{ appointments.end_index }}
                      </span>
                      of
                      <span class="font-semibold text-gray-700">
                      {{ paginator.count }}
                      </span>
                      results
                  </div>
              
                  <!-- Pagination Navigation -->
                  <div class="w-full lg:w-auto flex justify-center lg:justify-end">
                      <nav class="relative z-0 inline-flex shadow-sm -space-x-px rounded-md" aria-label="Pagination">
              
                      {# Previous #}
                      {% if appointments.has_previous %}
                          <a href="?page={{ appointments.previous_page_number }}&per_page={{ per_page }}"
                          class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition duration-150">
                          <span class="sr-only">Previous</span>
                          <!-- ← -->
                          <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd"
                                  d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 
                                      01-1.414 1.414l-4-4a1 1 0 
                                      010-1.414l4-4a1 1 0 011.414 0z"
                                  clip-rule="evenodd"/>
                          </svg>
                          </a>
                      {% else %}
                          <span class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-400 cursor-not-allowed disabled:opacity-50">
                          <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd"
                                  d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 
                                      01-1.414 1.414l-4-4a1 1 0 
                                      010-1.414l4-4a1 1 0 011.414 0z"
                                  clip-rule="evenodd"/>
                          </svg>
                          </span>
                      {% endif %}
              
                      {# Page Numbers #}
                      {% for num in paginator.page_range %}
                          {% if num >= appointments.number|add:-2 and num <= appointments.number|add:2 %}
                          {% if num == appointments.number %}
                              <span aria-current="page"
                                  class="relative inline-flex items-center px-4 py-2 border border-indigo-500 bg-indigo-50 text-sm font-medium text-indigo-600">
                              {{ num }}
                              </span>
                          {% else %}
                              <a href="?page={{ num }}&per_page={{ per_page }}"
                              class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition duration-150">
                              {{ num }}
                              </a>
                          {% endif %}
                          {% elif num == 1 or num == paginator.num_pages %}
                          <!-- always show first and last -->
                          <a href="?page={{ num }}&per_page={{ per_page }}"
                              class="relative inline-flex hidden md:inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition duration-150">
                              {{ num }}
                          </a>
                          {% elif num == appointments.number|add:-3 or num == appointments.number|add:3 %}
                          <span class="relative inline-flex hidden md:inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                              …
                          </span>
                          {% endif %}
                      {% endfor %}
              
                      {# Next #}
                      {% if appointments.has_next %}
                          <a href="?page={{ appointments.next_page_number }}&per_page={{ per_page }}"
                          class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition duration-150">
                          <span class="sr-only">Next</span>
                          <!-- → -->
                          <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd"
                                  d="M7.293 14.707a1 1 0 
                                      010-1.414L10.586 10 7.293 6.707a1 1 0 
                                      011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 
                                      01-1.414 0z"
                                  clip-rule="evenodd"/>
                          </svg>
                          </a>
                      {% else %}
                          <span class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-400 cursor-not-allowed disabled:opacity-50">
                          <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd"
                                  d="M7.293 14.707a1 1 0 
                                      010-1.414L10.586 10 7.293 6.707a1 1 0 
                                      011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 
                                      01-1.414 0z"
                                  clip-rule="evenodd"/>
                          </svg>
                          </span>
                      {% endif %}
              
                      </nav>
                  </div>
                  </div>
              </div>
          </div>
      </div>
  </div>


  <!-- Add Patient Modal Background Overlay -->
  <div id="add-patient-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center transition-opacity duration-300 ease-in-out opacity-0">
    <!-- Modal Container -->
    <div id="add-patient-modal" class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-4xl w-full mx-4 md:mx-auto max-h-[90vh] overflow-hidden flex flex-col transform transition-all duration-300 ease-in-out scale-95 opacity-0">
      <!-- Modal Header -->
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gradient-to-r from-purple-600 to-indigo-600 text-white">
        <h3 class="text-lg md:text-xl font-bold flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
          </svg>
          <span>Add New Patient</span>
        </h3>
        
        <button id="close-add-patient-modal" class="bg-white bg-opacity-20 hover:bg-opacity-30 p-1.5 rounded-lg transition-all duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      
      <!-- Modal Content -->
      <div class="flex-1 overflow-y-auto p-6">
        <form id="add-patient-form">
          <!-- Multi-step form navigation -->
          <div class="flex mb-6 border-b border-gray-200 dark:border-gray-700">
            <button type="button" class="form-step-btn active px-4 py-2 text-blue-600 border-b-2 border-blue-600 font-medium" data-step="1">Account Info</button>
            <button type="button" class="form-step-btn px-4 py-2 text-gray-500 hover:text-gray-700 font-medium" data-step="2">Personal Details</button>
            <button type="button" class="form-step-btn px-4 py-2 text-gray-500 hover:text-gray-700 font-medium" data-step="3">Medical Information</button>
          </div>
          
          <!-- Step 1: Account Information -->
          <div id="form-step-1" class="form-step">
            <div class="space-y-6">
              <div class="text-lg font-medium text-gray-900 dark:text-white mb-4">Account Information</div>
              
              <!-- Full Name & Email (Row) -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label for="first_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Full Name <span class="text-red-500">*</span></label>
                  <input type="text" id="first_name" name="first_name" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                </div>
                <div>
                  <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email <span class="text-red-500">*</span></label>
                  <input type="email" id="email" name="email" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                </div>
              </div>
              
              <!-- Password & Confirm Password (Row) -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password <span class="text-red-500">*</span></label>
                  <input type="password" id="password" name="password" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                  <p class="mt-1 text-xs text-gray-500">Password must be at least 8 characters long.</p>
                </div>
                <div>
                  <label for="confirm_password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Confirm Password <span class="text-red-500">*</span></label>
                  <input type="password" id="confirm_password" name="confirm_password" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                </div>
              </div>
            </div>
            
            <!-- Next Button -->
            <div class="mt-8 flex justify-end">
              <button type="button" class="next-step-btn px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors" data-next="2">
                Next: Personal Details
              </button>
            </div>
          </div>
          
          <!-- Step 2: Personal Details -->
          <div id="form-step-2" class="form-step hidden">
            <div class="space-y-6">
              <div class="text-lg font-medium text-gray-900 dark:text-white mb-4">Personal Details</div>
              
              <!-- Phone & Date of Birth (Row) -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label for="phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Phone Number</label>
                  <input type="tel" id="phone" name="phone" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="+977 9812345678">
                  <p class="mt-1 text-xs text-gray-500">Format: +999999999, up to 15 digits allowed.</p>
                </div>
                <div>
                  <label for="date_of_birth" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date of Birth</label>
                  <input type="date" id="date_of_birth" name="date_of_birth" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
              </div>
              
              <!-- Gender & Profile Picture (Row) -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label for="gender" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Gender</label>
                  <select id="gender" name="gender" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <option value="">-- Select Gender --</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div>
                  <label for="profile_pic" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Profile Picture</label>
                  <input type="file" id="profile_pic" name="profile_pic" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" accept="image/*">
                </div>
              </div>
              
              <!-- Address -->
              <div>
                <label for="address" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Address</label>
                <textarea id="address" name="address" rows="3" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
              </div>
              
              <!-- Notification Preferences -->
              <div>
                <span class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Notification Preferences</span>
                <div class="space-y-2">
                  <div class="flex items-center">
                    <input type="checkbox" id="email_notification" name="email_notification" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked>
                    <label for="email_notification" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Email Notifications</label>
                  </div>
                  <div class="flex items-center">
                    <input type="checkbox" id="sms_notification" name="sms_notification" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked>
                    <label for="sms_notification" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">SMS Notifications</label>
                  </div>
                  <div class="flex items-center">
                    <input type="checkbox" id="reminders" name="reminders" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked>
                    <label for="reminders" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Reminders</label>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Next/Previous Buttons -->
            <div class="mt-8 flex justify-between">
              <button type="button" class="prev-step-btn px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors" data-prev="1">
                Previous: Account Info
              </button>
              <button type="button" class="next-step-btn px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors" data-next="3">
                Next: Medical Information
              </button>
            </div>
          </div>
          
          <!-- Step 3: Medical Information -->
          <div id="form-step-3" class="form-step hidden">
            <div class="space-y-6">
              <div class="text-lg font-medium text-gray-900 dark:text-white mb-4">Medical Information</div>
              
              <!-- Blood Group -->
              <div>
                <label for="blood_group" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Blood Group</label>
                <select id="blood_group" name="blood_group" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                  <option value="">-- Select Blood Group --</option>
                  <option value="A+">A+</option>
                  <option value="A-">A-</option>
                  <option value="B+">B+</option>
                  <option value="B-">B-</option>
                  <option value="AB+">AB+</option>
                  <option value="AB-">AB-</option>
                  <option value="O+">O+</option>
                  <option value="O-">O-</option>
                </select>
              </div>
              
              <!-- Allergies -->
              <div>
                <label for="allergies" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Allergies</label>
                <textarea id="allergies" name="allergies" rows="3" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="List any allergies here..."></textarea>
              </div>
              
              <!-- Medical Conditions -->
              <div>
                <label for="medical_conditions" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Medical Conditions</label>
                <textarea id="medical_conditions" name="medical_conditions" rows="3" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="List any medical conditions here..."></textarea>
              </div>
              
              <!-- Ongoing Medications -->
              <div>
                <label for="on_going_medications" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Ongoing Medications</label>
                <textarea id="on_going_medications" name="on_going_medications" rows="3" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="List any ongoing medications here..."></textarea>
              </div>
              
              <!-- Emergency Contact -->
              <div>
                <div class="text-md font-medium text-gray-700 dark:text-gray-300 mb-3">Emergency Contact</div>
                
                <!-- Name & Relation (Row) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                  <div>
                    <label for="emg_contact_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Contact Name</label>
                    <input type="text" id="emg_contact_name" name="emg_contact_name" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                  </div>
                  <div>
                    <label for="emg_contact_relation" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Relationship</label>
                    <input type="text" id="emg_contact_relation" name="emg_contact_relation" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                  </div>
                </div>
                
                <!-- Phone & Address (Row) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label for="emg_contact_number" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Contact Number</label>
                    <input type="tel" id="emg_contact_number" name="emg_contact_number" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="+1234567890">
                  </div>
                  <div>
                    <label for="emg_contact_address" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Contact Address</label>
                    <input type="text" id="emg_contact_address" name="emg_contact_address" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Submission Info -->
            <div class="mt-4 text-sm text-gray-500 dark:text-gray-400 flex justify-between">
              <div>Current User: <span id="current-user">{{ request.user.username }}</span></div>
              <div>Current Time (UTC): <span id="current-time">2025-06-28 01:31:57</span></div>
            </div>
            
            <!-- Submit/Previous Buttons -->
            <div class="mt-8 flex justify-between">
              <button type="button" class="prev-step-btn px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors" data-prev="2">
                Previous: Personal Details
              </button>
              <button type="submit" id="submit-patient-btn" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors flex items-center">
                <span>Register Patient</span>
                <svg id="patient-submit-spinner" class="animate-spin ml-2 h-4 w-4 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>



  <!-- Patient Information Modal -->
  <div id="patient-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="patient-modal-title" role="dialog" aria-modal="true">
    <!-- Backdrop with blur effect -->
    <div class="fixed inset-0 bg-gray-900 bg-opacity-70 backdrop-blur-sm transition-opacity"></div>
    
    <!-- Modal Content -->
    <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
      <div class="relative transform overflow-hidden rounded-xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-3xl border border-gray-100">
        <!-- Close Button -->
        <button type="button" id="modal-close-btn" class="absolute top-3 right-3 z-10 rounded-full p-1.5 bg-white/90 text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
          <span class="sr-only">Close</span>
          <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>

        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-slate-50 to-blue-50 px-6 py-4">
          <div class="flex items-center">
            <div class="flex-shrink-0 mr-4">
              <div class="rounded-full bg-blue-800 p-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
              </div>
            </div>
            <div>
              <h3 class="text-xl font-semibold leading-6 " id="patient-modal-title">Patient Information</h3>
            </div>
          </div>
        </div>

        <!-- Tab Navigation -->
        <div class="px-6 bg-white border-b border-gray-100 shadow-sm">
          <nav class="flex -mb-px overflow-x-auto hide-scrollbar" aria-label="Tabs">
            <button id="tab-basic" class="tab-btn tab-active flex items-center space-x-2 py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap mr-8">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
              <span>Basic Info</span>
            </button>
            <button id="tab-medical" class="tab-btn flex items-center space-x-2 py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap mr-8">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.5 12.75l6 6 9-13.5" />
              </svg>
              <span>Medical Info</span>
            </button>
            <button id="tab-appointments" class="tab-btn flex items-center space-x-2 py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <span>Appointments</span>
            </button>
          </nav>
        </div>
        
        <!-- Tab Content -->
        <div class="px-6 py-6 max-h-[calc(100vh-220px)] overflow-y-auto">
          <!-- Basic Info Tab (Visible by Default) -->
          <div id="content-basic" class="tab-content block">
            <!-- View Mode -->
            <div id="basic-info-view">
              <div class="flex flex-col md:flex-row">
                <div class="md:w-1/3 flex flex-col items-center mb-6 md:mb-0">
                  <div class="relative">
                    <img id="patient-profile-pic" class="h-32 w-32 rounded-full object-cover ring-4 ring-white shadow-lg" src="" alt="Patient profile picture">
                    <div class="absolute -bottom-1 -right-1">
                      <div id="patient-status-indicator" class="h-6 w-6 rounded-full bg-green-500 border-2 border-white shadow"></div>
                    </div>
                  </div>
                  <h3 id="patient-name" class="mt-4 text-xl font-bold text-gray-900 text-center"></h3>
                  <p id="patient-username" class="text-sm text-gray-500 text-center"></p>
                  <div class="mt-3 flex justify-center space-x-2">
                    <span id="patient-status-active" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                      Active
                    </span>
                    <span id="patient-status-verified" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                      Verified
                    </span>
                  </div>
                </div>
                
                <div class="md:w-2/3 md:pl-8">
                  <div class="flex justify-between items-center mb-4">
                    <h4 class="text-base font-semibold text-gray-700">Contact Information</h4>
                    <button id="edit-basic-info-btn" class="inline-flex items-center px-3 py-1.5 border border-blue-300 shadow-sm text-sm font-medium rounded-md text-blue-700 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                      </svg>
                      Edit Info
                    </button>
                  </div>
                  
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 rounded-lg p-4">
                    <div class="flex items-start">
                      <div class="flex-shrink-0 mt-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                      </div>
                      <div class="ml-3">
                        <dt class="text-sm font-medium text-gray-900">Email</dt>
                        <dd id="patient-email" class="mt-1 text-sm text-gray-600 break-all"></dd>
                      </div>
                    </div>
                    <div class="flex items-start">
                      <div class="flex-shrink-0 mt-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                        </svg>
                      </div>
                      <div class="ml-3">
                        <dt class="text-sm font-medium text-gray-900">Phone</dt>
                        <dd id="patient-phone" class="mt-1 text-sm text-gray-600"></dd>
                      </div>
                    </div>
                    <div class="flex items-start">
                      <div class="flex-shrink-0 mt-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                      </div>
                      <div class="ml-3">
                        <dt class="text-sm font-medium text-gray-900">Gender</dt>
                        <dd id="patient-gender" class="mt-1 text-sm text-gray-600"></dd>
                      </div>
                    </div>
                    <div class="flex items-start">
                      <div class="flex-shrink-0 mt-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                      </div>
                      <div class="ml-3">
                        <dt class="text-sm font-medium text-gray-900">Date of Birth</dt>
                        <dd id="patient-dob" class="mt-1 text-sm text-gray-600"></dd>
                      </div>
                    </div>
                    <div class="flex items-start col-span-2">
                      <div class="flex-shrink-0 mt-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                      </div>
                      <div class="ml-3">
                        <dt class="text-sm font-medium text-gray-900">Address</dt>
                        <dd id="patient-address" class="mt-1 text-sm text-gray-600"></dd>
                      </div>
                    </div>
                  </div>
                  
                  <div class="mt-6">
                    <h4 class="text-base font-semibold text-gray-700 mb-2">Notification Preferences</h4>
                    <div class="grid grid-cols-3 gap-2">
                      <div class="flex items-center justify-center bg-gray-50 rounded-md p-2">
                        <span id="email-notif-indicator" class="inline-flex items-center text-xs font-medium">
                          <span class="h-2.5 w-2.5 rounded-full mr-1.5"></span>
                          Email
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Edit Mode -->
            <div id="basic-info-edit" class="hidden">
              <form id="basic-info-form" class="space-y-6">
                {% csrf_token %}
                <input type="hidden" id="edit-patient-username" name="username">
                
                <div class="flex flex-col md:flex-row gap-6">
                  <div class="md:w-1/3 flex flex-col items-center">
                    <div class="relative">
                      <img id="edit-profile-pic-preview" class="h-32 w-32 rounded-full object-cover ring-4 ring-white shadow-md mb-3" src="" alt="Profile picture preview">
                      <label for="edit-profile-pic" class="absolute bottom-0 right-0 bg-blue-600 text-white p-2 rounded-full cursor-pointer shadow-md hover:bg-blue-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                      </label>
                      <input id="edit-profile-pic" name="profile_pic" type="file" accept="image/*" class="hidden">
                    </div>

                    <div class="text-center mt-4 space-y-2">
                      <div class="mb-3">
                        <input type="text" id="edit-full-name" title="Edit Your Name" name="full_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="First name">
                      </div>
                      <div class="mt-3">
                        <label for="edit-is-active" class="block text-sm font-medium text-gray-700">Account Status</label>
                        <div class="mt-1 flex justify-center space-x-3">
                        <label class="inline-flex items-center">
                          <input type="checkbox" id="edit-is-active" name="is_active" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                          <span class="ml-2 text-sm text-gray-700">Active</span>
                        </label>
                        <label class="inline-flex items-center">
                          <input type="checkbox" id="edit-is-verified" name="is_verified" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                          <span class="ml-2 text-sm text-gray-700">Verified</span>
                        </label>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="md:w-2/3 space-y-4">
                    <div class="grid grid-cols-1 gap-y-4 sm:grid-cols-2 sm:gap-x-4">
                      <div>
                        <label for="edit-phone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                        <input type="tel" id="edit-phone" name="ph_number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="+1234567890">
                      </div>
                      <div>
                        <label for="edit-gender" class="block text-sm font-medium text-gray-700">Gender</label>
                        <select id="edit-gender" name="gender" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                          <option value="">Select Gender</option>
                          <option value="male">Male</option>
                          <option value="female">Female</option>
                          <option value="other">Other</option>
                        </select>
                      </div>
                      <div>
                        <label for="edit-dob" class="block text-sm font-medium text-gray-700">Date of Birth</label>
                        <input type="date" id="edit-dob" name="date_of_birth" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                      </div>
                      <div>
                        <label for="edit-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="edit-email" name="email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-gray-100" readonly>
                      </div>
                      <div class="sm:col-span-2">
                        <label for="edit-address" class="block text-sm font-medium text-gray-700">Address</label>
                        <textarea id="edit-address" name="address" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Full address"></textarea>
                      </div>
                    </div>
                    
                    <div class="bg-gray-50 p-3 rounded-lg">
                      <p class="text-sm font-medium text-gray-700 mb-2">Notification Preferences</p>
                      <div class="flex flex-wrap gap-4">
                        <label class="inline-flex items-center">
                          <input type="checkbox" id="edit-email-notif" name="emailNotification" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                          <span class="ml-2 text-sm text-gray-700">Email Notifications</span>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="flex justify-end space-x-3 border-t border-gray-200 pt-4">
                  <button type="button" id="cancel-basic-edit" class="inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Cancel
                  </button>
                  <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Save Changes
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Medical Info Tab (Hidden by Default) -->
          <div id="content-medical" class="tab-content hidden">
            <!-- View Mode -->
            <div id="medical-info-view">
              <div class="flex justify-between items-center mb-4">
                <h4 class="text-base font-semibold text-gray-700">Medical Information</h4>
                <button id="edit-medical-info-btn" class="inline-flex items-center px-3 py-1.5 border border-blue-300 shadow-sm text-sm font-medium rounded-md text-blue-700 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                  Edit Medical Info
                </button>
              </div>
            
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
                  <div class="flex items-center mb-2">
                    <div class="flex-shrink-0 p-1.5 bg-red-100 rounded-full">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                      </svg>
                    </div>
                    <h5 class="ml-2 text-sm font-semibold text-gray-900">Blood Group</h5>
                  </div>
                  <p id="patient-blood-group" class="text-sm text-gray-700"></p>
                </div>
                
                <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
                  <div class="flex items-center mb-2">
                    <div class="flex-shrink-0 p-1.5 bg-yellow-100 rounded-full">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                      </svg>
                    </div>
                    <h5 class="ml-2 text-sm font-semibold text-gray-900">Allergies</h5>
                  </div>
                  <p id="patient-allergies" class="text-sm text-gray-700"></p>
                </div>
                
                <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100 md:col-span-2">
                  <div class="flex items-center mb-2">
                    <div class="flex-shrink-0 p-1.5 bg-blue-100 rounded-full">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                    </div>
                    <h5 class="ml-2 text-sm font-semibold text-gray-900">Medical Conditions</h5>
                  </div>
                  <p id="patient-medical-conditions" class="text-sm text-gray-700 whitespace-pre-line"></p>
                </div>
                
                <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100 md:col-span-2">
                  <div class="flex items-center mb-2">
                    <div class="flex-shrink-0 p-1.5 bg-purple-100 rounded-full">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                      </svg>
                    </div>
                    <h5 class="ml-2 text-sm font-semibold text-gray-900">Medications</h5>
                  </div>
                  <p id="patient-medications" class="text-sm text-gray-700 whitespace-pre-line"></p>
                </div>
              </div>

              <div class="mt-6 bg-blue-50 rounded-lg p-4 shadow-sm border border-blue-100">
                <div class="flex items-center mb-3">
                  <div class="flex-shrink-0 p-1.5 bg-blue-100 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                  </div>
                  <h5 class="ml-2 text-sm font-semibold text-blue-800">Emergency Contact</h5>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 ml-8">
                  <div>
                    <dt class="text-xs font-medium text-blue-700">Name</dt>
                    <dd id="emergency-contact-name" class="mt-1 text-sm text-gray-800 font-medium"></dd>
                  </div>
                  <div>
                    <dt class="text-xs font-medium text-blue-700">Phone</dt>
                    <dd id="emergency-contact-phone" class="mt-1 text-sm text-gray-800 font-medium"></dd>
                  </div>
                  <div>
                    <dt class="text-xs font-medium text-blue-700">Relation</dt>
                    <dd id="emergency-contact-relation" class="mt-1 text-sm text-gray-800"></dd>
                  </div>
                  <div class="md:col-span-2">
                    <dt class="text-xs font-medium text-blue-700">Address</dt>
                    <dd id="emergency-contact-address" class="mt-1 text-sm text-gray-800"></dd>
                  </div>
                </div>
              </div>

              <div class="mt-6 flex justify-center">
                <a id="view-medical-report-link" href="#" target="_blank_" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  View Full Medical Report
                </a>
              </div>
            </div>

            <!-- Edit Mode -->
            <div id="medical-info-edit" class="hidden">
              <form id="medical-info-form" class="space-y-6">
                {% csrf_token %}
                <input type="hidden" id="edit-medical-username" name="username">
                
                <div class="space-y-4">
                  <div>
                    <label for="edit-blood-group" class="block text-sm font-medium text-gray-700">Blood Group</label>
                    <select id="edit-blood-group" name="blood_group" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                      <option value="">Select Blood Group</option>
                      <option value="A+">A+</option>
                      <option value="A-">A-</option>
                      <option value="B+">B+</option>
                      <option value="B-">B-</option>
                      <option value="AB+">AB+</option>
                      <option value="AB-">AB-</option>
                      <option value="O+">O+</option>
                      <option value="O-">O-</option>
                    </select>
                  </div>
                  
                  <div>
                    <label for="edit-allergies" class="block text-sm font-medium text-gray-700">Allergies</label>
                    <textarea id="edit-allergies" name="allergies" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="List any allergies"></textarea>
                  </div>
                  
                  <div>
                    <label for="edit-medical-conditions" class="block text-sm font-medium text-gray-700">Medical Conditions</label>
                    <textarea id="edit-medical-conditions" name="medical_conditions" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="List any medical conditions"></textarea>
                  </div>
                  
                  <div>
                    <label for="edit-medications" class="block text-sm font-medium text-gray-700">Current Medications</label>
                    <textarea id="edit-medications" name="on_going_medications" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="List current medications"></textarea>
                  </div>
                  
                  <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <h4 class="text-sm font-semibold text-blue-800 mb-3">Emergency Contact Information</h4>
                    <div class="grid grid-cols-1 gap-y-4 sm:grid-cols-2 sm:gap-x-4">
                      <div>
                        <label for="edit-emergency-name" class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="edit-emergency-name" name="emg_contact_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Contact name">
                      </div>
                      <div>
                        <label for="edit-emergency-phone" class="block text-sm font-medium text-gray-700">Phone</label>
                        <input type="tel" id="edit-emergency-phone" name="emg_contact_number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Contact phone">
                      </div>
                      <div>
                        <label for="edit-emergency-relation" class="block text-sm font-medium text-gray-700">Relation</label>
                        <input type="text" id="edit-emergency-relation" name="emg_contact_relation" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="E.g., Spouse, Parent">
                      </div>
                      <div class="sm:col-span-2">
                        <label for="edit-emergency-address" class="block text-sm font-medium text-gray-700">Address</label>
                        <textarea id="edit-emergency-address" name="emg_contact_address" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Contact address"></textarea>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="flex justify-end space-x-3 border-t border-gray-200 pt-4">
                  <button type="button" id="cancel-medical-edit" class="inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Cancel
                  </button>
                  <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Save Changes
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Appointments Tab (Hidden by Default) -->
          <div id="content-appointments" class="tab-content hidden">
            <div class="bg-white shadow-sm rounded-lg border border-gray-100 overflow-hidden">
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider sm:pl-6">Date & Time</th>
                      <th scope="col" class="px-3 py-3.5 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Type</th>
                      <th scope="col" class="px-3 py-3.5 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Status</th>
                      <th scope="col" class="px-3 py-3.5 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Reason</th>
                    </tr>
                  </thead>
                  <tbody id="appointments-table-body" class="divide-y divide-gray-200 bg-white">
                    <!-- Appointments will be populated here -->
                  </tbody>
                </table>
              </div>
            </div>
            <div id="no-appointments" class="hidden py-10 text-center">
              <div class="inline-block p-4 rounded-full bg-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
              </div>
              <h3 class="mt-4 text-sm font-medium text-gray-900">No appointments</h3>
              <p class="mt-1 text-sm text-gray-500">No appointment records found for this patient.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .hide-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>






{% endblock content %}


{% block scripts %}

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // DOM Elements
      const addModalTriggers = document.getElementById('add-patient-trigger');
      const addModalOverlay = document.getElementById('add-patient-modal-overlay');
      const addModal = document.getElementById('add-patient-modal');
      const closeAddModalBtn = document.getElementById('close-add-patient-modal');
      const addPatientForm = document.getElementById('add-patient-form');
      const submitBtn = document.getElementById('submit-patient-btn');
      const submitSpinner = document.getElementById('patient-submit-spinner');
      
      // Form steps buttons
      const formStepBtns = document.querySelectorAll('.form-step-btn');
      const nextStepBtns = document.querySelectorAll('.next-step-btn');
      const prevStepBtns = document.querySelectorAll('.prev-step-btn');
      const formSteps = document.querySelectorAll('.form-step');
      
      // Current step tracker
      let currentStep = 1;
      
      // ---- Event Listeners ----
      
      // Open modal when clicking add patient buttons
      addModalTriggers.addEventListener('click', openAddModal);
      
      // Close modal when clicking the close button
      closeAddModalBtn.addEventListener('click', closeAddModal);
      
      // Close modal when clicking outside
      addModalOverlay.addEventListener('click', function(e) {
          if (e.target === addModalOverlay) {
              closeAddModal();
          }
      });
      
      // Form step navigation buttons
      formStepBtns.forEach(btn => {
          btn.addEventListener('click', function() {
              const step = parseInt(this.dataset.step);
              if (step < currentStep || validateCurrentStep()) {
                  goToStep(step);
              }
          });
      });
      
      // Next step buttons
      nextStepBtns.forEach(btn => {
          btn.addEventListener('click', function() {
              const nextStep = parseInt(this.dataset.next);
              if (validateCurrentStep()) {
                  goToStep(nextStep);
              }
          });
      });
      
      // Previous step buttons
      prevStepBtns.forEach(btn => {
          btn.addEventListener('click', function() {
              const prevStep = parseInt(this.dataset.prev);
              goToStep(prevStep);
          });
      });
      
      // Form submission
      if (addPatientForm) {
          addPatientForm.addEventListener('submit', function(e) {
              e.preventDefault(); // Prevent default form submission
              
              // Validate the current step (last step)
              if (!validateCurrentStep()) {
                  return false;
              }
              
              // Disable submit button and show spinner
              submitBtn.disabled = true;
              submitSpinner.classList.remove('hidden');
              
              // Get form data including file
              const formData = new FormData(addPatientForm);
              
              // Get CSRF token from cookie
              const csrfToken = getCsrfToken();
              
              // Make the API request
              fetch('/m/create-patients/', {
                  method: 'POST',
                  headers: {
                      'X-CSRFToken': csrfToken
                  },
                  body: formData
              })
              .then(response => {
                  if (!response.ok) {
                      return response.json().then(data => {
                          throw new Error(data.message || 'Error creating patient');
                      });
                  }
                  return response.json();
              })
              .then(data => {
                  // Show success notification
                  showNotification({
                      color: "bg-green-500",
                      title: "Success ✅",
                      message: "Patient registered successfully."
                  });
                  
                  // Close the modal
                  closeAddModal();
                  
                  // Reload the page to show the new patient
                  setTimeout(() => {
                      window.location.reload();
                  }, 1500);
              })
              .catch(error => {
                  // Show error notification
                  showNotification({
                      color: "bg-red-500",
                      title: "Registration Failed",
                      message: error.message || "Failed to register patient."
                  });
              })
              .finally(() => {
                  // Re-enable submit button and hide spinner
                  submitBtn.disabled = false;
                  submitSpinner.classList.add('hidden');
              });
              
              return false;
          });
      }
      
      // ---- Functions ----
      
      /**
       * Open the add patient modal
       */
      function openAddModal() {
          // Reset form if it exists
          if (addPatientForm) {
              addPatientForm.reset();
              
              // Reset to first step
              goToStep(1);
              
              // Clear error messages
              document.querySelectorAll('.field-error').forEach(el => el.remove());
              document.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500'));
          }
          
          // Show the modal with animation
          addModalOverlay.classList.remove('hidden');
          setTimeout(() => {
              addModalOverlay.classList.add('opacity-100');
              addModal.classList.add('opacity-100', 'scale-100');
              addModal.classList.remove('scale-95', 'opacity-0');
          }, 10);
          
          // Focus on the first field
          setTimeout(() => {
              document.getElementById('first_name').focus();
          }, 300);
      }
      
      /**
       * Close the add patient modal
       */
      function closeAddModal() {
          // Hide the modal with animation
          addModalOverlay.classList.remove('opacity-100');
          addModal.classList.remove('opacity-100', 'scale-100');
          addModal.classList.add('scale-95', 'opacity-0');
          
          setTimeout(() => {
              addModalOverlay.classList.add('hidden');
          }, 300);
      }
      
      /**
       * Go to a specific step in the form
       * @param {number} step - The step number to go to
       */
      function goToStep(step) {
          // Hide all steps
          formSteps.forEach(formStep => {
              formStep.classList.add('hidden');
          });
          
          // Show the selected step
          document.getElementById(`form-step-${step}`).classList.remove('hidden');
          
          // Update the step buttons
          formStepBtns.forEach(btn => {
              const btnStep = parseInt(btn.dataset.step);
              btn.classList.remove('active', 'text-blue-600', 'border-b-2', 'border-blue-600');
              btn.classList.add('text-gray-500', 'hover:text-gray-700');
              
              if (btnStep === step) {
                  btn.classList.add('active', 'text-blue-600', 'border-b-2', 'border-blue-600');
                  btn.classList.remove('text-gray-500', 'hover:text-gray-700');
              }
          });
          
          // Update current step
          currentStep = step;
      }
      
      /**
       * Validate the current step
       * @returns {boolean} Whether the current step is valid
       */
      function validateCurrentStep() {
          let isValid = true;
          
          // Clear previous error messages
          document.querySelectorAll('.field-error').forEach(el => el.remove());
          document.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500'));
          
          // Step 1 validation
          if (currentStep === 1) {
              // Required fields
              const email = document.getElementById('email');
              const firstName = document.getElementById('first_name');
              const password = document.getElementById('password');
              const confirmPassword = document.getElementById('confirm_password');
        
              // Validate email
              if (!email.value.trim()) {
                  showFieldError(email, 'Email is required');
                  isValid = false;
              } else if (!isValidEmail(email.value.trim())) {
                  showFieldError(email, 'Please enter a valid email address');
                  isValid = false;
              }
              
              // Validate first name
              if (!firstName.value.trim()) {
                  showFieldError(firstName, 'First name is required');
                  isValid = false;
              }
              
              // Validate password
              if (!password.value) {
                  showFieldError(password, 'Password is required');
                  isValid = false;
              } else if (password.value.length < 8) {
                  showFieldError(password, 'Password must be at least 8 characters');
                  isValid = false;
              }
              
              // Validate confirm password
              if (!confirmPassword.value) {
                  showFieldError(confirmPassword, 'Please confirm your password');
                  isValid = false;
              } else if (password.value !== confirmPassword.value) {
                  showFieldError(confirmPassword, 'Passwords do not match');
                  isValid = false;
              }
          }
          
          // Step 2 validation
          else if (currentStep === 2) {
              // Phone number validation (if provided)
              const phone = document.getElementById('phone');
              if (phone.value.trim() && !isValidPhone(phone.value.trim())) {
                  showFieldError(phone, 'Please enter a valid phone number format');
                  isValid = false;
              }
              
              // Date of birth validation (if provided)
              const dob = document.getElementById('date_of_birth');
              if (dob.value) {
                  const dobDate = new Date(dob.value);
                  const today = new Date();
                  
                  if (dobDate > today) {
                      showFieldError(dob, 'Date of birth cannot be in the future');
                      isValid = false;
                  }
              }
          }
          
          // Step 3 validation
          // No required fields in step 3, so no validation needed
          
          return isValid;
      }
      
      /**
       * Show an error message for a field
       * @param {HTMLElement} field - The field with the error
       * @param {string} message - The error message
       */
      function showFieldError(field, message) {
          // Add error class to the field
          field.classList.add('border-red-500');
          
          // Create error message element
          const errorElement = document.createElement('p');
          errorElement.className = 'mt-1 text-sm text-red-600 field-error';
          errorElement.textContent = message;
          
          // Insert the error message after the field
          field.parentNode.insertBefore(errorElement, field.nextSibling);
          
          // Focus on the first field with an error
          if (!document.querySelector('.field-error ~ .field-error')) {
              field.focus();
          }
      }
      
      /**
       * Check if an email is valid
       * @param {string} email - The email to validate
       * @returns {boolean} Whether the email is valid
       */
      function isValidEmail(email) {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return emailRegex.test(email);
      }
      
      /**
       * Check if a phone number is valid
       * @param {string} phone - The phone number to validate
       * @returns {boolean} Whether the phone number is valid
       */
      function isValidPhone(phone) {
          const phoneRegex = /^\+?1?\d{9,15}$/;
          return phoneRegex.test(phone);
      }
      
      /**
       * Get CSRF token from cookie
       * @returns {string} The CSRF token
       */
      function getCsrfToken() {
          const name = 'csrftoken';
          let cookieValue = null;
          
          if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          
          return cookieValue;
      }
      
      /**
       * Update the current time display
       */
      function updateCurrentTime() {
          const timeElement = document.getElementById('current-time');
          if (timeElement) {
              const now = new Date();
              const year = now.getUTCFullYear();
              const month = String(now.getUTCMonth() + 1).padStart(2, '0');
              const day = String(now.getUTCDate()).padStart(2, '0');
              const hours = String(now.getUTCHours()).padStart(2, '0');
              const minutes = String(now.getUTCMinutes()).padStart(2, '0');
              const seconds = String(now.getUTCSeconds()).padStart(2, '0');
              
              timeElement.textContent = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
          }
      }
      
      // Update time initially and every minute
      updateCurrentTime();
      setInterval(updateCurrentTime, 60000);
  });
  </script>




  <!-- Script to handle patient data -->
  <script>
    DocData = [
        {% for eachP in patients %}
        {  // Basic Info
           username: "{{ eachP.user.username }}",
           name: "{{ eachP.user.get_full_name }}",
           profilePic: "{{ eachP.profile_pic.url }}",
           email: "{{ eachP.user.email }}",
           phone: "{{ eachP.ph_number|default:'' }}",
           address: "{{ eachP.address|default:'' }}",
           gender: "{{ eachP.gender|default:'' }}",
           dob: "{{ eachP.date_of_birth|date:'Y-m-d'|default:'' }}",
           is_active: {{ eachP.is_active|yesno:"true,false" }},
           is_verified: {{ eachP.is_verified|yesno:"true,false" }},
           emailNotification: {{ eachP.email_notification|yesno:"true,false" }},
            

            // Medical Info
            bloodGroup: "{{ eachP.medical_info.blood_group|default:'N/A' }}",
            allergies: "{{ eachP.medical_info.allergies|default:'N/A' }}",
            medicalConditions: `{{ eachP.medical_info.medical_conditions|default:'N/A' }}`,
            medications: "{{ eachP.medical_info.on_going_medications|default:'N/A' }}",
            emergencyContact: {
                name: "{{ eachP.medical_info.emergency_contact_name|default:'N/A' }}",
                phone: "{{ eachP.medical_info.emg_contact_number|default:'N/A' }}",
                relation: "{{ eachP.medical_info.emg_contact_relation|default:'N/A' }}",
                address: "{{ eachP.medical_info.emg_contact_address|default:'N/A' }}",
            },
            appointments: [
                {% for appointment in eachP.patients_appointments.all %}
                    {
                    appo_uuid: "{{ appointment.uuid }}",
                    docName: "{{ appointment.doctor.profile.user.get_full_name }}",
                    docUsername: "{{ appointment.doctor.profile.user.username }}",
            
                    reason: "{{ appointment.reason|default:'' }}",
                    appointmentType: "{{ appointment.appointment_type }}",
                    status: "{{ appointment.status }}",
                    appointmentDate: "{{ appointment.appointment_date|date:'Y-m-d' }} {{ appointment.appointment_date|time:'H:i:s' }}",
                    
                    canceledBy: "{{ appointment.canceled_by.user.get_full_name|default:'' }}",
                    cancelReason: "{{ appointment.cancel_reason|default:'' }}",
                    confirmedBy: "{{ appointment.confirm_by.user.get_full_name|default:'' }}",
                    createdAt: "{{ appointment.created_at|date:'Y-m-d H:i:s'|default:'' }}",
                    updatedAt: "{{ appointment.updated_at|date:'Y-m-d H:i:s'|default:'' }}",
                    },
                {% endfor %}
            ]
        },
        {% endfor %}
    ]
        /**
        * Patient Information Modal JavaScript
        * Handles functionality for viewing and editing patient information
        */
        document.addEventListener('DOMContentLoaded', function() {
          // DOM Elements
          const modal = document.getElementById('patient-modal');
          const closeButton = document.getElementById('modal-close-btn');
          const tabButtons = document.querySelectorAll('.tab-btn');
          const tabContents = document.querySelectorAll('.tab-content');
          
          // Edit mode toggles
          const editBasicInfoBtn = document.getElementById('edit-basic-info-btn');
          const cancelBasicEditBtn = document.getElementById('cancel-basic-edit');
          const editMedicalInfoBtn = document.getElementById('edit-medical-info-btn');
          const cancelMedicalEditBtn = document.getElementById('cancel-medical-edit');
          
          // Forms
          const basicInfoForm = document.getElementById('basic-info-form');
          const medicalInfoForm = document.getElementById('medical-info-form');
          
          // Profile pic preview
          const profilePicInput = document.getElementById('edit-profile-pic');
          const profilePicPreview = document.getElementById('edit-profile-pic-preview');
          
          // Current patient data reference
          let currentPatient = null;
          
          // Initialize the patient modal and bind events
          function initPatientModal() {
            // Tab switching functionality
            tabButtons.forEach(button => {
              button.addEventListener('click', () => {
                // Remove active class from all tabs
                tabButtons.forEach(btn => {
                  btn.classList.remove('tab-active', 'border-blue-500', 'text-blue-600');
                  btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                });
                
                // Add active class to clicked tab
                button.classList.add('tab-active', 'border-blue-500', 'text-blue-600');
                button.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                
                // Hide all tab contents
                tabContents.forEach(content => {
                  content.classList.add('hidden');
                  content.classList.remove('block');
                });
                
                // Show selected tab content
                const tabId = button.id.replace('tab-', 'content-');
                const activeContent = document.getElementById(tabId);
                activeContent.classList.remove('hidden');
                activeContent.classList.add('block');
              });
            });
            
            // Toggle edit modes
            editBasicInfoBtn.addEventListener('click', () => {
              document.getElementById('basic-info-view').classList.add('hidden');
              document.getElementById('basic-info-edit').classList.remove('hidden');
            });
            
            cancelBasicEditBtn.addEventListener('click', () => {
              document.getElementById('basic-info-edit').classList.add('hidden');
              document.getElementById('basic-info-view').classList.remove('hidden');
              
              // Reset form to original values
              if (currentPatient) {
                populateBasicInfoEditForm(currentPatient);
              }
            });
            
            editMedicalInfoBtn.addEventListener('click', () => {
              document.getElementById('medical-info-view').classList.add('hidden');
              document.getElementById('medical-info-edit').classList.remove('hidden');
            });
            
            cancelMedicalEditBtn.addEventListener('click', () => {
              document.getElementById('medical-info-edit').classList.add('hidden');
              document.getElementById('medical-info-view').classList.remove('hidden');
              
              // Reset form to original values
              if (currentPatient) {
                populateMedicalInfoEditForm(currentPatient);
              }
            });
            
            // Profile pic preview handler
            profilePicInput.addEventListener('change', function(event) {
              const file = event.target.files[0];
              if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                  profilePicPreview.src = e.target.result;
                };
                reader.readAsDataURL(file);
              }
            });
            
            // Handle form submissions
            basicInfoForm.addEventListener('submit', function(e) {
              e.preventDefault();
              
              const formData = new FormData(basicInfoForm);
              const username = formData.get('username');
              
              fetch(`/m/update-profile/${username}/`, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin',
                headers: {
                  'X-Requested-With': 'XMLHttpRequest',
                  'X-CSRFToken': '{{ csrf_token }}'
                }
              })
              .then(response => {
                if (!response.ok) {
                  throw new Error('Network response was not ok');
                }
                return response.json();
              })
              .then(data => {
                // Update the current patient data with new values
                if (currentPatient) {
                  currentPatient.phone = formData.get('ph_number') || '';
                  currentPatient.gender = formData.get('gender') || '';
                  currentPatient.dob = formData.get('date_of_birth') || '';
                  currentPatient.address = formData.get('address') || '';
                  currentPatient.emailNotification = formData.get('emailNotification') === 'on';
                  currentPatient.is_active = formData.get('is_active') === 'on';
                  currentPatient.is_verified = formData.get('is_verified') === 'on';

                  // Update profile pic if it was changed
                  if (profilePicInput.files.length > 0) {
                    // Update the profile pic URL in the patient data
                    currentPatient.profilePic = URL.createObjectURL(profilePicInput.files[0]);
                  }

                  // Update email notification preference
                  currentPatient.emailNotification = formData.get('emailNotification') === 'on';
                  

                  // Refresh the displayed data
                  displayPatientInfo(currentPatient);
                }
                
                // Switch back to view mode
                document.getElementById('basic-info-edit').classList.add('hidden');
                document.getElementById('basic-info-view').classList.remove('hidden');
                
                // Show success notification
                showNotification({
                  color: "bg-green-500",
                  title: "Update Success.",
                  message: data.message || 'Profile information updated successfully'
              });
              })
              .catch(error => {
                console.error('Error updating profile:', error);
                showNotification({
                  color: "bg-red-500",
                  title: "Update Failed.",
                  message: data.message || 'Failed to update profile information'
                });
              });
            });
            
            medicalInfoForm.addEventListener('submit', function(e) {
              e.preventDefault();
              
              const formData = new FormData(medicalInfoForm);
              const username = formData.get('username');
              
              fetch(`/m/update-medical-info/${username}/`, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin',
                headers: {
                  'X-Requested-With': 'XMLHttpRequest',
                  'X-CSRFToken': '{{ csrf_token }}'
                }
              })
              .then(response => {
                if (!response.ok) {
                  throw new Error('Network response was not ok');
                }
                return response.json();
              })
              .then(data => {
                // Update the current patient data with new values
                if (currentPatient) {
                  currentPatient.bloodGroup = formData.get('blood_group') || '';
                  currentPatient.allergies = formData.get('allergies') || '';
                  currentPatient.medicalConditions = formData.get('medical_conditions') || '';
                  currentPatient.medications = formData.get('on_going_medications') || '';
                  currentPatient.emergencyContact.name = formData.get('emg_contact_name') || '';
                  currentPatient.emergencyContact.phone = formData.get('emg_contact_number') || '';
                  currentPatient.emergencyContact.relation = formData.get('emg_contact_relation') || '';
                  currentPatient.emergencyContact.address = formData.get('emg_contact_address') || '';
                  
                  // Refresh the displayed data
                  displayPatientMedicalInfo(currentPatient);
                }
                
                // Switch back to view mode
                document.getElementById('medical-info-edit').classList.add('hidden');
                document.getElementById('medical-info-view').classList.remove('hidden');
                
                // Show success notification
                showNotification({
                  color: "bg-green-500",
                  title: "Update Success.",
                  message: data.message || 'Medical information updated successfully'
                });
              })
              .catch(error => {
                console.error('Error updating medical info:', error);
                showNotification({
                  color: "bg-red-500",
                  title: "Update Failed.",
                  message: data.message || 'Failed to update medical information'
                });
              });
            });
            
            // Close modal functionality
            closeButton.addEventListener('click', () => {
              modal.classList.add('hidden');
            });
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
              if (e.target === modal) {
                modal.classList.add('hidden');
              }
            });
            
            // Add event listeners to all buttons with the patient-modal-trigger class
            const triggerButtons = document.querySelectorAll('.patient-modal-trigger');
            triggerButtons.forEach(button => {
              button.addEventListener('click', () => {
                const username = button.getAttribute('data-username');
                openPatientModal(username);
              });
            });
          }
          
          // Function to open modal and populate data
          function openPatientModal(username) {
            // Find patient data by username
            const patientData = DocData.find(patient => patient.username === username);
            
            if (!patientData) {
              console.error('Patient data not found for username:', username);
              return;
            }
            
            // Store current patient data reference
            currentPatient = patientData;
            
            // Reset to basic tab
            document.getElementById('tab-basic').click();
            
            // Display patient information
            displayPatientInfo(patientData);
            displayPatientMedicalInfo(patientData);
            displayAppointments(patientData);
            
            // Populate edit forms
            populateBasicInfoEditForm(patientData);
            populateMedicalInfoEditForm(patientData);
            
            // Show modal
            modal.classList.remove('hidden');
          }
          
            // Update notification indicator
            function updateNotificationIndicator(id, isEnabled) {
              const indicator = document.getElementById(id);
              const dot = indicator.querySelector('span');
              
              if (isEnabled) {
                indicator.classList.add('text-green-800');
                indicator.classList.remove('text-gray-500');
                dot.classList.add('bg-green-500');
                dot.classList.remove('bg-gray-300');
              } else {
                indicator.classList.remove('text-green-800');
                indicator.classList.add('text-gray-500');
                dot.classList.remove('bg-green-500');
                dot.classList.add('bg-gray-300');
              }
            }


          // Function to display basic patient information
          function displayPatientInfo(patientData) {
            // Set page title and patient name
            document.getElementById('patient-modal-title').textContent = `Patient: ${patientData.name}`;
            document.getElementById('patient-name').textContent = patientData.name;
            document.getElementById('patient-username').textContent = `@${patientData.username}`;
            document.getElementById('patient-profile-pic').src = patientData.profilePic;
            document.getElementById('patient-email').textContent = patientData.email || 'N/A';
            document.getElementById('patient-phone').textContent = patientData.phone || 'N/A';
            document.getElementById('patient-address').textContent = patientData.address || 'N/A';
            document.getElementById('patient-gender').textContent = formatGender(patientData.gender) || 'N/A';
            document.getElementById('patient-dob').textContent = formatDate(patientData.dob) || 'N/A';
            
            // Set status indicators
            const activeStatus = document.getElementById('patient-status-active');
            const verifiedStatus = document.getElementById('patient-status-verified');
            
            if (patientData.is_active) {
              activeStatus.classList.remove('hidden');
              activeStatus.classList.add('bg-green-100', 'text-green-800');
              activeStatus.textContent = 'Active';
            } else {
              activeStatus.classList.remove('bg-green-100', 'text-green-800');
              activeStatus.classList.add('bg-gray-100', 'text-gray-800');
              activeStatus.textContent = 'Inactive';
            }
            
            if (patientData.is_verified) {
              verifiedStatus.classList.remove('hidden');
              verifiedStatus.classList.add('bg-blue-100', 'text-blue-800');
              verifiedStatus.textContent = 'Verified';
            } else {
              verifiedStatus.classList.remove('bg-blue-100', 'text-blue-800');
              verifiedStatus.classList.add('bg-gray-100', 'text-gray-800');
              verifiedStatus.textContent = 'Unverified';
            }
            
            // Set notification preferences indicators
            console.log(patientData.emailNotification);
            updateNotificationIndicator('email-notif-indicator', patientData.emailNotification);
          }
          
          // Function to display patient medical information
          function displayPatientMedicalInfo(patientData) {
            document.getElementById('patient-blood-group').textContent = patientData.bloodGroup || 'Not specified';
            document.getElementById('patient-allergies').textContent = patientData.allergies || 'None reported';
            document.getElementById('patient-medical-conditions').textContent = patientData.medicalConditions || 'None reported';
            document.getElementById('patient-medications').textContent = patientData.medications || 'None reported';
            
            // Populate emergency contact
            document.getElementById('emergency-contact-name').textContent = patientData.emergencyContact.name || 'Not specified';
            document.getElementById('emergency-contact-phone').textContent = patientData.emergencyContact.phone || 'Not specified';
            document.getElementById('emergency-contact-relation').textContent = patientData.emergencyContact.relation || 'Not specified';
            document.getElementById('emergency-contact-address').textContent = patientData.emergencyContact.address || 'Not specified';
            
            // Set medical report link
            document.getElementById('view-medical-report-link').href = `/view-patients-records/${patientData.username}/`;
          }
          
          // Function to display appointments
          function displayAppointments(patientData) {
            const appointmentsTableBody = document.getElementById('appointments-table-body');
            const appointmentsTable = appointmentsTableBody.closest('div');
            const noAppointmentsMsg = document.getElementById('no-appointments');
            
            // Clear previous appointments
            appointmentsTableBody.innerHTML = '';
            
            if (patientData.appointments && patientData.appointments.length > 0) {
              noAppointmentsMsg.classList.add('hidden');
              appointmentsTable.classList.remove('hidden');
              
              patientData.appointments.forEach(appointment => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50', 'transition', 'duration-150');
                
                // Format date
                const appointmentDate = new Date(appointment.appointmentDate);
                const formattedDate = formatDateTime(appointmentDate);
                
                // Create status badge
                let statusClass = '';
                let statusIcon = '';
                switch(appointment.status.toLowerCase()) {
                  case 'confirmed':
                    statusClass = 'bg-green-100 text-green-800';
                    statusIcon = '<svg class="inline-block mr-1 h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>';
                    break;
                  case 'pending':
                    statusClass = 'bg-yellow-100 text-yellow-800';
                    statusIcon = '<svg class="inline-block mr-1 h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                    break;
                  case 'cancelled':
                  case 'canceled':
                    statusClass = 'bg-red-100 text-red-800';
                    statusIcon = '<svg class="inline-block mr-1 h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>';
                    break;
                  default:
                    statusClass = 'bg-gray-100 text-gray-800';
                    statusIcon = '';
                }
                
                // Populate row
                row.innerHTML = `
                  <td class="whitespace-nowrap py-4 pl-6 pr-3 text-sm font-medium text-gray-900">${formattedDate}</td>
                  <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-700">${appointment.appointmentType}</td>
                  <td class="whitespace-nowrap px-3 py-4 text-sm">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                      ${statusIcon}${appointment.status}
                    </span>
                  </td>
                  <td class="px-3 py-4 text-sm text-gray-700">${appointment.reason || 'N/A'}</td>
                `;
                
                // Add tooltip with additional information
                row.setAttribute('title', `
                  Doctor: ${appointment.docName}
                  Created: ${formatDateTime(new Date(appointment.createdAt))}
                  Updated: ${formatDateTime(new Date(appointment.updatedAt))}
                  ${appointment.canceledBy ? 'Canceled by: ' + appointment.canceledBy + '\nCancel reason: ' + appointment.cancelReason : ''}
                  ${appointment.confirmedBy ? 'Confirmed by: ' + appointment.confirmedBy : ''}
                `);
                
                appointmentsTableBody.appendChild(row);
              });
            } else {
              noAppointmentsMsg.classList.remove('hidden');
              appointmentsTable.classList.add('hidden');
            }
          }
          
          // Function to populate basic info edit form
          function populateBasicInfoEditForm(patientData) {
            document.getElementById('edit-patient-username').value = patientData.username;
            document.getElementById('edit-profile-pic-preview').src = patientData.profilePic;
            document.getElementById('edit-is-active').checked = patientData.is_active;
            document.getElementById('edit-is-verified').checked = patientData.is_verified;
            document.getElementById('edit-full-name').value = patientData.name;
            document.getElementById('edit-email').value = patientData.email;
            document.getElementById('edit-phone').value = patientData.phone || '';
            document.getElementById('edit-gender').value = patientData.gender || '';
            document.getElementById('edit-dob').value = patientData.dob || '';
            document.getElementById('edit-address').value = patientData.address || '';
            document.getElementById('edit-email-notif').checked = patientData.emailNotification;
          }
          
          // Function to populate medical info edit form
          function populateMedicalInfoEditForm(patientData) {
            document.getElementById('edit-medical-username').value = patientData.username;
            document.getElementById('edit-blood-group').value = patientData.bloodGroup || '';
            document.getElementById('edit-allergies').value = patientData.allergies || '';
            document.getElementById('edit-medical-conditions').value = patientData.medicalConditions || '';
            document.getElementById('edit-medications').value = patientData.medications || '';
            document.getElementById('edit-emergency-name').value = patientData.emergencyContact.name || '';
            document.getElementById('edit-emergency-phone').value = patientData.emergencyContact.phone || '';
            document.getElementById('edit-emergency-relation').value = patientData.emergencyContact.relation || '';
            document.getElementById('edit-emergency-address').value = patientData.emergencyContact.address || '';
          }
          
          // Helper function to format gender for display
          function formatGender(gender) {
            if (!gender) return '';
            return gender.charAt(0).toUpperCase() + gender.slice(1);
          }
          
          // Helper function to format date for display
          function formatDate(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            
            return date.toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });
          }
          
          // Helper function to format date and time for display
          function formatDateTime(date) {
            if (!date || isNaN(date.getTime())) return 'Invalid date';
            
            return date.toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
          }
          
          // Initialize the modal functionality
          initPatientModal();
        });

  </script>


<!-- Search Functionality -->
<script>

    // DOM Elements
    const searchInput = document.getElementById('searchInput');

    // Event Listeners
    searchInput.addEventListener('input', (e) => {
        searchTerm = e.target.value;
        const rows = document.querySelectorAll('#patientTableBody tr');
        rows.forEach(row => {
            const patientName = row.querySelector('[data-patient]').getAttribute('data-patient').toLowerCase();
            if (patientName.includes(searchTerm.toLowerCase())) {
            row.style.display = '';
            } else {
            row.style.display = 'none';
            }
        });
    });

</script>

<script>

    dashboard_nav_all = document.querySelectorAll('.ViewPatients-nav a');
    dashboard_nav_all.forEach((nav) => {
        nav_innertab =
            nav.classList.add('border-l-4', 'border-blue-500', 'bg-blue-50', 'rounded');
    });
</script>


{% endblock scripts %}