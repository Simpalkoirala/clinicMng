{% extends "pages/management/M_base.html" %}
{% load choose_color %}
{% load static %}

{% block titles %} Prescription Management || Nepal's Care {% endblock titles %}

{% block styles %}

{% endblock styles %}


{% block pageof %} Prescriptions View-Add-Edit {% endblock pageof %}
{% block linkPageof %} {% url 'management:prescriptionsMng' %} {% endblock linkPageof %}

{% block content %}

    <div class="flex h-screen overflow-hidden">
        <!-- Main Content -->
        <div class="flex-1 overflow-y-auto">
            <div class="p-6 lg:p-10 w-full">
                
                <div class="mb-6 bg-white rounded-xl p-6 shadow-sm">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                        <div class="mb-4 md:mb-0">
                            <h2 class="text-3xl font-bold text-gray-800">Prescriptions Management</h2>
                            <p class="text-gray-600 max-w-2xl">Manage all prescriptions, add new ones, and view or edit existing prescriptions with ease.</p>
                        </div>
                        <button id="add-prescription-trigger" class="flex items-center justify-center px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            <span class="font-medium">Add New Prescription</span>
                        </button>
                    </div>
                </div>

                <!-- Prescriptions List -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Medication</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Prescribed By</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Prescribed To</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Duration</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Status</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody id="patientTableBody" class="divide-y divide-gray-200">
                                {% for each_precp in prescriptions %}
                                    <tr class="hover:bg-gray-50 transition-all duration-200">
                                        <!-- Medication Name -->
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0 h-10 w-10 flex items-center justify-center bg-blue-100 rounded-full">
                                                    <svg class="h-5 w-5 text-blue-600" fill="currentcolor" viewBox='0 0 24 24' 
                                                        xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>
                    
                                                        <g transform="matrix(0.83 0 0 0.83 12 12)" >
                                                        <path style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4;  fill-rule: nonzero; opacity: 1;" transform=" translate(-15, -14.98)" d="M 19.636719 3.0058594 C 17.749977 3.0058594 15.863309 3.7226272 14.429688 5.15625 L 5.15625 14.429688 C 2.2890045 17.296932 2.2890045 21.976504 5.15625 24.84375 C 5.249623121478076 24.936806155451993 5.360472242339778 25.010484350463443 5.4824219 25.060547 C 5.484372985183456 25.061204029240233 5.4863260944944106 25.06185503234373 5.4882812 25.0625 C 8.3730664 27.643444 12.800719 27.613345 15.570312 24.84375 L 24.84375 15.570312 C 27.710996 12.703067 27.710996 8.0234955 24.84375 5.15625 C 23.410126 3.7225802 21.523461 3.0058594 19.636719 3.0058594 z M 19.636719 4.9941406 C 21.007477 4.9941406 22.37831 5.5189353 23.429688 6.5703125 C 25.532442 8.673067 25.532442 12.053496 23.429688 14.15625 L 21.292969 16.292969 L 19.5 18.085938 C 19.109 18.476937 18.477891 18.477891 18.087891 18.087891 C 16.762891 16.761891 14.033203 14.03125 14.033203 14.03125 L 14.03125 14.03125 C 13.2502359867062 13.250402811482466 11.984139013293799 13.250402811482466 11.203125 14.031250000000002 L 8.0117188 17.226562 C 7.6207187 17.617562 6.9876562 17.617562 6.5976562 17.226562 C 6.2101235 16.83903 6.209184 16.214994 6.5898438 15.824219 L 15.84375 6.5703125 C 16.895127 5.5189353 18.265961 4.9941406 19.636719 4.9941406 z" stroke-linecap="round" />
                                                        </g>
                                                    </svg>
                                                </div>
                                                <div class="ml-4">
                                                    <div class="text-sm font-medium text-gray-900">{{each_precp.medicine.name}}</div>
                                                </div>
                                            </div>
                                        </td>

                                        <!-- Prescribed By -->
                                        <td class="table-cell px-4 py-4 whitespace-nowrap doctor-details"
                                            title="View Profile" data-patient="{{ each_precp.prescribing_doctor.profile.user.first_name }}" >
                                            <a class="bg-indigo-600 hover:bg-indigo-800">
                                                <div class="flex items-center">
                                                    <div class="flex-shrink-0 h-10 w-10">
                                                        <img class="h-10 w-10 rounded-full object-cover shadow-sm border border-gray-200 transition-transform duration-200 hover:scale-110"
                                                            src="{{ each_precp.prescribing_doctor.profile.profile_pic.url }}"
                                                            alt="{{ each_precp.prescribing_doctor.profile.user.first_name}}">
                                                    </div>
                                                    <div class="ml-4">
                                                        <p class="text-sm font-medium text-gray-900" data-doctor="{{ each_precp.prescribing_doctor.profile.user.first_name }}"  >{{ each_precp.prescribing_doctor.profile.user.first_name }}
                                                        </p>
                                                        <div class="text-sm text-gray-500" data-specialization='{{ each_precp.prescribing_doctor.profile.user.username }}' >{{ each_precp.prescribing_doctor.profile.user.username }}</div>
                                                    </div>
                                                </div>
                                            </a>
                                        </td>

                                        <!-- Prescribed To -->
                                        <td class="table-cell px-4 py-4 whitespace-nowrap doctor-details"
                                        title="View Profile" data-patient="{{ each_precp.profile.user.first_name }}" >
                                        <a href="/view-patients-records/{{each_precp.profile.user.username}}" target="_blank_" class="bg-indigo-600 hover:bg-indigo-800">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0 h-10 w-10">
                                                    <img class="h-10 w-10 rounded-full object-cover shadow-sm border border-gray-200 transition-transform duration-200 hover:scale-110"
                                                        src="{{ each_precp.profile.profile_pic.url }}"
                                                        alt="{{ each_precp.profile.user.first_name}}">
                                                </div>
                                                <div class="ml-4">
                                                    <p class="text-sm font-medium text-gray-900" data-doctor="{{ each_precp.profile.user.first_name }}"  >{{ each_precp.profile.user.first_name }}
                                                    </p>
                                                    <div class="text-sm text-gray-500" data-specialization='{{ each_precp.profile.user.username }}' >{{ each_precp.profile.user.username }}</div>
                                                </div>
                                            </div>
                                        </a>
                                        </td>

                                        <!-- Date Start to End -->
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm text-gray-900">
                                                <div class="flex items-center">
                                                    <svg id='Calendar_24' class="h-4 w-4 mr-1 text-gray-500" fill="currentcolor" viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>
                                                        <g transform="matrix(1 0 0 1 12 12)" >
                                                        <path style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -11)" d="M 6 1 L 6 3 L 5 3 C 3.9 3 3 3.9 3 5 L 3 19 C 3 20.1 3.9 21 5 21 L 19 21 C 20.1 21 21 20.1 21 19 L 21 5 C 21 3.9 20.1 3 19 3 L 18 3 L 18 1 L 16 1 L 16 3 L 8 3 L 8 1 L 6 1 z M 5 8 L 19 8 L 19 19 L 5 19 L 5 8 z" stroke-linecap="round" />
                                                        </g>
                                                    </svg>
                                                    <span>{{ each_precp.start_date}}</span>
                                                </div>
                                                <div class="flex items-center">
                                                    <svg id='Calendar_24' class="h-4 w-4 mr-1 text-gray-500" fill="currentcolor" viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>
                                                        <g transform="matrix(1 0 0 1 12 12)" >
                                                        <path style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -11)" d="M 6 1 L 6 3 L 5 3 C 3.9 3 3 3.9 3 5 L 3 19 C 3 20.1 3.9 21 5 21 L 19 21 C 20.1 21 21 20.1 21 19 L 21 5 C 21 3.9 20.1 3 19 3 L 18 3 L 18 1 L 16 1 L 16 3 L 8 3 L 8 1 L 6 1 z M 5 8 L 19 8 L 19 19 L 5 19 L 5 8 z" stroke-linecap="round" />
                                                        </g>
                                                    </svg>
                                                    <span>{{ each_precp.end_date }}</span>
                                                </div>
                                            </div>
                                        </td>

                                        <!-- Status -->
                                        <td class="px-6 py-4 whitespace-nowrap ">
                                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium {% get_prescription_status_color each_precp.status %}">
                                                {{ each_precp.status|capfirst }}
                                            </span> 
                                        </td>

                                        <!-- Actions Btns -->
                                        <td class="px-4 py-4 whitespace-nowrap">
                                            <div class="flex space-x-2">
                                                <button class="bg-blue-500 text-white px-3 py-1 rounded prescription-modal-trigger" data-uuid="{{ each_precp.uuid }}">
                                                View/Edit
                                                </button>
                                                <a href="/m/prescriptions/delete/{{each_precp.uuid}}/" class="bg-red-500 text-white px-3 py-1 rounded">
                                                Delete
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr class="col-span-full text-gray-500">
                                        <td>
                                            No Prescriptions found.
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination and Show Entries -->
                <div class="bg-white border-t border-gray-200 rounded-b-lg">
                    <div class="flex flex-col lg:flex-row items-center justify-between py-4 px-4 md:px-6 space-y-4 lg:space-y-0">
                
                    <!-- Show Entries Selector -->
                    <form method="get" class="flex items-center space-x-3 w-full lg:w-auto" id="perPageForm">
                        <span class="text-gray-600 text-sm whitespace-nowrap">Show entries</span>
                        <div class="relative">
                        <select name="per_page" onchange="document.getElementById('perPageForm').submit()"
                                class="appearance-none pl-4 pr-10 py-2 border border-gray-300 bg-white rounded-full text-sm font-medium text-gray-700 shadow-sm hover:border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-200 cursor-pointer">
                            {% for n in per_page_options %}
                            <option value="{{ n }}" {% if per_page == n %}selected{% endif %}>{{ n }}</option>
                            {% endfor %}
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-indigo-500">
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                    d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                    clip-rule="evenodd"/>
                            </svg>
                        </div>
                        </div>
                        {# preserve current page when changing per_page #}
                        <input type="hidden" name="page" value="{{ appointments.number }}">
                    </form>
                
                    <!-- Results Counter -->
                    <div class="hidden sm:block text-center lg:text-left text-sm text-gray-500">
                        Showing
                        <span class="font-semibold text-gray-700">
                        {{ appointments.start_index }}
                        </span>
                        to
                        <span class="font-semibold text-gray-700">
                        {{ appointments.end_index }}
                        </span>
                        of
                        <span class="font-semibold text-gray-700">
                        {{ paginator.count }}
                        </span>
                        results
                    </div>
                
                    <!-- Pagination Navigation -->
                    <div class="w-full lg:w-auto flex justify-center lg:justify-end">
                        <nav class="relative z-0 inline-flex shadow-sm -space-x-px rounded-md" aria-label="Pagination">
                
                        {# Previous #}
                        {% if appointments.has_previous %}
                            <a href="?page={{ appointments.previous_page_number }}&per_page={{ per_page }}"
                            class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition duration-150">
                            <span class="sr-only">Previous</span>
                            <!-- ← -->
                            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 
                                        01-1.414 1.414l-4-4a1 1 0 
                                        010-1.414l4-4a1 1 0 011.414 0z"
                                    clip-rule="evenodd"/>
                            </svg>
                            </a>
                        {% else %}
                            <span class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-400 cursor-not-allowed disabled:opacity-50">
                            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 
                                        01-1.414 1.414l-4-4a1 1 0 
                                        010-1.414l4-4a1 1 0 011.414 0z"
                                    clip-rule="evenodd"/>
                            </svg>
                            </span>
                        {% endif %}
                
                        {# Page Numbers #}
                        {% for num in paginator.page_range %}
                            {% if num >= appointments.number|add:-2 and num <= appointments.number|add:2 %}
                            {% if num == appointments.number %}
                                <span aria-current="page"
                                    class="relative inline-flex items-center px-4 py-2 border border-indigo-500 bg-indigo-50 text-sm font-medium text-indigo-600">
                                {{ num }}
                                </span>
                            {% else %}
                                <a href="?page={{ num }}&per_page={{ per_page }}"
                                class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition duration-150">
                                {{ num }}
                                </a>
                            {% endif %}
                            {% elif num == 1 or num == paginator.num_pages %}
                            <!-- always show first and last -->
                            <a href="?page={{ num }}&per_page={{ per_page }}"
                                class="relative inline-flex hidden md:inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition duration-150">
                                {{ num }}
                            </a>
                            {% elif num == appointments.number|add:-3 or num == appointments.number|add:3 %}
                            <span class="relative inline-flex hidden md:inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                                …
                            </span>
                            {% endif %}
                        {% endfor %}
                
                        {# Next #}
                        {% if appointments.has_next %}
                            <a href="?page={{ appointments.next_page_number }}&per_page={{ per_page }}"
                            class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition duration-150">
                            <span class="sr-only">Next</span>
                            <!-- → -->
                            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M7.293 14.707a1 1 0 
                                        010-1.414L10.586 10 7.293 6.707a1 1 0 
                                        011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 
                                        01-1.414 0z"
                                    clip-rule="evenodd"/>
                            </svg>
                            </a>
                        {% else %}
                            <span class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-400 cursor-not-allowed disabled:opacity-50">
                            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M7.293 14.707a1 1 0 
                                        010-1.414L10.586 10 7.293 6.707a1 1 0 
                                        011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 
                                        01-1.414 0z"
                                    clip-rule="evenodd"/>
                            </svg>
                            </span>
                        {% endif %}
                
                        </nav>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Add Prescription Modal Background Overlay -->
    <div id="add-prescription-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center transition-opacity duration-300 ease-in-out opacity-0">
        <!-- Modal Container -->
        <div id="add-prescription-modal" class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-4xl w-full mx-4 md:mx-auto max-h-[90vh] overflow-hidden flex flex-col transform transition-all duration-300 ease-in-out scale-95 opacity-0">
        <!-- Modal Header -->
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
            <h3 class="text-lg md:text-xl font-bold flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Add New Prescription</span>
            </h3>
            
            <button id="close-add-modal" class="bg-white bg-opacity-20 hover:bg-opacity-30 p-1.5 rounded-lg transition-all duration-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
            </button>
        </div>
        
        <!-- Modal Content -->
        <div class="flex-1 overflow-y-auto p-6">
            <form id="add-prescription-form" method="post" action="{% url 'management:add_prescription' %}">
            {% csrf_token %}
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Left Column -->
                <div>
                <!-- Patient Selection -->
                <div class="mb-6">
                    <label for="patient" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Patient <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                    <select id="patient" name="patient_username" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" required>
                        <option value="">-- Select Patient --</option>
                        <!-- Options will be populated from DataInfo using JavaScript -->
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    </div>
                </div>
                
                <!-- Doctor Selection -->
                <div class="mb-6">
                    <label for="doctor" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Prescribing Doctor <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                    <select id="doctor" name="doctor_username" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" required>
                        <option value="">-- Select Doctor --</option>
                        <!-- Options will be populated from DataInfo using JavaScript -->
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    </div>
                </div>
                
                <!-- Medicine Selection -->
                <div class="mb-6">
                    <label for="medicine" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Medicine <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                    <select id="medicine" name="medicine_uuid" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" required>
                        <option value="">-- Select Medicine --</option>
                        <!-- Options will be populated from DataInfo using JavaScript -->
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    </div>
                </div>
                
                <!-- Status Selection -->
                <div class="mb-6">
                    <label for="status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Status <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                    <select id="status" name="status" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" required>
                        <option value="active">Active</option>
                        <option value="completed">Completed</option>
                        <option value="discontinued">Discontinued</option>
                        <option value="break">In Break</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    </div>
                </div>
                </div>
                
                <!-- Right Column -->
                <div>
                <!-- Dosage and Frequency -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                    <div>
                    <label for="dosage" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Dosage <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="dosage" name="update_dosage" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., 500mg" required>
                    <p class="mt-1 text-xs text-gray-500">e.g. "10mg", "500mg"</p>
                    </div>
                    <div>
                    <label for="frequency" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Frequency <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="frequency" name="update_frequency" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., Three times daily" required>
                    <p class="mt-1 text-xs text-gray-500">e.g. "Once daily", "Three times daily"</p>
                    </div>
                </div>
                
                <!-- Start and End Dates -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                    <div>
                    <label for="start_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Start Date <span class="text-red-500">*</span>
                    </label>
                    <input type="date" id="start_date" name="start_date" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                    </div>
                    <div>
                    <label for="end_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        End Date <span class="text-red-500">*</span>
                    </label>
                    <input type="date" id="end_date" name="end_date" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                    </div>
                </div>
                
                <!-- Notes -->
                <div class="mb-6">
                    <label for="notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Notes
                    </label>
                    <textarea id="notes" name="notes" rows="4" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Additional notes or instructions for the medication"></textarea>
                </div>
                </div>
            </div>
            
            <!-- Medication Schedule -->
            <div class="mt-2 mb-6">
                <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-3">Medication Schedule</h4>
                
                <div id="schedule-items" class="space-y-2 mb-4">
                <!-- Schedule items will be added here dynamically -->
                </div>
                
                <div class="flex items-center space-x-2">
                <input type="time" id="new-time" class="flex-1 max-w-xs px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                <button type="button" id="add-time-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                    Add Time
                </button>
                </div>
                
                <!-- Hidden input to store schedule times -->
                <input type="hidden" id="schedule-times" name="schedule_times" value="">
            </div>
            
            <!-- Submit Button -->
            <div class="flex justify-end mt-8">
                <button type="button" id="cancel-add-btn" class="mr-3 px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Cancel
                </button>
                <button type="submit" class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 flex items-center">
                <span>Create Prescription</span>
                <svg id="submit-spinner" class="animate-spin ml-2 h-4 w-4 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                </button>
            </div>
            </form>
        </div>
        </div>
    </div>


    <!-- Prescription Modal Background Overlay -->
    <div id="prescription-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center transition-opacity duration-300 ease-in-out opacity-0">
        <!-- Modal Container -->
        <div id="prescription-modal" class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-4xl w-full mx-4 md:mx-auto max-h-[90vh] overflow-hidden flex flex-col transform transition-all duration-300 ease-in-out scale-95 opacity-0">
        <!-- Modal Header -->
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
            <h3 class="text-lg md:text-xl font-bold flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <span id="modal-title">Prescription Details</span>
            </h3>
            
            <!-- Mode Indicators and Controls -->
            <div class="flex items-center space-x-2">
            <span id="mode-indicator" class="hidden md:inline-block text-sm font-medium bg-white bg-opacity-20 px-2 py-1 rounded">View Mode</span>
            <button id="edit-mode-toggle" class="bg-white bg-opacity-20 hover:bg-opacity-30 p-1.5 rounded-lg transition-all duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                </svg>
            </button>
            <button id="close-modal" class="bg-white bg-opacity-20 hover:bg-opacity-30 p-1.5 rounded-lg transition-all duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            </div>
        </div>
        
        <!-- Modal Content -->
        <div id="modal-content" class="flex-1 overflow-y-auto p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Left Column - Patient & Doctor Info -->
            <div class="md:col-span-1">
                <!-- Patient Info -->
                <div class="bg-white dark:bg-gray-700 rounded-lg shadow p-4 mb-4">
                <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    Patient
                </h4>
                <div class="flex items-center mb-2">
                    <div class="flex-shrink-0">
                    <img id="patient-profile-pic" src="" alt="Patient" class="h-12 w-12 rounded-full object-cover border-2 border-blue-500">
                    </div>
                    <div class="ml-3">
                    <p id="patient-name" class="font-medium text-gray-800 dark:text-white"></p>
                    <p id="patient-username" class="text-sm text-gray-500 dark:text-gray-300"></p>
                    </div>
                </div>
                </div>
                
                <!-- Doctor Info -->
                <div class="bg-white dark:bg-gray-700 rounded-lg shadow p-4">
                <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    Prescribing Doctor
                </h4>
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                    <img id="doctor-profile-pic" src="" alt="Doctor" class="h-12 w-12 rounded-full object-cover border-2 border-indigo-500">
                    </div>
                    <div class="ml-3">
                    <p id="doctor-name" class="font-medium text-gray-800 dark:text-white"></p>
                    <p id="doctor-username" class="text-sm text-gray-500 dark:text-gray-300"></p>
                    </div>
                </div>
                </div>
            </div>
            
            <!-- Middle Column - Prescription Details -->
            <div class="md:col-span-2">
                <!-- Status and Dates -->
                <div class="bg-white dark:bg-gray-700 rounded-lg shadow p-4 mb-4">
                <div class="flex flex-wrap justify-between items-center mb-3">
                    <h4 class="text-lg font-semibold text-gray-800 dark:text-white">Prescription Status</h4>
                    
                    <!-- Status - View Mode -->
                    <div id="status-badge" class="view-mode-element px-3 py-1 rounded-full text-sm font-medium"></div>
                    
                    <!-- Status - Edit Mode -->
                    <div class="edit-mode-element" style="display: none;">
                    <select id="status-select" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200">
                        <option value="active">Active</option>
                        <option value="completed">Completed</option>
                        <option value="discontinued">Discontinued</option>
                        <option value="break">In Break</option>
                    </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Start Date</label>
                    <div id="start-date" class="view-mode-element mt-1 text-gray-800 dark:text-white"></div>
                    <input type="date" id="start-date-input" class="edit-mode-element mt-1 w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200" style="display: none;">
                    </div>
                    <div>
                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">End Date</label>
                    <div id="end-date" class="view-mode-element mt-1 text-gray-800 dark:text-white"></div>
                    <input type="date" id="end-date-input" class="edit-mode-element mt-1 w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200" style="display: none;">
                    </div>
                </div>
                </div>
                
                <!-- Medicine Details -->
                <div class="bg-white dark:bg-gray-700 rounded-lg shadow p-4 mb-4">
                <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-3 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                    </svg>
                    Medicine Information
                </h4>
                
                <div class="space-y-3">
                    <div>
                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Medicine Name</label>
                    <div id="medicine-name" class="mt-1 font-medium text-gray-800 dark:text-white"></div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Generic Name</label>
                        <div id="generic-name" class="mt-1 text-gray-800 dark:text-white"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Brand Name</label>
                        <div id="brand-name" class="mt-1 text-gray-800 dark:text-white"></div>
                    </div>
                    </div>
                    
                    <div>
                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Manufacturer</label>
                    <div id="manufacturer" class="mt-1 text-gray-800 dark:text-white"></div>
                    </div>
                </div>
                </div>
                
                <!-- Dosage Information -->
                <div class="bg-white dark:bg-gray-700 rounded-lg shadow p-4 mb-4">
                <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-3 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Dosage Information
                </h4>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-3">
                    <div>
                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Dosage</label>
                    <div id="dosage" class="view-mode-element mt-1 text-gray-800 dark:text-white"></div>
                    <input type="text" id="dosage-input" class="edit-mode-element mt-1 w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200" style="display: none;" placeholder="e.g. 500mg">
                    </div>
                    <div>
                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Frequency</label>
                    <div id="frequency" class="view-mode-element mt-1 text-gray-800 dark:text-white"></div>
                    <input type="text" id="frequency-input" class="edit-mode-element mt-1 w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200" style="display: none;" placeholder="e.g. Three times daily">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Notes</label>
                    <div id="notes" class="view-mode-element mt-1 text-gray-800 dark:text-white whitespace-pre-line"></div>
                    <textarea id="notes-input" rows="3" class="edit-mode-element mt-1 w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200" style="display: none;" placeholder="Additional notes or instructions"></textarea>
                </div>
                </div>
                
                <!-- Schedule -->
                <div class="bg-white dark:bg-gray-700 rounded-lg shadow p-4">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Medication Schedule
                    </h4>
                </div>
                
                <div id="schedule-container" class="space-y-2">
                    <!-- Schedule items will be populated here -->
                    <div id="no-schedule" class="text-center py-4 text-gray-500 dark:text-gray-400 italic hidden">
                    No schedule times available
                    </div>
                </div>
                
                <!-- Edit Mode: Add Time -->
                <div id="add-schedule-container" class="mt-4 edit-mode-element" style="display: none;">
                    <div class="flex items-center space-x-2">
                    <input type="time" id="new-schedule-time" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200">
                    <button id="add-schedule-btn" class="px-3 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                        Add Time
                    </button>
                    </div>
                </div>
                </div>
            </div>
            </div>
            
            <!-- Medicine Details (Expandable) -->
            <div class="mt-6">
            <button id="toggle-additional-info" class="w-full flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-3 rounded-lg text-left">
                <span class="font-medium text-gray-800 dark:text-white">Additional Medicine Information</span>
                <svg id="toggle-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </button>
            
            <div id="additional-info-content" class="bg-white dark:bg-gray-700 rounded-b-lg shadow p-4 mt-1 hidden">
                <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Description</label>
                    <div id="medicine-description" class="mt-1 text-gray-800 dark:text-white whitespace-pre-line"></div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Instructions</label>
                    <div id="medicine-instructions" class="mt-1 text-gray-800 dark:text-white whitespace-pre-line"></div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Side Effects</label>
                    <div id="medicine-side-effects" class="mt-1 text-gray-800 dark:text-white whitespace-pre-line"></div>
                </div>
                </div>
            </div>
            </div>
        </div>
        
        <!-- Modal Footer (for Edit Mode) -->
        <div id="modal-footer" class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 edit-mode-element" style="display: none;">
            <div class="flex justify-end space-x-3">
            <button id="cancel-edit-btn" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors">
                Cancel
            </button>
            <button id="save-edit-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors flex items-center">
                <span>Save Changes</span>
                <svg id="save-spinner" class="animate-spin ml-2 h-4 w-4 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
            </div>
        </div>
        </div>
    </div>

{% endblock content %}


{% block scripts %}

<script>

    window.DataInfo = {
        patient:[
            {% for eachP in all_patients %}
            {
                name: "{{ eachP.user.first_name }}",
                username: "{{ eachP.user.username }}",
            },
            {% endfor %}
        ],
        doctors:[
            {% for eachD in all_doctors %}
            {
                username: "{{ eachD.profile.user.username }}",
                name: "Dr. {{ eachD.profile.user.first_name }}",
                specialty: "{{ eachD.specialization }}"
            },
            {% endfor %}
        ],

        medicines:[
            {% for eachM in all_medicines %}
            {
                uuid: "{{ eachM.uuid }}",
                name: "{{ eachM.name }}",
                generic_name: "{{ eachM.generic_name }}",
                brand_name: "{{ eachM.brand_name }}",
            },
            {% endfor %}
        ],
    }


    document.addEventListener('DOMContentLoaded', function() {
        // DOM Elements
        const addModalTriggers = document.getElementById('add-prescription-trigger');
        const addModalOverlay = document.getElementById('add-prescription-modal-overlay');
        const addModal = document.getElementById('add-prescription-modal');
        const closeAddModalBtn = document.getElementById('close-add-modal');
        const cancelAddBtn = document.getElementById('cancel-add-btn');
        const addPrescriptionForm = document.getElementById('add-prescription-form');
        const submitSpinner = document.getElementById('submit-spinner');
        
        // Dropdown elements
        const patientSelect = document.getElementById('patient');
        const doctorSelect = document.getElementById('doctor');
        const medicineSelect = document.getElementById('medicine');
        
        // Schedule management
        const addTimeBtn = document.getElementById('add-time-btn');
        const newTimeInput = document.getElementById('new-time');
        const scheduleItemsContainer = document.getElementById('schedule-items');
        const scheduleTimesInput = document.getElementById('schedule-times');
        
        // Start and end date fields
        const startDateInput = document.getElementById('start_date');
        const endDateInput = document.getElementById('end_date');
        
        // Schedule times array
        let scheduleTimes = [];
        
        // Initialize dropdown options using window.DataInfo
        initializeDropdowns();
        
        // Set default dates if inputs exist
        if (startDateInput) {
            // If no value is set already, set to today
            if (!startDateInput.value) {
                const today = new Date();
                startDateInput.value = formatDateForInput(today);
            }
            
            // Set default end date to 30 days from start date if empty
            startDateInput.addEventListener('change', function() {
                if (!endDateInput.value) {
                    const startDate = new Date(startDateInput.value);
                    const endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 30);
                    endDateInput.value = formatDateForInput(endDate);
                }
            });
            
            // Trigger change event to set initial end date if needed
            if (!endDateInput.value) {
                startDateInput.dispatchEvent(new Event('change'));
            }
        }
        
        // ---- Event Listeners ----
        
        // Open modal when clicking add prescription buttons
        addModalTriggers.addEventListener('click', openAddModal);
        
        // Close modal when clicking the close button or cancel button
        closeAddModalBtn.addEventListener('click', closeAddModal);
        cancelAddBtn.addEventListener('click', closeAddModal);
        
        // Close modal when clicking outside
        addModalOverlay.addEventListener('click', function(e) {
            if (e.target === addModalOverlay) {
                closeAddModal();
            }
        });
        
        // Add time button
        if (addTimeBtn) {
            addTimeBtn.addEventListener('click', addScheduleTime);
        }
        
        // Form submission
        if (addPrescriptionForm) {
            addPrescriptionForm.addEventListener('submit', function(e) {
                e.preventDefault(); // Prevent default form submission
                
                // Validate form fields
                if (!validateForm()) {
                    return false;
                }
                
                // Update the hidden input with schedule times
                updateScheduleTimesInput();
                
                // Show spinner
                submitSpinner.classList.remove('hidden');
                
                // Submit the form programmatically
                this.submit();
                
                return true;
            });
        }
        
        // ---- Functions ----
        
        /**
         * Initialize dropdown options using window.DataInfo
         */
        function initializeDropdowns() {
            // Check if DataInfo exists
            if (!window.DataInfo) {
                console.error('DataInfo not found');
                return;
            }
            
            // Populate Patient dropdown
            if (patientSelect && window.DataInfo.patient) {
                // Clear existing options except the first one (placeholder)
                while (patientSelect.options.length > 1) {
                    patientSelect.remove(1);
                }
                
                // Add new options
                window.DataInfo.patient.forEach(patient => {
                    const option = document.createElement('option');
                    option.value = patient.username;
                    option.textContent = `${patient.name} (@${patient.username})`;
                    patientSelect.appendChild(option);
                });
            }
            
            // Populate Doctor dropdown
            if (doctorSelect && window.DataInfo.doctors) {
                // Clear existing options except the first one (placeholder)
                while (doctorSelect.options.length > 1) {
                    doctorSelect.remove(1);
                }
                
                // Add new options
                window.DataInfo.doctors.forEach(doctor => {
                    const option = document.createElement('option');
                    option.value = doctor.username;
                    option.textContent = `${doctor.name} (${doctor.specialty})`;
                    doctorSelect.appendChild(option);
                });
            }
            
            // Populate Medicine dropdown
            if (medicineSelect && window.DataInfo.medicines) {
                // Clear existing options except the first one (placeholder)
                while (medicineSelect.options.length > 1) {
                    medicineSelect.remove(1);
                }
                
                // Add new options
                window.DataInfo.medicines.forEach(medicine => {
                    const option = document.createElement('option');
                    option.value = medicine.uuid;
                    option.textContent = `${medicine.name} (${medicine.generic_name})`;
                    medicineSelect.appendChild(option);
                });
            }
        }
        
        /**
         * Validate the form fields
         * @returns {boolean} Whether the form is valid
         */
        function validateForm() {
            let isValid = true;
            let firstInvalidField = null;
            
            // Required fields
            const requiredFields = [
                { field: patientSelect, name: 'Patient' },
                { field: doctorSelect, name: 'Doctor' },
                { field: medicineSelect, name: 'Medicine' },
                { field: document.getElementById('dosage'), name: 'Dosage' },
                { field: document.getElementById('frequency'), name: 'Frequency' },
                { field: startDateInput, name: 'Start Date' },
                { field: endDateInput, name: 'End Date' }
            ];
            
            // Check each required field
            requiredFields.forEach(item => {
                if (!item.field.value.trim()) {
                    isValid = false;
                    showFieldError(item.field, `${item.name} is required`);
                    if (!firstInvalidField) {
                        firstInvalidField = item.field;
                    }
                } else {
                    clearFieldError(item.field);
                }
            });
            
            // Validate dates
            if (startDateInput.value && endDateInput.value) {
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);
                
                if (startDate > endDate) {
                    isValid = false;
                    showFieldError(endDateInput, 'End date must be after start date');
                    if (!firstInvalidField) {
                        firstInvalidField = endDateInput;
                    }
                }
            }
            
            // Focus on the first invalid field
            if (firstInvalidField) {
                firstInvalidField.focus();
            }
            
            return isValid;
        }
        
        /**
         * Show an error message for a field
         * @param {HTMLElement} field - The field with the error
         * @param {string} message - The error message
         */
        function showFieldError(field, message) {
            // Clear any existing error
            clearFieldError(field);
            
            // Add error class to the field
            field.classList.add('border-red-500');
            
            // Create error message element
            const errorElement = document.createElement('p');
            errorElement.className = 'mt-1 text-sm text-red-600 field-error';
            errorElement.textContent = message;
            
            // Insert the error message after the field
            field.parentNode.insertBefore(errorElement, field.nextSibling);
        }
        
        /**
         * Clear error message for a field
         * @param {HTMLElement} field - The field to clear errors for
         */
        function clearFieldError(field) {
            // Remove error class
            field.classList.remove('border-red-500');
            
            // Remove any existing error messages
            const errorElements = field.parentNode.querySelectorAll('.field-error');
            errorElements.forEach(el => el.remove());
        }
        
        /**
         * Open the add prescription modal
         */
        function openAddModal() {
            // Reset form if it exists
            if (addPrescriptionForm) {
                addPrescriptionForm.reset();
                
                // Clear error messages
                document.querySelectorAll('.field-error').forEach(el => el.remove());
                document.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500'));
                
                // Clear schedule times
                scheduleTimes = [];
                updateScheduleUI();
                
                // Set default dates
                const today = new Date();
                if (startDateInput) {
                    startDateInput.value = formatDateForInput(today);
                }
                
                const defaultEndDate = new Date(today);
                defaultEndDate.setDate(today.getDate() + 30);
                if (endDateInput) {
                    endDateInput.value = formatDateForInput(defaultEndDate);
                }
            }
            
            // Show the modal with animation
            addModalOverlay.classList.remove('hidden');
            setTimeout(() => {
                addModalOverlay.classList.add('opacity-100');
                addModal.classList.add('opacity-100', 'scale-100');
                addModal.classList.remove('scale-95', 'opacity-0');
            }, 10);
            
            // Default focus on the first field
            if (patientSelect) {
                setTimeout(() => {
                    patientSelect.focus();
                }, 300);
            }
        }
        
        /**
         * Close the add prescription modal
         */
        function closeAddModal() {
            // Hide the modal with animation
            addModalOverlay.classList.remove('opacity-100');
            addModal.classList.remove('opacity-100', 'scale-100');
            addModal.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                addModalOverlay.classList.add('hidden');
            }, 300);
        }
        
        /**
         * Add a schedule time
         */
        function addScheduleTime() {
            const time = newTimeInput.value;
            
            if (!time) {
                showNotification({
                    color: "bg-red-500",
                    title: "Update Failed.",
                    message: 'Please select a time First.'
                  });

                return;
            }
            
            // Check if time already exists
            if (scheduleTimes.includes(time)) {
                showNotification({
                    color: "bg-red-500",
                    title: "Update Failed.",
                    message: 'This time is already in the schedule.'
                  });
                return;
            }
            
            // Add to schedule times array
            scheduleTimes.push(time);
            
            // Sort times
            scheduleTimes.sort();
            
            // Update UI
            updateScheduleUI();
            
            // Clear input
            newTimeInput.value = '';
        }
        
        /**
         * Update the schedule UI
         */
        function updateScheduleUI() {
            // Clear container
            scheduleItemsContainer.innerHTML = '';
            
            if (scheduleTimes.length === 0) {
                const emptyMessage = document.createElement('p');
                emptyMessage.className = 'text-gray-500 italic text-sm';
                emptyMessage.textContent = 'No schedule times added yet';
                scheduleItemsContainer.appendChild(emptyMessage);
                return;
            }
            
            // Add each time to the container
            scheduleTimes.forEach((time, index) => {
                const timeItem = document.createElement('div');
                timeItem.className = 'flex items-center justify-between bg-gray-50 dark:bg-gray-700 p-2 rounded-md';
                timeItem.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-8 h-8 flex items-center justify-center text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <span class="ml-2 text-gray-800 dark:text-white">${formatTimeForDisplay(time)}</span>
                    </div>
                    <button type="button" class="delete-time-btn text-red-500 hover:text-red-700 p-1" data-index="${index}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
                scheduleItemsContainer.appendChild(timeItem);
                
                // Add event listener to delete button
                const deleteBtn = timeItem.querySelector('.delete-time-btn');
                deleteBtn.addEventListener('click', function() {
                    removeScheduleTime(index);
                });
            });
            
            // Update hidden input
            updateScheduleTimesInput();
        }
        
        /**
         * Remove a schedule time
         * @param {number} index - The index of the time to remove
         */
        function removeScheduleTime(index) {
            if (index >= 0 && index < scheduleTimes.length) {
                scheduleTimes.splice(index, 1);
                updateScheduleUI();
                
            }
        }
        
        /**
         * Update the hidden input with schedule times
         */
        function updateScheduleTimesInput() {
            if (scheduleTimesInput) {
                scheduleTimesInput.value = JSON.stringify(scheduleTimes);
            }
        }
        
        /**
         * Format a date for the date input
         * @param {Date} date - The date to format
         * @returns {string} Formatted date (YYYY-MM-DD)
         */
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        /**
         * Format a time string for display
         * @param {string} timeStr - Time string (HH:MM)
         * @returns {string} Formatted time (12-hour format)
         */
        function formatTimeForDisplay(timeStr) {
            if (!timeStr) return '';
            
            const [hours, minutes] = timeStr.split(':');
            const hoursNum = parseInt(hours);
            const ampm = hoursNum >= 12 ? 'PM' : 'AM';
            const hours12 = hoursNum % 12 || 12;
            
            return `${hours12}:${minutes} ${ampm}`;
        }
        
        // Initialize on load
        initializeDropdowns();
    });

</script>




<script>
    window.PrecpData = [
        {% for each_precp in prescriptions %}
        {
            // Prescription UUID
            uuid: "{{ each_precp.uuid }}",

            // Prescribed To Info
            patient: {
                username: "{{ each_precp.profile.user.username }}",
                name: "{{ each_precp.profile.user.first_name }}",
                profile_pic: "{{ each_precp.profile.profile_pic.url }}",
            },

            // Prescribed To Info
            profile: {
                username: "{{ each_precp.profile.user.username }}",
                name: "{{ each_precp.profile.user.first_name }}",
                profile_pic: "{{ each_precp.profile.profile_pic.url }}",
            },

            // Prescribed By Info
            prescribing_doctor: {
                username: "{{ each_precp.prescribing_doctor.profile.user.username }}",
                name: "{{ each_precp.prescribing_doctor.profile.user.first_name }}",
                profile_pic: "{{ each_precp.prescribing_doctor.profile.profile_pic.url }}"
            },

            // Prescription Details
            medicine: {
                name: "{{ each_precp.medicine.name }}",
                uuid: "{{ each_precp.medicine.uuid }}",
                generic_name: "{{ each_precp.medicine.generic_name }}",
                brand_name: "{{ each_precp.medicine.brand_name }}",
                manufacturer: "{{ each_precp.medicine.manufacturer }}",
                description: `{{ each_precp.medicine.description }}`,
                instructions: `{{ each_precp.medicine.instructions }}`,
                side_effects: `{{ each_precp.medicine.side_effects }}`,
                created_at: "{{ each_precp.medicine.created_at }}",
                updated_at: "{{ each_precp.medicine.updated_at }}",
            },  

            // Prescription Details
            start_date: "{{ each_precp.start_date|date:'Y-m-d' }}",
            end_date: "{{ each_precp.end_date|date:'Y-m-d' }}",
            status: "{{ each_precp.status }}",

            update_dosage: "{{ each_precp.update_dosage }}",
            update_frequency: "{{ each_precp.update_frequency }}",
            notes: `{{ each_precp.notes }}`,


            prescription_schedule: [
                {% for each_sche in each_precp.timeschedule.all %}
                {
                    time: "{{ each_sche.time|date:'H:i'|default:'00:00' }}",
                    had_taken: "{{ each_sche.had_taken }}",
                },
                {% endfor %}
            ],
        },
        {% endfor %}
    ]

    /**
    * Prescription Modal
    * A vanilla JavaScript implementation for a responsive prescription details modal
    * with improved view and edit functionality.
    * Current date: 2025-06-27
    */

    document.addEventListener('DOMContentLoaded', function() {
        // DOM Elements
        const modalOverlay = document.getElementById('prescription-modal-overlay');
        const modal = document.getElementById('prescription-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const toggleAdditionalInfoBtn = document.getElementById('toggle-additional-info');
        const additionalInfoContent = document.getElementById('additional-info-content');
        const toggleIcon = document.getElementById('toggle-icon');
        const editModeToggle = document.getElementById('edit-mode-toggle');
        const modeIndicator = document.getElementById('mode-indicator');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const saveSpinner = document.getElementById('save-spinner');
        const modalFooter = document.getElementById('modal-footer');
        const addScheduleBtn = document.getElementById('add-schedule-btn');
        const newScheduleTime = document.getElementById('new-schedule-time');

        let time_schedule_changed = false; // Flag to track if schedule times have changed
        
        // Current prescription data and state
        let currentPrescription = null;
        let isEditMode = false;
        let tempScheduleItems = []; // For storing temporary schedule items in edit mode
        let originalData = null; // For storing original data to revert changes
        
        // Status badge color mapping
        const statusColors = {
            'active': 'bg-green-100 text-green-800',
            'completed': 'bg-blue-100 text-blue-800',
            'discontinued': 'bg-red-100 text-red-800',
            'break': 'bg-yellow-100 text-yellow-800'
        };
        
        // Status display names
        const statusDisplayNames = {
            'active': 'Active',
            'completed': 'Completed',
            'discontinued': 'Discontinued',
            'break': 'On Break'
        };
        
        // ---- Event Listeners ----
        
        // Close modal when clicking the close button or outside the modal
        closeModalBtn.addEventListener('click', function(e) {
            // If in edit mode with unsaved changes, confirm before closing
            if (isEditMode && hasUnsavedChanges()) {
                if (confirm('You have unsaved changes. Are you sure you want to close?')) {
                    closeModal();
                }
            } else {
                closeModal();
            }
        });
        
        modalOverlay.addEventListener('click', function(e) {
            if (e.target === modalOverlay) {
                // If in edit mode with unsaved changes, confirm before closing
                if (isEditMode && hasUnsavedChanges()) {
                    if (confirm('You have unsaved changes. Are you sure you want to close?')) {
                        closeModal();
                    }
                } else {
                    closeModal();
                }
            }
        });
        
        // Toggle additional information section
        toggleAdditionalInfoBtn.addEventListener('click', function() {
            additionalInfoContent.classList.toggle('hidden');
            toggleIcon.classList.toggle('rotate-180');
        });
        
        // Toggle edit mode
        editModeToggle.addEventListener('click', function() {
            if (isEditMode && hasUnsavedChanges()) {
                if (confirm('You have unsaved changes. Are you sure you want to exit edit mode?')) {
                    toggleEditMode(false);
                }
            } else {
                toggleEditMode(!isEditMode);
            }
        });
        
        // Cancel edit button
        cancelEditBtn.addEventListener('click', function() {
            if (hasUnsavedChanges()) {
                if (confirm('You have unsaved changes. Are you sure you want to cancel?')) {
                    revertChanges();
                    toggleEditMode(false);
                }
            } else {
                toggleEditMode(false);
            }
        });
        
        // Save changes button
        saveEditBtn.addEventListener('click', function() {
            saveChanges();
        });
        
        // Add schedule time button
        addScheduleBtn.addEventListener('click', function() {
            addScheduleTime();
        });
        
        // Delegate click events for schedule item actions (using event delegation)
        document.addEventListener('click', function(e) {
            // Delete schedule item button
            if (e.target.closest('.delete-schedule-btn')) {
                const scheduleItem = e.target.closest('.schedule-item');
                const timeIndex = parseInt(scheduleItem.dataset.index);
                deleteScheduleTime(timeIndex);
            }
            
            // Toggle had taken status
            if (e.target.closest('.toggle-had-taken') && isEditMode) {
                const scheduleItem = e.target.closest('.schedule-item');
                const timeIndex = parseInt(scheduleItem.dataset.index);
                toggleHadTaken(timeIndex);
            }
        });
        
        // Listen for trigger buttons throughout the page
        document.addEventListener('click', function(e) {
            if (e.target.closest('.prescription-modal-trigger')) {
                const trigger = e.target.closest('.prescription-modal-trigger');
                const uuid = trigger.dataset.uuid;
                if (uuid) {
                    openModal(uuid);
                }
            }
        });
        
        // ---- Functions ----
        
        /**
        * Check if there are unsaved changes in edit mode
        * @returns {boolean} True if there are unsaved changes
        */
        function hasUnsavedChanges() {
            if (!isEditMode || !originalData) return false;
            
            const startDate = document.getElementById('start-date-input').value;
            const endDate = document.getElementById('end-date-input').value;
            const dosage = document.getElementById('dosage-input').value;
            const frequency = document.getElementById('frequency-input').value;
            const notes = document.getElementById('notes-input').value;
            const status = document.getElementById('status-select').value;
            
            // Check if any of the fields are different from the original data
            if (startDate !== originalData.start_date) return true;
            if (endDate !== originalData.end_date) return true;
            if (dosage !== originalData.update_dosage) return true;
            if (frequency !== originalData.update_frequency) return true;
            if (notes !== originalData.notes) return true;
            if (status !== originalData.status) return true;
            
            // Check if schedule items have changed
            if (JSON.stringify(tempScheduleItems) !== JSON.stringify(originalData.schedule_items)) return true;
            
            return false;
        }
        
        /**
        * Revert changes to original data
        */
        function revertChanges() {
            if (!originalData) return;
            
            // Restore form fields to original values
            document.getElementById('start-date-input').value = new Date(originalData.start_date).toISOString().split('T')[0];
            document.getElementById('end-date-input').value = new Date(originalData.end_date).toISOString().split('T')[0];
            document.getElementById('dosage-input').value = originalData.update_dosage;
            document.getElementById('frequency-input').value = originalData.update_frequency;
            document.getElementById('notes-input').value = originalData.notes;
            document.getElementById('status-select').value = originalData.status;
            
            // Restore schedule items
            tempScheduleItems = JSON.parse(JSON.stringify(originalData.schedule_items));
            populateSchedule(tempScheduleItems);
        }
        
        /**
        * Open the modal and load prescription data
        * @param {string} uuid - The UUID of the prescription to display
        */
        function openModal(uuid) {
            // Find the prescription data from the global array
            const prescription = window.PrecpData.find(p => p.uuid === uuid);
            
            if (!prescription) {
                console.error('Prescription not found:', uuid);
                return;
            }
            
            // Store the current prescription data
            currentPrescription = prescription;
            
            // Reset edit mode
            toggleEditMode(false);
            
            // Populate the modal with prescription data
            populateModalData(prescription);
            
            // Show the modal with animation
            modalOverlay.classList.remove('hidden');
            setTimeout(() => {
                modalOverlay.classList.add('opacity-100');
                modal.classList.add('opacity-100', 'scale-100');
                modal.classList.remove('scale-95', 'opacity-0');
            }, 10);
            
            // Show edit button
            editModeToggle.style.display = '';
        }
        
        /**
        * Close the modal with animation
        */
        function closeModal() {
            // Hide the modal with animation
            modalOverlay.classList.remove('opacity-100');
            modal.classList.remove('opacity-100', 'scale-100');
            modal.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modalOverlay.classList.add('hidden');
                // Clear current prescription data
                currentPrescription = null;
                originalData = null;
            }, 300);
        }
        
        /**
        * Populate the modal with prescription data
        * @param {Object} prescription - The prescription data object
        */
        function populateModalData(prescription) {
            // Patient info
            document.getElementById('patient-name').textContent = prescription.patient.name;
            document.getElementById('patient-username').textContent = '@' + prescription.patient.username;
            document.getElementById('patient-profile-pic').src = prescription.patient.profile_pic;
            
            // Doctor info
            document.getElementById('doctor-name').textContent = prescription.prescribing_doctor.name;
            document.getElementById('doctor-username').textContent = '@' + prescription.prescribing_doctor.username;
            document.getElementById('doctor-profile-pic').src = prescription.prescribing_doctor.profile_pic;
            
            // Status and dates
            const statusBadge = document.getElementById('status-badge');
            statusBadge.textContent = statusDisplayNames[prescription.status] || prescription.status;
            statusBadge.className = 'view-mode-element px-3 py-1 rounded-full text-sm font-medium ' + (statusColors[prescription.status] || 'bg-gray-100 text-gray-800');
            
            document.getElementById('start-date').textContent = formatDate(prescription.start_date);
            document.getElementById('end-date').textContent = formatDate(prescription.end_date);
            
            // Form inputs (for edit mode)
            document.getElementById('status-select').value = prescription.status;
            document.getElementById('start-date-input').value = prescription.start_date;
            document.getElementById('end-date-input').value = prescription.end_date;
            
            // Medicine info
            document.getElementById('medicine-name').textContent = prescription.medicine.name;
            document.getElementById('generic-name').textContent = prescription.medicine.generic_name;
            document.getElementById('brand-name').textContent = prescription.medicine.brand_name;
            document.getElementById('manufacturer').textContent = prescription.medicine.manufacturer;
            
            // Additional medicine info
            document.getElementById('medicine-description').textContent = prescription.medicine.description;
            document.getElementById('medicine-instructions').textContent = prescription.medicine.instructions;
            document.getElementById('medicine-side-effects').textContent = prescription.medicine.side_effects;
            
            // Dosage info
            document.getElementById('dosage').textContent = prescription.update_dosage;
            document.getElementById('frequency').textContent = prescription.update_frequency;
            document.getElementById('notes').textContent = prescription.notes;
            
            // Form inputs (for edit mode)
            document.getElementById('dosage-input').value = prescription.update_dosage;
            document.getElementById('frequency-input').value = prescription.update_frequency;
            document.getElementById('notes-input').value = prescription.notes;
            
            // Schedule
            populateSchedule(prescription.prescription_schedule);
            
            // Store original data for reverting changes
            originalData = {
                start_date: prescription.start_date,
                end_date: prescription.end_date,
                update_dosage: prescription.update_dosage,
                update_frequency: prescription.update_frequency,
                notes: prescription.notes,
                status: prescription.status,
                schedule_items: JSON.parse(JSON.stringify(prescription.prescription_schedule))
            };
        }
        
        /**
        * Populate the medication schedule
        * @param {Array} scheduleItems - Array of schedule time objects
        */
        function populateSchedule(scheduleItems) {
            const scheduleContainer = document.getElementById('schedule-container');
            const noScheduleElem = document.getElementById('no-schedule');
            
            // Clear existing schedule items
            const existingItems = scheduleContainer.querySelectorAll('.schedule-item');
            existingItems.forEach(item => item.remove());
            
            // Store a copy of the schedule items for edit mode
            tempScheduleItems = JSON.parse(JSON.stringify(scheduleItems || []));
            
            if (scheduleItems && scheduleItems.length > 0) {
                noScheduleElem.classList.add('hidden');
                
                // Sort schedule items by time
                scheduleItems.sort((a, b) => {
                    return a.time.localeCompare(b.time);
                });
                
                // Create schedule items
                scheduleItems.forEach((item, index) => {
                    const scheduleItem = document.createElement('div');
                    scheduleItem.className = 'schedule-item flex items-center justify-between bg-gray-50 dark:bg-gray-600 p-2 rounded-md';
                    scheduleItem.dataset.index = index;
                    
                    const hadTaken = item.had_taken === 'True' || item.had_taken === true;
                    
                    scheduleItem.innerHTML = `
                        <div class="flex items-center toggle-had-taken cursor-pointer">
                            <div class="w-8 h-8 flex items-center justify-center ${hadTaken ? 'text-green-500' : 'text-gray-400'}">
                                ${hadTaken ? 
                                    `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>` : 
                                    `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>`
                                }
                            </div>
                            <span class="ml-2 text-gray-800 dark:text-white">${formatTime(item.time)}</span>
                        </div>
                        <div class="edit-mode-element" style="display: ${isEditMode ? 'block' : 'none'}">
                            <button class="delete-schedule-btn text-red-500 hover:text-red-700 p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    `;
                    
                    scheduleContainer.appendChild(scheduleItem);
                });
            } else {
                noScheduleElem.classList.remove('hidden');
            }
        }
        
        /**
        * Toggle had taken status for a schedule item
        * @param {number} index - Index of the schedule item
        */
        function toggleHadTaken(index) {
            if (index >= 0 && index < tempScheduleItems.length) {
                const item = tempScheduleItems[index];
                const hadTaken = item.had_taken === 'True' || item.had_taken === true;
                tempScheduleItems[index].had_taken = !hadTaken;
                populateSchedule(tempScheduleItems);
            }
        }
        
        /**
        * Toggle edit mode
        * @param {boolean} enable - Whether to enable edit mode
        */
        function toggleEditMode(enable) {
            isEditMode = enable;
            
            // Toggle view/edit fields
            const viewModeElements = document.querySelectorAll('.view-mode-element');
            const editModeElements = document.querySelectorAll('.edit-mode-element');
            
            viewModeElements.forEach(element => {
                element.style.display = enable ? 'none' : '';
            });
            
            editModeElements.forEach(element => {
                element.style.display = enable ? '' : 'none';
            });
            
            // Update mode indicator and toggle button
            modeIndicator.textContent = enable ? 'Edit Mode' : 'View Mode';
            
            // Update edit button icon
            editModeToggle.innerHTML = enable ? 
                `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>` : 
                `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                </svg>`;
            
            // If canceling edit, reset the form values
            if (!enable && currentPrescription) {
                // This will be handled by revertChanges if there are unsaved changes
                // Otherwise, just reset the values to match currentPrescription
                document.getElementById('status-select').value = currentPrescription.status;
                document.getElementById('start-date-input').value = currentPrescription.start_date;
                document.getElementById('end-date-input').value = currentPrescription.end_date;
                document.getElementById('dosage-input').value = currentPrescription.update_dosage;
                document.getElementById('frequency-input').value = currentPrescription.update_frequency;
                document.getElementById('notes-input').value = currentPrescription.notes;
                
                // Reset schedule
                populateSchedule(currentPrescription.prescription_schedule);
            }
        }
        
        /**
        * Add a new schedule time
        */
        function addScheduleTime() {
            const timeInput = document.getElementById('new-schedule-time');
            const time = timeInput.value;
            
            if (!time) {
                showNotification({
                    color: "bg-red-500",
                    title: "Error ⛔",
                    message:  'Please select a time to add to the schedule.',
                });
                return;
            }
            
            // Check if time already exists
            const exists = tempScheduleItems.some(item => item.time === time);
            if (exists) {
                showNotification({
                    color: "bg-red-500",
                    title: "Error ⛔",
                    message: 'This time is already in the schedule.',
                });

                return;
            }
            
            // Add to temporary schedule
            tempScheduleItems.push({
                time: time,
                had_taken: false
            });
            
            // Update schedule display
            populateSchedule(tempScheduleItems);
            
            // Clear input
            timeInput.value = '';
            time_schedule_changed = true; // Mark that schedule has changed
        }
        
        function deleteScheduleTime(index) {
            if (index >= 0 && index < tempScheduleItems.length) {
                tempScheduleItems.splice(index, 1);
                populateSchedule(tempScheduleItems);
                time_schedule_changed = true; // Mark that schedule has changed
            }
        }
        
        // Save changes to the prescription
        function saveChanges() {
            // This is where you would send the data to your backend
            
            if (!currentPrescription) {
                return;
            }
            
            // Get values from form
            const startDate = document.getElementById('start-date-input').value;
            const endDate = document.getElementById('end-date-input').value;
            const dosage = document.getElementById('dosage-input').value;
            const frequency = document.getElementById('frequency-input').value;
            const notes = document.getElementById('notes-input').value;
            const status = document.getElementById('status-select').value;
            
            // Basic validation
            if (!startDate) {
                showNotification({
                    color: "bg-red-500",
                    title: "Error ⛔",
                    message:'Start date is required.',
                });
                return;
            }
            
            if (!endDate) {
                showNotification({
                    color: "bg-red-500",
                    title: "Error ⛔",
                    message:'End date is required.',
                });
                return;
            }
            
            if (!dosage) {
                showNotification({
                    color: "bg-red-500",
                    title: "Error ⛔",
                    message:'Dosage is required.',
                });
                return;
            }
            
            if (!frequency) {
                showNotification({
                    color: "bg-red-500",
                    title: "Error ⛔",
                    message:'Frequency is required.',
                });
                return;
            }
            
            // Validate dates
            if (new Date(startDate) > new Date(endDate)) {
                showNotification({
                    color: "bg-red-500",
                    title: "Error ⛔",
                    message:'Start date cannot be after end date.',
                });
                return;
            }
            
            // Show loading state
            saveEditBtn.disabled = true;
            saveSpinner.classList.remove('hidden');
            
            // Prepare the data to send
            const updatedData = {
                start_date: startDate,
                end_date: endDate,
                update_dosage: dosage,
                update_frequency: frequency,
                notes: notes,
                status: status,
                prescription_schedule: tempScheduleItems,
                time_schedule_changed: time_schedule_changed
            };
            
            fetch('/m/edit-pres-mng/' + currentPrescription.uuid + '/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify(updatedData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Update the current prescription with the returned data
                Object.assign(currentPrescription, data);
                
                // Update the UI with the returned data
                populateModalData(currentPrescription);
                toggleEditMode(false);
                
                showNotification({
                    color: "bg-green-500",
                    title: "Success ✅",
                    message: "Prescription updated successfully.",
                });
                setTimeout(() => {
                    location.reload();
                }, 100);

            })
            .catch(error => {
                console.error('Error saving prescription:', error);
                showNotification({
                    color: "bg-red-500",
                    title: "Error ⛔",
                    message: 'Failed to update prescription. Please try again.',
                });
            })
            .finally(() => {
                // Reset button state
                saveEditBtn.disabled = false;
                saveSpinner.classList.add('hidden');
            });
        }
        
        /**
        * Format a date string to a more readable format
        * @param {string} dateStr - ISO date string
        * @returns {string} Formatted date string
        */
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            
            const date = new Date(dateStr);
            if (isNaN(date)) return dateStr;
            
            return new Intl.DateTimeFormat('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }).format(date);
        }
        
        /**
        * Format a time string to a more readable format
        * @param {string} timeStr - Time string (HH:MM:SS)
        * @returns {string} Formatted time string
        */
        function formatTime(timeStr) {
            if (!timeStr) return 'N/A';
            // Handle different time formats
            let timeParts;
            if (timeStr.includes('T')) {
                // ISO datetime format
                timeParts = timeStr.split('T')[1].split(':');
            } else {
                // HH:MM:SS format
                timeParts = timeStr.split(':');
            }
            
            if (timeParts.length < 2) return timeStr;
            const hours = parseInt(timeParts[0]);
            const minutes = timeParts[1];
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const hours12 = hours % 12 || 12;

            return `${hours12}:${minutes} ${ampm}`;
        }
    });
</script>


<script>
    dashboard_nav_all = document.querySelectorAll('.prescriptions-nav a');
    console.log(dashboard_nav_all);
    
    dashboard_nav_all.forEach((nav) => {
        nav_innertab =
            nav.classList.add('border-l-4', 'border-blue-500', 'bg-blue-50', 'rounded');
    });
</script>

{% endblock scripts %}