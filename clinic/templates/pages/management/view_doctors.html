{% extends "pages/management/M_base.html" %}
{% load static %}

{% block titles %}View Doctors || Nepal's Care {% endblock titles %}

{% block styles %}{% endblock styles %}

{% block pageof %} View Doctors {% endblock pageof %}
{% block linkPageof %} {% url 'management:ViewDoctors' %} {% endblock linkPageof %}

{% block content %}

<div class="flex h-screen overflow-hidden">
    <!-- Main Content -->
    <div class="flex-1 overflow-y-auto">
        <div class="p-6 lg:p-10 w-full">
          <div class="mb-6 bg-white rounded-xl p-6 shadow-sm">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="mb-4 md:mb-0">
                    <h2 class="text-3xl font-bold text-gray-800">Doctor Management</h2>
                    <p class="text-gray-600 max-w-2xl">Manage all Doctor, add new ones, and view or edit existing Doctor with ease.</p>
                </div>
                <button id="add-doctor-trigger" class="flex items-center justify-center px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    <span class="font-medium">Add New Doctor</span>
                </button>
            </div>
          </div>

            <!-- Search and Filters -->
            <div class="bg-white rounded-lg shadow p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Search Doctors..."
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent pl-10">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-3"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Doctors List -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Doctor</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                   Contact</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="patientTableBody" class="divide-y divide-gray-200">
                            {% for each_D in doctors %}
                                <tr class="hover:bg-gray-50 transition-all duration-200" >
                                    <!-- Patient Info -->
                                    <td class="table-cell px-4 py-4 whitespace-nowrap doctor-details"
                                        title="View Profile" data-patient="{{ each_D.user.first_name }}" >
                                        <a href="{% url 'ViewPatientsRecords' each_D.user.username %}" target="_blank_" class="bg-indigo-600 hover:bg-indigo-800">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0 h-10 w-10">
                                                    <img class="h-10 w-10 rounded-full object-cover shadow-sm border border-gray-200 transition-transform duration-200 hover:scale-110"
                                                        src="{{ each_D.profile_pic.url }}"
                                                        alt="{{ each_D.user.first_name}}">
                                                </div>
                                                <div class="ml-4">
                                                    <p class="text-sm font-medium text-gray-900" data-doctor="{{ each_D.user.first_name }}"  >{{ each_D.user.first_name }}
                                                    </p>
                                                    <div class="text-sm text-gray-500" data-specialization='{{ each_D.user.username }}' >{{ each_D.user.username }}</div>
                                                </div>
                                            </div>
                                        </a>
                                    </td>

                                    <!-- Contact Info -->
                                    <td class="table-cell px-4 py-4 whitespace-nowrap">
                                        <div class="flex flex-col">
                                            <div class="flex items-center mb-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
                                                </svg>
                                                <span class="text-sm text-gray-700">{{ each_D.ph_number|default:"Null" }}</span>
                                            </div>
                                            <div class="flex items-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                                                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                                                </svg>
                                                <span class="text-sm text-gray-700">{{ each_D.user.email|default:'Null' }}</span>
                                            </div>
                                        </div>
                                    </td>

                                    <!-- Actions Btns -->
                                    <td class="px-4 py-4 whitespace-nowrap">
                                        <div class="flex space-x-2">
                                            <button class="bg-blue-500 text-white px-3 py-1 rounded doctor-modal-trigger" data-slug="{{ each_D.doctor_profile.slug }}">
                                              View/Edit
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% empty %}
                                <tr class="col-span-full text-gray-500">
                                    <td>
                                        No Doctors Found 
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination and Show Entries -->
            <div class="bg-white border-t border-gray-200 rounded-b-lg">
                <div class="flex flex-col lg:flex-row items-center justify-between py-4 px-4 md:px-6 space-y-4 lg:space-y-0">
            
                <!-- Show Entries Selector -->
                <form method="get" class="flex items-center space-x-3 w-full lg:w-auto" id="perPageForm">
                    <span class="text-gray-600 text-sm whitespace-nowrap">Show entries</span>
                    <div class="relative">
                    <select name="per_page" onchange="document.getElementById('perPageForm').submit()"
                            class="appearance-none pl-4 pr-10 py-2 border border-gray-300 bg-white rounded-full text-sm font-medium text-gray-700 shadow-sm hover:border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-200 cursor-pointer">
                        {% for n in per_page_options %}
                        <option value="{{ n }}" {% if per_page == n %}selected{% endif %}>{{ n }}</option>
                        {% endfor %}
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-indigo-500">
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                                d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                clip-rule="evenodd"/>
                        </svg>
                    </div>
                    </div>
                    {# preserve current page when changing per_page #}
                    <input type="hidden" name="page" value="{{ appointments.number }}">
                </form>
            
                <!-- Results Counter -->
                <div class="hidden sm:block text-center lg:text-left text-sm text-gray-500">
                    Showing
                    <span class="font-semibold text-gray-700">
                    {{ appointments.start_index }}
                    </span>
                    to
                    <span class="font-semibold text-gray-700">
                    {{ appointments.end_index }}
                    </span>
                    of
                    <span class="font-semibold text-gray-700">
                    {{ paginator.count }}
                    </span>
                    results
                </div>
            
                <!-- Pagination Navigation -->
                <div class="w-full lg:w-auto flex justify-center lg:justify-end">
                    <nav class="relative z-0 inline-flex shadow-sm -space-x-px rounded-md" aria-label="Pagination">
            
                    {# Previous #}
                    {% if appointments.has_previous %}
                        <a href="?page={{ appointments.previous_page_number }}&per_page={{ per_page }}"
                        class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition duration-150">
                        <span class="sr-only">Previous</span>
                        <!-- ← -->
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 
                                    01-1.414 1.414l-4-4a1 1 0 
                                    010-1.414l4-4a1 1 0 011.414 0z"
                                clip-rule="evenodd"/>
                        </svg>
                        </a>
                    {% else %}
                        <span class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-400 cursor-not-allowed disabled:opacity-50">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 
                                    01-1.414 1.414l-4-4a1 1 0 
                                    010-1.414l4-4a1 1 0 011.414 0z"
                                clip-rule="evenodd"/>
                        </svg>
                        </span>
                    {% endif %}
            
                    {# Page Numbers #}
                    {% for num in paginator.page_range %}
                        {% if num >= appointments.number|add:-2 and num <= appointments.number|add:2 %}
                        {% if num == appointments.number %}
                            <span aria-current="page"
                                class="relative inline-flex items-center px-4 py-2 border border-indigo-500 bg-indigo-50 text-sm font-medium text-indigo-600">
                            {{ num }}
                            </span>
                        {% else %}
                            <a href="?page={{ num }}&per_page={{ per_page }}"
                            class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition duration-150">
                            {{ num }}
                            </a>
                        {% endif %}
                        {% elif num == 1 or num == paginator.num_pages %}
                        <!-- always show first and last -->
                        <a href="?page={{ num }}&per_page={{ per_page }}"
                            class="relative inline-flex hidden md:inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition duration-150">
                            {{ num }}
                        </a>
                        {% elif num == appointments.number|add:-3 or num == appointments.number|add:3 %}
                        <span class="relative inline-flex hidden md:inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                            …
                        </span>
                        {% endif %}
                    {% endfor %}
            
                    {# Next #}
                    {% if appointments.has_next %}
                        <a href="?page={{ appointments.next_page_number }}&per_page={{ per_page }}"
                        class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition duration-150">
                        <span class="sr-only">Next</span>
                        <!-- → -->
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M7.293 14.707a1 1 0 
                                    010-1.414L10.586 10 7.293 6.707a1 1 0 
                                    011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 
                                    01-1.414 0z"
                                clip-rule="evenodd"/>
                        </svg>
                        </a>
                    {% else %}
                        <span class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-400 cursor-not-allowed disabled:opacity-50">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M7.293 14.707a1 1 0 
                                    010-1.414L10.586 10 7.293 6.707a1 1 0 
                                    011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 
                                    01-1.414 0z"
                                clip-rule="evenodd"/>
                        </svg>
                        </span>
                    {% endif %}
            
                    </nav>
                </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Add Doctor Modal Background Overlay -->
<div id="add-doctor-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center transition-opacity duration-300 ease-in-out opacity-0">
  <!-- Modal Container -->
  <div id="add-doctor-modal" class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-4xl w-full mx-4 md:mx-auto max-h-[90vh] overflow-hidden flex flex-col transform transition-all duration-300 ease-in-out scale-95 opacity-0">
    <!-- Modal Header -->
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gradient-to-r from-purple-400 to-blue-600 text-white">
      <h3 class="text-lg md:text-xl font-bold flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
        <span>Add New Doctor</span>
      </h3>
      
      <button id="close-add-doctor-modal" class="bg-white bg-opacity-20 hover:bg-opacity-30 p-1.5 rounded-lg transition-all duration-200">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    
    <!-- Step Indicator -->
    <div class="px-4 sm:px-6 pt-4 pb-6">
      <div class="flex items-center justify-between">
      <div class="w-full flex items-center">
        <!-- Step 1 -->
        <div class="relative flex flex-col items-center text-blue-600">
        <div id="step-indicator-1" class="rounded-full shadow-lg transition duration-300 ease-in-out h-10 sm:h-12 w-10 sm:w-12 py-3 border-2 border-blue-600 bg-blue-600 text-white font-bold flex items-center justify-center transform hover:scale-105">
          <span class="text-sm sm:text-base">1</span>
        </div>
        <div class="absolute top-0 text-center mt-14 sm:mt-16 w-24 sm:w-32 text-xs font-medium uppercase text-blue-600">Personal</div>
        </div>
        
        <!-- Connector 1-2 -->
        <div class="flex-auto border-t-2 transition duration-300 ease-in-out border-gray-300"></div>
        
        <!-- Step 2 -->
        <div class="relative flex flex-col items-center text-gray-500">
        <div id="step-indicator-2" class="rounded-full shadow transition duration-300 ease-in-out h-10 sm:h-12 w-10 sm:w-12 py-3 border-2 border-gray-300 bg-white font-bold flex items-center justify-center transform hover:scale-105">
          <span class="text-sm sm:text-base">2</span>
        </div>
        <div class="absolute top-0 text-center mt-14 sm:mt-16 w-24 sm:w-32 text-xs font-medium uppercase">Professional</div>
        </div>
        
        <!-- Connector 2-3 -->
        <div class="flex-auto border-t-2 transition duration-300 ease-in-out border-gray-300"></div>
        
        <!-- Step 3 -->
        <div class="relative flex flex-col items-center text-gray-500">
        <div id="step-indicator-3" class="rounded-full shadow transition duration-300 ease-in-out h-10 sm:h-12 w-10 sm:w-12 py-3 border-2 border-gray-300 bg-white font-bold flex items-center justify-center transform hover:scale-105">
          <span class="text-sm sm:text-base">3</span>
        </div>
        <div class="absolute top-0 text-center mt-14 sm:mt-16 w-24 sm:w-32 text-xs font-medium uppercase">Practice</div>
        </div>
      </div>
      </div>
    </div>
    
    <!-- Modal Content -->
    <div class="flex-1 overflow-y-auto p-6 pt-10">
      <form id="add-doctor-form">
        <!-- Step 1: Personal Information -->
        <div id="form-step-1" class="form-step">
          <div class="space-y-6">
            <div class="text-lg font-medium text-gray-900 dark:text-white mb-4">Personal Information</div>
            
            <!-- Email & Phone (Row) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="doctor-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email <span class="text-red-500">*</span></label>
                <input type="email" id="doctor-email" name="email" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm" required>
              </div>
              <div>
                <label for="doctor-phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Phone Number <span class="text-red-500">*</span></label>
                <input type="tel" id="doctor-phone" name="phone" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm" placeholder="+977 9812345678" required>
                <p class="mt-1 text-xs text-gray-500">Format: +999999999, up to 15 digits allowed.</p>
              </div>
            </div>
            
            <!-- Name & Password (Row) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="doctor-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Full Name <span class="text-red-500">*</span></label>
                <input type="text" id="doctor-name" name="full_name" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm" required>
              </div>
              <div>
                <label for="doctor-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password <span class="text-red-500">*</span></label>
                <input type="password" id="doctor-password" name="password" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm" required>
                <p class="mt-1 text-xs text-gray-500">Password must be at least 8 characters long.</p>
              </div>
            </div>
            
            <!-- Date of Birth & Gender (Row) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="doctor-dob" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date of Birth</label>
                <input type="date" id="doctor-dob" name="date_of_birth" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm" >
              </div>
              <div>
                <label for="doctor-gender" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Gender</label>
                <select id="doctor-gender" name="gender" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm" >
                  <option value="">-- Select Gender --</option>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>
            
            <!-- Address & Profile Picture (Row) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="doctor-address" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Address</label>
                <textarea id="doctor-address" name="address" rows="3" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm"></textarea>
              </div>
              <div>
                <label for="doctor-profile-pic" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Profile Picture</label>
                <div class="mt-1 flex items-center">
                  <div id="profile-pic-preview" class="w-20 h-20 rounded-full overflow-hidden bg-gray-100 flex items-center justify-center mr-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                  </div>
                  <input type="file" id="doctor-profile-pic" name="profile_pic" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept="image/*">
                </div>
              </div>
            </div>
            
            <!-- Notification Preferences -->
            <div>
              <span class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Notification Preferences</span>
              <div class="space-y-2">
                <div class="flex items-center">
                  <input type="checkbox" id="doctor-email-notification" name="email_notification" class="h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 rounded" checked>
                  <label for="doctor-email-notification" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Email Notifications</label>
                </div>
                <div class="flex items-center">
                  <input type="checkbox" id="doctor-sms-notification" name="sms_notification" class="h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 rounded" checked>
                  <label for="doctor-sms-notification" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">SMS Notifications</label>
                </div>
                <div class="flex items-center">
                  <input type="checkbox" id="doctor-reminders" name="reminders" class="h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 rounded" checked>
                  <label for="doctor-reminders" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Reminders</label>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Next Button -->
          <div class="mt-8 flex justify-end">
            <button type="button" class="next-step-btn px-6 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 transition-colors" data-next="2">
              Next: Professional Info
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
              </svg>
            </button>
          </div>
        </div>
        
        <!-- Step 2: Professional Information -->
        <div id="form-step-2" class="form-step hidden">
          <div class="space-y-6">
            <div class="text-lg font-medium text-gray-900 dark:text-white mb-4">Professional Information</div>
            
            <!-- Specialization & Experience (Row) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="specialization" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Specialization <span class="text-red-500">*</span></label>
                <select id="specialization" name="specialization" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm" required>
                  <option value="">-- Select Specialization --</option>
                  <option value="general_medicine">General Medicine</option>
                  <option value="cardiology">Cardiology</option>
                  <option value="dermatology">Dermatology</option>
                  <option value="neurology">Neurology</option>
                  <option value="orthopedics">Orthopedics</option>
                  <option value="pediatrics">Pediatrics</option>
                  <option value="psychiatry">Psychiatry</option>
                  <option value="radiology">Radiology</option>
                  <option value="surgery">Surgery</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div>
                <label for="experience-years" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Years of Experience <span class="text-red-500">*</span></label>
                <input type="number" id="experience-years" name="experience_years" min="0" max="70" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm" required>
              </div>
            </div>
            
            <!-- License & Board Certification (Row) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="license-number" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">License Number</label>
                <input type="text" id="license-number" name="license_number" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Board Certified</label>
                <div class="mt-2 space-x-6">
                  <label class="inline-flex items-center">
                    <input type="radio" name="board_certified" value="true" class="h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300">
                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Yes</span>
                  </label>
                  <label class="inline-flex items-center">
                    <input type="radio" name="board_certified" value="false" class="h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300" checked>
                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">No</span>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- Qualifications -->
            <div>
              <label for="qualifications" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Qualifications</label>
              <textarea id="qualifications" name="qualifications" rows="3" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm" placeholder="List qualifications, degrees, certifications..."></textarea>
            </div>
            
            <!-- Languages Spoken -->
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Languages Spoken</label>
              <div class="mt-2 space-y-2">
                <div class="flex flex-wrap gap-2" id="languages-container">
                  <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                    <span>English</span>
                    <button type="button" class="ml-1 text-blue-600 hover:text-blue-800 language-remove-btn" data-language="English">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                </div>
                
                <div class="flex mt-2">
                  <input type="text" id="new-language" class="block w-full px-3 py-2 border border-gray-300 rounded-l-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm" placeholder="Add a language...">
                  <button type="button" id="add-language-btn" class="px-3 py-2 bg-teal-600 text-white rounded-r-md hover:bg-teal-700 transition-colors">
                    Add
                  </button>
                </div>
                <input type="hidden" id="languages-spoken" name="languages_spoken" value='["English"]'>
              </div>
            </div>
          </div>
          
          <!-- Next/Previous Buttons -->
          <div class="mt-8 flex justify-between">
            <button type="button" class="prev-step-btn px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors" data-prev="1">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" />
              </svg>
              Previous
            </button>
            <button type="button" class="next-step-btn px-6 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 transition-colors" data-next="3">
              Next: Practice Details
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
              </svg>
            </button>
          </div>
        </div>
        
        <!-- Step 3: Practice Details -->
        <div id="form-step-3" class="form-step hidden">
          <div class="space-y-6">
            <div class="text-lg font-medium text-gray-900 dark:text-white mb-4">Practice Details</div>
            
            <!-- Consultation Fee & Accepts New Patients (Row) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="fees" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Consultation Fee <span class="text-red-500">*</span></label>
                <div class="mt-1 relative rounded-md shadow-sm">
                  <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                    <span class="text-gray-500 sm:text-sm">RS</span>
                  </div>
                  <input type="number" id="fees" name="fees" min="0" step="0.01" class="block w-full pl-7 pr-12 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm" placeholder="0.00" required>
                  <div class="absolute inset-y-0 right-0 pr-1 flex items-center pointer-events-none">
                    <span class="text-gray-500 sm:text-sm">Nepali</span>
                  </div>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Accepts New Patients</label>
                <div class="mt-2 space-x-6">
                  <label class="inline-flex items-center">
                    <input type="radio" name="accepts_new_patients" value="true" class="h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300" checked>
                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Yes</span>
                  </label>
                  <label class="inline-flex items-center">
                    <input type="radio" name="accepts_new_patients" value="false" class="h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300">
                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">No</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Submission Info -->
          <div class="mt-4 text-sm text-gray-500 dark:text-gray-400 flex justify-between">
            <div>Current User: <span id="current-user">{{ request.user.username }}</span></div>
            <div>Current Time (UTC): <span id="current-time">2025-06-28 06:43:45</span></div>
          </div>
          
          <!-- Submit/Previous Buttons -->
          <div class="mt-8 flex justify-between">
            <button type="button" class="prev-step-btn px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors" data-prev="2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" />
              </svg>
              Previous
            </button>
            <button type="submit" id="submit-doctor-btn" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors flex items-center">
              <span>Register Doctor</span>
              <svg id="doctor-submit-spinner" class="animate-spin ml-2 h-4 w-4 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Enhanced Doctor Modal -->
<div id="doctorModal" class="fixed inset-0 z-50 hidden">
  <!-- Backdrop with faster animation -->
  <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity duration-200" id="modalBackdrop"></div>
  
  <!-- Modal Container with optimized positioning -->
  <div class="fixed inset-0 overflow-y-auto">
    <div class="flex min-h-80 items-center justify-center p-2 sm:p-4">
      <div class="relative w-2/3 max-w-7xl bg-white rounded-xl shadow-2xl transform transition-all duration-200 scale-95 opacity-0" id="modalContainer">
        
        <!-- Header Section - Same as before -->
        <div class="relative bg-gradient-to-r from-slate-50 to-blue-50 rounded-t-xl p-3 sm:p-6 border-b border-slate-200">
          <!-- Close Button -->
          <button id="closeDoctorModal" class="absolute top-2 right-2 sm:top-4 sm:right-4 w-8 h-8 flex items-center justify-center text-slate-400 hover:text-slate-600 hover:bg-white rounded-full transition-colors duration-150">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>

          <!-- Doctor Header Info -->
          <div class="flex flex-col xs:flex-row items-center xs:items-start gap-3 sm:gap-4 pr-10 sm:pr-12">
            <div class="relative flex-shrink-0">
              <div class="w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-slate-200 overflow-hidden ring-4 ring-white shadow-lg">
                <img id="docProfilePic" class="w-full h-full object-cover" src="" alt="Doctor Profile" loading="lazy">
              </div>
              <div class="absolute -bottom-1 -right-1 w-5 h-5 sm:w-6 sm:h-6 bg-green-500 rounded-full border-2 border-white" id="docActiveIndicator"></div>
            </div>
            
            <div class="flex-1 text-center xs:text-left min-w-0">
              <h2 class="text-base sm:text-lg font-bold text-slate-800 truncate" id="docName">Loading...</h2>
              <p class="text-xs sm:text-sm text-slate-600 font-medium truncate" id="docSpecialization">Loading...</p>
              
              <!-- Rating and Status -->
              <div class="flex flex-col xs:flex-row items-center xs:items-start gap-2 xs:gap-4 mt-2">
                <div class="flex items-center gap-1">
                  <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                  <span class="text-sm font-medium text-slate-700" id="docRating">0</span>
                  <span class="text-xs sm:text-sm text-slate-500">(<span id="docReviews">0</span>)</span>
                
                  <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800" id="docVerifiedBadge">
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    Verified
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab Navigation -->
        <div class="sticky top-0 bg-white border-b border-slate-200 z-10">
          <div class="flex overflow-x-auto scrollbar-hide">
            <button class="tab-btn flex-shrink-0 px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm font-medium text-slate-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-500 transition-colors duration-150 whitespace-nowrap" data-tab="basic">
              <svg class="w-4 h-4 mr-1 sm:mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
              <span class="hidden xs:inline">Personal</span>
              <span class="xs:hidden">Info</span>
            </button>
            
            <button class="tab-btn flex-shrink-0 px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm font-medium text-slate-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-500 transition-colors duration-150 whitespace-nowrap" data-tab="professional">
              <svg class="w-4 h-4 mr-1 sm:mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
              </svg>
              <span class="hidden xs:inline">Professional</span>
              <span class="xs:hidden">Pro</span>
            </button>
            
            <button class="tab-btn flex-shrink-0 px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm font-medium text-slate-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-500 transition-colors duration-150 whitespace-nowrap" data-tab="appointments">
              <svg class="w-4 h-4 mr-1 sm:mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              <span class="hidden xs:inline">Appointments</span>
              <span class="xs:hidden">Appt</span>
            </button>
            
            <button class="tab-btn flex-shrink-0 px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm font-medium text-slate-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-500 transition-colors duration-150 whitespace-nowrap" data-tab="availability">
              <svg class="w-4 h-4 mr-1 sm:mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span class="hidden xs:inline">Availability</span>
              <span class="xs:hidden">Time</span>
            </button>
          </div>
        </div>

        <!-- Tab Contents -->
        <div class="overflow-y-auto max-h-[60vh] sm:max-h-[70vh]">
          
          <!-- Personal Info Tab with Edit Functionality -->
          <div class="tab-content p-3 sm:p-6" id="tab-basic">
            <!-- Edit Button for Personal Info -->
            <div class="flex justify-end mb-4">
              <button id="editPersonalBtn" class="inline-flex items-center px-3 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors duration-150">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                Edit Personal Info
              </button>
            </div>

            <!-- View Mode -->
            <div id="personalViewMode" class="grid grid-cols-1 xl:grid-cols-2 gap-4 sm:gap-6">
              <!-- Contact Information Card -->
              <div class="bg-slate-50 rounded-lg sm:rounded-xl p-4 sm:p-6">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800 mb-3 sm:mb-4 flex items-center">
                  <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                  </svg>
                  Contact Information
                </h3>
                
                <div class="space-y-3 sm:space-y-4">
                  <div class="flex items-start sm:items-center">
                    <svg class="w-4 h-4 mr-3 text-slate-500 mt-0.5 sm:mt-0 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
                    </svg>
                    <div class="min-w-0 flex-1">
                      <div class="text-xs sm:text-sm text-slate-500">Email</div>
                      <div class="font-medium text-slate-800 text-sm sm:text-base break-all" id="docEmail">Loading...</div>
                    </div>
                  </div>
                  
                  <div class="flex items-start sm:items-center">
                    <svg class="w-4 h-4 mr-3 text-slate-500 mt-0.5 sm:mt-0 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                    </svg>
                    <div class="min-w-0 flex-1">
                      <div class="text-xs sm:text-sm text-slate-500">Phone</div>
                      <div class="font-medium text-slate-800 text-sm sm:text-base" id="docPhone">Loading...</div>
                    </div>
                  </div>
                  
                  <div class="flex items-start">
                    <svg class="w-4 h-4 mr-3 text-slate-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <div class="min-w-0 flex-1">
                      <div class="text-xs sm:text-sm text-slate-500">Address</div>
                      <div class="font-medium text-slate-800 text-sm sm:text-base" id="docAddress">Loading...</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Personal Details Card -->
              <div class="bg-slate-50 rounded-lg sm:rounded-xl p-4 sm:p-6">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800 mb-3 sm:mb-4 flex items-center">
                  <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                  Personal Details
                </h3>
                
                <div class="space-y-3 sm:space-y-4">
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                    <div>
                      <div class="text-xs sm:text-sm text-slate-500">Username</div>
                      <div class="font-medium text-slate-800 text-sm sm:text-base truncate" id="docUsername">Loading...</div>
                    </div>
                    <div>
                      <div class="text-xs sm:text-sm text-slate-500">Gender</div>
                      <div class="font-medium text-slate-800 text-sm sm:text-base" id="docGender">Loading...</div>
                    </div>
                  </div>
                  
                  <div>
                    <div class="text-xs sm:text-sm text-slate-500">Date of Birth</div>
                    <div class="font-medium text-slate-800 text-sm sm:text-base" id="docDob">Loading...</div>
                  </div>
                  
                  <div class="flex flex-col xs:flex-row gap-2 xs:gap-4">
                    <div class="flex items-center">
                      <div class="w-3 h-3 rounded-full mr-2 bg-gray-300" id="docActiveIndicatorSmall"></div>
                      <span class="text-xs sm:text-sm" id="docActiveStatus">Loading...</span>
                    </div>
                    <div class="flex items-center" id="docVerifiedStatus">Loading...</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Edit Mode for Personal Info -->
            <div id="personalEditMode" class="hidden">
              <form id="personalEditForm" class="space-y-6">
                {% csrf_token %}
                <input type="hidden" id="editPersonalSlug" name="slug">
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <!-- Contact Information Section -->
                  <div class="bg-slate-50 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Contact Information</h3>
                    
                    <div class="space-y-4">
                      <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Phone Number</label>
                        <input type="text" id="editPhone" name="phone" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                      </div>
                      
                      <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Address</label>
                        <textarea id="editAddress" name="address" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                      </div>
                    </div>
                  </div>

                  <!-- Personal Details Section -->
                  <div class="bg-slate-50 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Personal Details</h3>
                    
                    <div class="space-y-4">
                      <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Gender</label>
                        <select id="editGender" name="gender" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                          <option value="">Select Gender</option>
                          <option value="male">Male</option>
                          <option value="female">Female</option>
                          <option value="other">Other</option>
                        </select>
                      </div>
                      
                      <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Date of Birth</label>
                        <input type="date" id="editDob" name="date_of_birth" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                      </div>
                    </div>
                  </div>

                  <!-- Active/ Verfied -->
                  <div class="bg-slate-50 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Status</h3>
                    
                    <div class="space-y-4">
                      <div class="flex items-center">
                        <input type="checkbox" id="editActive" name="active" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" {% if currentDoctor.is_active %}checked{% endif %}>
                        <label for="editActive" class="ml-2 text-sm font-medium text-slate-700">Active</label>
                      </div>
                      <div class="flex items-center">
                        <input type="checkbox" id="editVerified" name="verified" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" {% if currentDoctor.is_verified %}checked{% endif %}>
                        <label for="editVerified" class="ml-2 text-sm font-medium text-slate-700">Verified</label>  
                      </div>
                    </div>
                  </div>

                      
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
                  <button type="button" id="cancelPersonalEdit" class="px-4 py-2 text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors duration-150">
                    Cancel
                  </button>
                  <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-150">
                    Save Changes
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Professional Info Tab with Edit Functionality -->
          <div class="tab-content hidden p-3 sm:p-6" id="tab-professional">
            <!-- Edit Button for Professional Info -->
            <div class="flex justify-end mb-4">
              <button id="editProfessionalBtn" class="inline-flex items-center px-3 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors duration-150">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                Edit Professional Info
              </button>
            </div>

            <!-- View Mode -->
            <div id="professionalViewMode" class="grid grid-cols-1 xl:grid-cols-2 gap-4 sm:gap-6">
              
              <!-- Qualifications Card -->
              <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg sm:rounded-xl p-4 sm:p-6">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800 mb-3 sm:mb-4 flex items-center">
                  <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                  </svg>
                  Qualifications
                </h3>
                
                <div class="space-y-3 sm:space-y-4">
                  <div>
                    <div class="text-xs sm:text-sm text-slate-600">Qualifications</div>
                    <div class="font-medium text-slate-800 text-sm sm:text-base" id="docQualifications">Loading...</div>
                  </div>
                  
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                    <div>
                      <div class="text-xs sm:text-sm text-slate-600">Experience</div>
                      <div class="font-medium text-slate-800 text-sm sm:text-base"><span id="docExperience">0</span> years</div>
                    </div>
                    <div>
                      <div class="text-xs sm:text-sm text-slate-600">License Number</div>
                      <div class="font-medium text-slate-800 text-sm sm:text-base break-all" id="docLicense">Loading...</div>
                    </div>
                  </div>
                  
                  <div>
                    <div class="text-xs sm:text-sm text-slate-600">Board Certified</div>
                    <div class="flex items-center mt-1">
                      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium" id="docBoardCertBadge">Loading...</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Languages & Reviews Card -->
              <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg sm:rounded-xl p-4 sm:p-6">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800 mb-3 sm:mb-4 flex items-center">
                  <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                  </svg>
                  Languages & Reviews
                </h3>
                
                <div class="space-y-3 sm:space-y-4">
                  <div>
                    <div class="text-xs sm:text-sm text-slate-600">Languages Spoken</div>
                    <div class="flex flex-wrap gap-1 sm:gap-2 mt-2" id="docLanguagesList">Loading...</div>
                  </div>
                  
                  <div class="border-t border-green-200 pt-3 sm:pt-4">
                    <div class="flex items-center justify-between">
                      <div>
                        <div class="text-xs sm:text-sm text-slate-600">Patient Rating</div>
                        <div class="flex items-center mt-1">
                          <div class="flex items-center" id="docStarsDisplay">Loading...</div>
                          <span class="ml-2 text-xs sm:text-sm text-slate-600">(<span id="docTotalReviews">0</span> reviews)</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Fees & Availability Card -->
              <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg sm:rounded-xl p-4 sm:p-6 xl:col-span-2">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-base sm:text-lg font-semibold text-slate-800 flex items-center">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                    </svg>
                    Fees & Availability
                  </h3>
                  <button id="editFeesBtn" class="inline-flex items-center px-3 py-1 bg-purple-600 text-white text-xs font-medium rounded-lg hover:bg-purple-700 transition-colors duration-150">
                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    Edit
                  </button>
                </div>
                
                <!-- Fees View Mode -->
                <div id="feesViewMode" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <div class="text-xs sm:text-sm text-slate-600">Consultation Fee</div>
                    <div class="text-xl sm:text-2xl font-bold text-purple-600">$<span id="docFees">0</span></div>
                  </div>
                  <div>
                    <div class="text-xs sm:text-sm text-slate-600">New Patients</div>
                    <div class="text-sm sm:text-base font-semibold" id="docAcceptsNewStatus">Loading...</div>
                  </div>
                </div>

                <!-- Fees Edit Mode -->
                <div id="feesEditMode" class="hidden">
                  <form id="feesEditForm" class="space-y-4">
                    <input type="hidden" id="editFeesSlug" name="slug">
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Consultation Fee ($)</label>
                        <input type="number" id="editFees" name="fees" step="0.01" min="0" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                      </div>
                      
                      <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Accept New Patients</label>
                        <select id="editAcceptsNew" name="accepts_new_patients" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                          <option value="true">Yes, accepting new patients</option>
                          <option value="false">No, not accepting new patients</option>
                        </select>
                      </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
                      <button type="button" id="cancelFeesEdit" class="px-4 py-2 text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors duration-150">
                        Cancel
                      </button>
                      <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors duration-150">
                        Save Changes
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- Edit Mode for Professional Info -->
            <div id="professionalEditMode" class="hidden">
              <form id="professionalEditForm" class="space-y-6">
                <input type="hidden" id="editProfessionalSlug" name="slug">
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <!-- Qualifications Section -->
                  <div class="bg-blue-50 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Qualifications & Experience</h3>
                    
                    <div class="space-y-4">
                      <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Specialization</label>
                        <select id="editSpecialization" name="specialization" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                          <option value="general_medicine">General Medicine</option>
                          <option value="cardiology">Cardiology</option>
                          <option value="dermatology">Dermatology</option>
                          <option value="neurology">Neurology</option>
                          <option value="orthopedics">Orthopedics</option>
                          <option value="pediatrics">Pediatrics</option>
                          <option value="psychiatry">Psychiatry</option>
                          <option value="radiology">Radiology</option>
                          <option value="surgery">Surgery</option>
                          <option value="other">Other</option>
                        </select>
                      </div>
                      
                      <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Qualifications</label>
                        <textarea id="editQualifications" name="qualifications" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter qualifications (e.g., MD, MBBS, PhD)"></textarea>
                      </div>
                      
                      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label class="block text-sm font-medium text-slate-700 mb-2">Experience (Years)</label>
                          <input type="number" id="editExperience" name="experience_years" min="0" max="50" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <div>
                          <label class="block text-sm font-medium text-slate-700 mb-2">License Number</label>
                          <input type="text" id="editLicenseNumber" name="license_number" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                      </div>
                      
                      <div class="flex items-center">
                        <input type="checkbox" id="editBoardCertified" name="board_certified" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2">
                        <label for="editBoardCertified" class="ml-2 text-sm font-medium text-slate-700">Board Certified</label>
                      </div>
                    </div>
                  </div>

                  <!-- Languages Section -->
                  <div class="bg-green-50 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Languages</h3>
                    
                    <div class="space-y-4">
                      <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Languages Spoken</label>
                        <div class="space-y-2" id="languagesContainer">
                          <!-- Languages will be populated here -->
                        </div>
                        <button type="button" id="addLanguageBtn" class="mt-2 inline-flex items-center px-3 py-1 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition-colors duration-150">
                          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                          </svg>
                          Add Language
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
                  <button type="button" id="cancelProfessionalEdit" class="px-4 py-2 text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors duration-150">
                    Cancel
                  </button>
                  <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-150">
                    Save Changes
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Appointments Tab (unchanged) -->
          <div class="tab-content hidden p-3 sm:p-6" id="tab-appointments">
            <!-- Stats Cards - Responsive Grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-3 sm:gap-6 mb-4 sm:mb-6">
              
              <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg sm:rounded-xl p-4 sm:p-6">
                <h3 class="text-sm sm:text-lg font-semibold text-slate-800 mb-1 sm:mb-2 flex items-center">
                  <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-1 sm:mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                  </svg>
                  Fee
                </h3>
                <div class="text-xl sm:text-2xl font-bold text-purple-600">$<span id="docFeesDisplay">0</span></div>
              </div>

              <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg sm:rounded-xl p-4 sm:p-6">
                <h3 class="text-sm sm:text-lg font-semibold text-slate-800 mb-1 sm:mb-2 flex items-center">
                  <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-1 sm:mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  Status
                </h3>
                <div class="text-sm sm:text-lg font-semibold" id="docAcceptsNewStatusDisplay">Loading...</div>
              </div>

              <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-lg sm:rounded-xl p-4 sm:p-6 sm:col-span-2 xl:col-span-1">
                <h3 class="text-sm sm:text-lg font-semibold text-slate-800 mb-1 sm:mb-2 flex items-center">
                  <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-1 sm:mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                  </svg>
                  Total
                </h3>
                <div class="text-xl sm:text-2xl font-bold text-blue-600" id="docAppointmentCount">0</div>
              </div>
            </div>

            <!-- Appointments List -->
            <div class="bg-white rounded-lg sm:rounded-xl border border-slate-200">
              <div class="p-3 sm:p-4 border-b border-slate-200">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800">Recent Appointments</h3>
              </div>
              <div class="max-h-60 sm:max-h-96 overflow-y-auto" id="docAppointmentsList">
                <div class="p-4 text-center text-slate-500">Loading appointments...</div>
              </div>
            </div>
          </div>

          <!-- Availability Tab (unchanged) -->
          <div class="tab-content hidden p-3 sm:p-6" id="tab-availability">
            <div class="bg-white rounded-lg sm:rounded-xl border border-slate-200">
              <div class="p-3 sm:p-4 border-b border-slate-200">
                <h3 class="text-base sm:text-lg font-semibold text-slate-800 flex items-center">
                  <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                  </svg>
                  Available Time Slots
                </h3>
              </div>
              <div class="max-h-60 sm:max-h-96 overflow-y-auto p-3 sm:p-4" id="docAvailabilityList">
                <div class="p-4 text-center text-slate-500">Loading availability...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
  class FastDoctorModalWithEdit {
    constructor() {
      this.modal = document.getElementById('doctorModal');
      this.modalContainer = document.getElementById('modalContainer');
      this.modalBackdrop = document.getElementById('modalBackdrop');
      this.isOpen = false;
      this.currentDoctor = null;
      this.languageCounter = 0;
      
      // Pre-compile templates for faster rendering
      this.templates = this.compileTemplates();
      
      this.init();
    }
  
    init() {
      this.setupEventListeners();
      this.setupTabSwitching();
      this.setupKeyboardNavigation();
      this.setupEditFunctionality();
      this.preloadElements();
    }
  
    preloadElements() {
      // Cache frequently accessed elements
      this.elements = {
        // Header elements
        docProfilePic: document.getElementById('docProfilePic'),
        docName: document.getElementById('docName'),
        docSpecialization: document.getElementById('docSpecialization'),
        docRating: document.getElementById('docRating'),
        docReviews: document.getElementById('docReviews'),
        docVerifiedBadge: document.getElementById('docVerifiedBadge'),
        docActiveIndicator: document.getElementById('docActiveIndicator'),
        
        // Personal info elements
        docEmail: document.getElementById('docEmail'),
        docPhone: document.getElementById('docPhone'),
        docAddress: document.getElementById('docAddress'),
        docUsername: document.getElementById('docUsername'),
        docGender: document.getElementById('docGender'),
        docDob: document.getElementById('docDob'),
        docActiveIndicatorSmall: document.getElementById('docActiveIndicatorSmall'),
        docActiveStatus: document.getElementById('docActiveStatus'),
        docVerifiedStatus: document.getElementById('docVerifiedStatus'),
        
        // Professional elements
        docQualifications: document.getElementById('docQualifications'),
        docExperience: document.getElementById('docExperience'),
        docLicense: document.getElementById('docLicense'),
        docBoardCertBadge: document.getElementById('docBoardCertBadge'),
        docLanguagesList: document.getElementById('docLanguagesList'),
        docStarsDisplay: document.getElementById('docStarsDisplay'),
        docTotalReviews: document.getElementById('docTotalReviews'),
        
        // Appointment elements
        docFees: document.getElementById('docFees'),
        docFeesDisplay: document.getElementById('docFeesDisplay'),
        docAcceptsNewStatus: document.getElementById('docAcceptsNewStatus'),
        docAcceptsNewStatusDisplay: document.getElementById('docAcceptsNewStatusDisplay'),
        docAppointmentCount: document.getElementById('docAppointmentCount'),
        docAppointmentsList: document.getElementById('docAppointmentsList'),
        
        // Availability elements
        docAvailabilityList: document.getElementById('docAvailabilityList')
      };
    }
  
    compileTemplates() {
      return {
        appointmentCard: (appointment) => {
          const statusColors = {
            'confirmed': 'bg-green-100 text-green-800',
            'pending': 'bg-yellow-100 text-yellow-800',
            'cancelled': 'bg-red-100 text-red-800',
            'completed': 'bg-blue-100 text-blue-800'
          };
          
          const statusColor = statusColors[appointment.status] || 'bg-slate-100 text-slate-800';
          
          return `
            <div class="p-3 sm:p-4 border-b border-slate-100 hover:bg-slate-50 transition-colors duration-150">
              <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2 mb-2">
                <div class="font-medium text-slate-800 text-sm sm:text-base truncate">${appointment.patientName}</div>
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusColor} self-start">
                  ${appointment.status}
                </span>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-1 sm:gap-2 text-xs sm:text-sm text-slate-600">
                <div class="flex items-center">
                  <svg class="w-3 h-3 sm:w-4 sm:h-4 inline mr-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                  </svg>
                  <span class="truncate">${appointment.appointmentDate}</span>
                </div>
                <div class="flex items-center">
                  <svg class="w-3 h-3 sm:w-4 sm:h-4 inline mr-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                  </svg>
                  <span class="truncate">${appointment.appointmentType}</span>
                </div>
              </div>
              ${appointment.reason ? `<div class="mt-2 text-xs sm:text-sm text-slate-600"><strong>Reason:</strong> <span class="break-words">${appointment.reason}</span></div>` : ''}
              ${appointment.cancelReason ? `<div class="mt-1 text-xs sm:text-sm text-red-600"><strong>Cancel Reason:</strong> <span class="break-words">${appointment.cancelReason}</span></div>` : ''}
            </div>
          `;
        },
  
        availabilitySlot: (slot) => {
          if (!slot.timeslot || slot.timeslot.length === 0) {
            return `
              <div class="mb-4 sm:mb-6">
                <div class="font-semibold text-slate-800 mb-2 flex items-center text-sm sm:text-base">
                  <svg class="w-3 h-3 sm:w-4 sm:h-4 mr-2 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                  </svg>
                  ${new Date(slot.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                </div>
                <div class="ml-4 sm:ml-6 text-slate-500 text-sm">No available time slots</div>
              </div>
            `;
          }
  
          const timeslotsHTML = slot.timeslot.map(time => `
            <div class="inline-flex items-center bg-green-50 border border-green-200 rounded-lg px-2 sm:px-3 py-1 sm:py-2 m-1">
              <svg class="w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <div class="text-xs sm:text-sm">
                <div class="font-medium text-green-800">${time.from_time} - ${time.to_time}</div>
                <div class="text-green-600">${time.duration} min • ${time.appointment_type}</div>
              </div>
            </div>
          `).join('');
  
          return `
            <div class="mb-4 sm:mb-6">
              <div class="font-semibold text-slate-800 mb-2 sm:mb-3 flex items-center text-sm sm:text-base">
                <svg class="w-3 h-3 sm:w-4 sm:h-4 mr-2 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                ${new Date(slot.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
              </div>
              <div class="ml-4 sm:ml-6 flex flex-wrap">${timeslotsHTML}</div>
            </div>
          `;
        },
  
        emptyAppointments: () => `
          <div class="p-6 sm:p-8 text-center text-slate-500">
            <svg class="w-10 h-10 sm:w-12 sm:h-12 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <div class="text-base sm:text-lg font-medium">No appointments found</div>
            <div class="text-sm">This doctor hasn't had any appointments yet.</div>
          </div>
        `,
  
        emptyAvailability: () => `
          <div class="p-6 sm:p-8 text-center text-slate-500">
            <svg class="w-10 h-10 sm:w-12 sm:h-12 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="text-base sm:text-lg font-medium">No available slots</div>
            <div class="text-sm">This doctor hasn't set up their availability yet.</div>
          </div>
        `
      };
    }
  
    setupEventListeners() {
      // Optimized event listeners with passive scrolling
      document.getElementById('closeDoctorModal').addEventListener('click', () => this.hide(), { passive: true });
      
      this.modal.addEventListener('click', (e) => {
        if (e.target === this.modal) this.hide();
      }, { passive: true });
  
      // Optimized trigger setup with event delegation
      document.addEventListener('click', (e) => {
        if (e.target.matches('.doctor-modal-trigger') || e.target.closest('.doctor-modal-trigger')) {
          const trigger = e.target.matches('.doctor-modal-trigger') ? e.target : e.target.closest('.doctor-modal-trigger');
          const slug = trigger.dataset.slug;
          if (slug) {
            e.preventDefault();
            this.show(slug);
          }
        }
      }, { passive: false });
    }
  
    setupTabSwitching() {
      // Event delegation for better performance
      document.addEventListener('click', (e) => {
        if (e.target.matches('.tab-btn') || e.target.closest('.tab-btn')) {
          const btn = e.target.matches('.tab-btn') ? e.target : e.target.closest('.tab-btn');
          const tab = btn.dataset.tab;
          if (tab) {
            e.preventDefault();
            this.switchTab(tab);
          }
        }
      }, { passive: false });
    }
  
    setupKeyboardNavigation() {
      document.addEventListener('keydown', (e) => {
        if (!this.isOpen) return;
        
        if (e.key === 'Escape') {
          e.preventDefault();
          this.hide();
        }
      }, { passive: false });
    }
  
    setupEditFunctionality() {
      // Personal Info Edit
      document.getElementById('editPersonalBtn').addEventListener('click', () => {
        this.showPersonalEditMode();
      });
  
      document.getElementById('cancelPersonalEdit').addEventListener('click', () => {
        this.hidePersonalEditMode();
      });
  
      document.getElementById('personalEditForm').addEventListener('submit', (e) => {
        e.preventDefault();
        this.savePersonalInfo();
      });
  
      // Professional Info Edit
      document.getElementById('editProfessionalBtn').addEventListener('click', () => {
        this.showProfessionalEditMode();
      });
  
      document.getElementById('cancelProfessionalEdit').addEventListener('click', () => {
        this.hideProfessionalEditMode();
      });
  
      document.getElementById('professionalEditForm').addEventListener('submit', (e) => {
        e.preventDefault();
        this.saveProfessionalInfo();
      });
  
      // Fees Edit
      document.getElementById('editFeesBtn').addEventListener('click', () => {
        this.showFeesEditMode();
      });
  
      document.getElementById('cancelFeesEdit').addEventListener('click', () => {
        this.hideFeesEditMode();
      });
  
      document.getElementById('feesEditForm').addEventListener('submit', (e) => {
        e.preventDefault();
        this.saveFeesInfo();
      });
  
      // Add Language Button
      document.getElementById('addLanguageBtn').addEventListener('click', () => {
        this.addLanguageField();
      });
    }
  
    switchTab(tabName) {
      // Use requestAnimationFrame for smooth transitions
      requestAnimationFrame(() => {
        // Remove active state from all tabs
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('border-blue-500', 'text-blue-600', 'font-semibold');
          btn.classList.add('text-slate-600');
        });
  
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.add('hidden');
        });
  
        // Activate selected tab
        const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
        const activeContent = document.getElementById(`tab-${tabName}`);
  
        if (activeBtn && activeContent) {
          activeBtn.classList.add('border-blue-500', 'text-blue-600', 'font-semibold');
          activeBtn.classList.remove('text-slate-600');
          activeContent.classList.remove('hidden');
        }
      });
    }
  
    show(slug) {
      const doctor = window.DocData?.find(d => d.slug === slug);
      if (!doctor) {
        console.warn('Doctor not found:', slug);
        return;
      }
  
      this.currentDoctor = doctor;
      
      // Show modal immediately with loading state
      this.modal.classList.remove('hidden');
      
      // Use requestAnimationFrame for smooth animation
      requestAnimationFrame(() => {
        this.modalContainer.classList.remove('scale-95', 'opacity-0');
        this.modalContainer.classList.add('scale-100', 'opacity-100');
        
        // Populate data asynchronously for faster perceived performance
        setTimeout(() => {
          this.populateData(doctor);
          this.isOpen = true;
          
          // Focus management
          document.getElementById('closeDoctorModal').focus();
        }, 50);
      });
    }
  
    hide() {
      this.isOpen = false;
      
      // Hide any open edit modes
      this.hidePersonalEditMode();
      this.hideProfessionalEditMode();
      this.hideFeesEditMode();
      
      // Animate out
      this.modalContainer.classList.remove('scale-100', 'opacity-100');
      this.modalContainer.classList.add('scale-95', 'opacity-0');
      
      // Hide modal after animation
      setTimeout(() => {
        this.modal.classList.add('hidden');
      }, 200);
    }
  
    // Personal Info Edit Methods
    showPersonalEditMode() {
      if (!this.currentDoctor) return;
  
      // Populate form with current data
      document.getElementById('editPersonalSlug').value = this.currentDoctor.slug;
      document.getElementById('editPhone').value = this.currentDoctor.phone || '';
      document.getElementById('editAddress').value = this.currentDoctor.address || '';
      document.getElementById('editGender').value = this.currentDoctor.gender || '';
      document.getElementById('editDob').value = this.currentDoctor.dob || '';
      document.getElementById('editActive').checked = this.currentDoctor.is_active || false;
      document.getElementById('editVerified').checked = this.currentDoctor.is_verified || false;


  
      // Toggle modes
      document.getElementById('personalViewMode').classList.add('hidden');
      document.getElementById('personalEditMode').classList.remove('hidden');
    }
  
    hidePersonalEditMode() {
      document.getElementById('personalViewMode').classList.remove('hidden');
      document.getElementById('personalEditMode').classList.add('hidden');
    }
  
    async savePersonalInfo() {
      const formData = new FormData(document.getElementById('personalEditForm'));
      const data = {
        request_type: 'personal',
        slug: formData.get('slug'),
        phone: formData.get('phone'),
        address: formData.get('address'),
        gender: formData.get('gender'),
        date_of_birth: formData.get('date_of_birth'),
        active: formData.get('active') === 'on',
        verified: formData.get('verified') === 'on'
      };

      showNotification({
        color: "bg-yellow-500",
        title: "Updating...",
        message: "Saving personal information, please wait..."
      });

      showLoadingOverlay();
  
      try {
        const response = await fetch('/m/edit-doc/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': this.getCSRFToken()
          },
          body: JSON.stringify(data)
        });
  
        const result = await response.json();
  
        if (result.success) {

          hideLoadingSpinner();
          // Update current doctor data
          this.currentDoctor.phone = data.phone;
          this.currentDoctor.address = data.address;
          this.currentDoctor.gender = data.gender;
          this.currentDoctor.dob = data.date_of_birth;
          this.currentDoctor.active = data.active;
          this.currentDoctor.verified = data.verified;
  
          // Update display
          this.populateBasicInfo(this.currentDoctor);
          this.hidePersonalEditMode();
          showNotification({
              color: "bg-green-500",
              title: "Update success.",
              message: "Personal information updated successfully!."
          });
        } else {
          hideLoadingSpinner();
          showNotification({
            color: "bg-red-500",
            title: "Update Error.",
            message: result.message || 'Failed to update personal information'
        });
        }
      } catch (error) {
        hideLoadingSpinner();
        console.error('Error saving personal info:', error);
        showNotification({
          color: "bg-red-500",
          title: "Update Error.",
          message: result.message || 'Failed to update personal information'
      });
      }
    }
  
    // Professional Info Edit Methods
    showProfessionalEditMode() {
      if (!this.currentDoctor) return;
  
      // Populate form with current data
      document.getElementById('editProfessionalSlug').value = this.currentDoctor.slug;
      document.getElementById('editSpecialization').value = this.currentDoctor.specialization_code || '';
      document.getElementById('editQualifications').value = this.currentDoctor.qualifications || '';
      document.getElementById('editExperience').value = this.currentDoctor.experience || '';
      document.getElementById('editLicenseNumber').value = this.currentDoctor.licenseNumber || '';
      document.getElementById('editBoardCertified').checked = this.currentDoctor.boardCertified || false;
  
      // Populate languages
      this.populateLanguageFields();
  
      // Toggle modes
      document.getElementById('professionalViewMode').classList.add('hidden');
      document.getElementById('professionalEditMode').classList.remove('hidden');
    }
  
    hideProfessionalEditMode() {
      document.getElementById('professionalViewMode').classList.remove('hidden');
      document.getElementById('professionalEditMode').classList.add('hidden');
    }
  
    populateLanguageFields() {
      const container = document.getElementById('languagesContainer');
      container.innerHTML = '';
      this.languageCounter = 0;
  
      const languages = Array.isArray(this.currentDoctor.languages) ? 
        this.currentDoctor.languages : 
        (this.currentDoctor.languages ? this.currentDoctor.languages.split(',').map(l => l.trim()) : []);
  
      if (languages.length === 0) {
        this.addLanguageField();
      } else {
        languages.forEach(language => {
          this.addLanguageField(language);
        });
      }
    }
  
    addLanguageField(value = '') {
      const container = document.getElementById('languagesContainer');
      const fieldId = `language_${this.languageCounter++}`;
      
      const fieldHTML = `
        <div class="flex items-center gap-2" data-language-field="${fieldId}">
          <input type="text" name="languages[]" value="${value}" placeholder="Enter language" class="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
          <button type="button" class="px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors duration-150" onclick="this.parentElement.remove()">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', fieldHTML);
    }
  
    async saveProfessionalInfo() {
      const form = document.getElementById('professionalEditForm');
      const formData = new FormData(form);
      
      // Collect languages
      const languages = Array.from(form.querySelectorAll('input[name="languages[]"]'))
        .map(input => input.value.trim())
        .filter(lang => lang.length > 0);
  
      const data = {
        request_type: 'professional',
        slug: formData.get('slug'),
        specialization: formData.get('specialization'),
        qualifications: formData.get('qualifications'),
        experience_years: parseInt(formData.get('experience_years')) || 0,
        license_number: formData.get('license_number'),
        board_certified: document.getElementById('editBoardCertified').checked,
        languages_spoken: languages
      };
  
      try {
        showNotification({
          color: "bg-yellow-500",
          title: "Updating...",
          message: "Saving professional information, please wait..."
        });

        showLoadingOverlay();
        const response = await fetch('/m/edit-doc/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': this.getCSRFToken()
          },
          body: JSON.stringify(data)
        });
  
        const result = await response.json();
  
        if (result.success) {
          hideLoadingSpinner();
          // Update current doctor data
          this.currentDoctor.specialization = this.getSpecializationDisplay(data.specialization);
          this.currentDoctor.specialization_code = data.specialization;
          this.currentDoctor.qualifications = data.qualifications;
          this.currentDoctor.experience = data.experience_years;
          this.currentDoctor.licenseNumber = data.license_number;
          this.currentDoctor.boardCertified = data.board_certified;
          this.currentDoctor.languages = languages;
  
          // Update display
          this.populateProfessionalInfo(this.currentDoctor);
          this.hideProfessionalEditMode();
          showNotification({
            color: "bg-green-500",
            title: "Update Professional success.",
            message: 'Professional information updated successfully!'
        });
        } else {
            hideLoadingSpinner();
            showNotification({
              color: "bg-red-500",
              title: "Update Professional Error.",
              message: result.message || 'Failed to update professional information'
          });
        }
      } catch (error) {
        hideLoadingSpinner();
        console.error('Error saving professional info:', error);
        showNotification({
          color: "bg-red-500",
          title: "Update Professional Error.",
          message: error || 'An error occurred while saving'
      });
      }
    }
  
    // Fees Edit Methods
    showFeesEditMode() {
      if (!this.currentDoctor) return;
  
      // Populate form with current data
      document.getElementById('editFeesSlug').value = this.currentDoctor.slug;
      document.getElementById('editFees').value = this.currentDoctor.fees || '';
      document.getElementById('editAcceptsNew').value = this.currentDoctor.accepts_new_patients ? 'true' : 'false';
  
      // Toggle modes
      document.getElementById('feesViewMode').classList.add('hidden');
      document.getElementById('feesEditMode').classList.remove('hidden');
    }
  
    hideFeesEditMode() {
      document.getElementById('feesViewMode').classList.remove('hidden');
      document.getElementById('feesEditMode').classList.add('hidden');
    }
  
    async saveFeesInfo() {
      const formData = new FormData(document.getElementById('feesEditForm'));
      const data = {
        request_type: 'fees',
        slug: formData.get('slug'),
        fees: parseFloat(formData.get('fees')) || 0,
        accepts_new_patients: formData.get('accepts_new_patients') === 'true'
      };
  
      try {
        showNotification({
          color: "bg-yellow-500",
          title: "Updating...",
          message: "Saving fees and availability, please wait..."
        });
        showLoadingOverlay();

        const response = await fetch('/m/edit-doc/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': this.getCSRFToken()
          },
          body: JSON.stringify(data)
        });
  
        const result = await response.json();
  
        if (result.success) {
          hideLoadingSpinner();
          // Update current doctor data
          this.currentDoctor.fees = data.fees;
          this.currentDoctor.accepts_new_patients = data.accepts_new_patients;
  
          // Update display
          this.populateAppointments(this.currentDoctor);
          this.hideFeesEditMode();
          showNotification({
            color: "bg-green-500",
            title: "Update Fees success.",
            message: 'Fees and availability updated successfully!'
          });
        } else {
          hideLoadingSpinner();
          showNotification({
            color: "bg-red-500",
            title: "Update Fees Error.",
            message: result.message || 'Failed to update fees information'
          });
        }
      } catch (error) {
        hideLoadingSpinner();
        console.error('Error saving fees info:', error);
        showNotification({
          color: "bg-red-500",
          title: "Update Fees Error.",
          message: error || 'An error occurred while saving'
        });
      }
    }
  
    // Utility Methods
    getCSRFToken() {
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
      console.log('CSRF Token:', csrfToken ? csrfToken.value : 'Not found');
      return csrfToken ? csrfToken.value : '';
    }
  
    getSpecializationDisplay(code) {
      const specializations = {
        'general_medicine': 'General Medicine',
        'cardiology': 'Cardiology',
        'dermatology': 'Dermatology',
        'neurology': 'Neurology',
        'orthopedics': 'Orthopedics',
        'pediatrics': 'Pediatrics',
        'psychiatry': 'Psychiatry',
        'radiology': 'Radiology',
        'surgery': 'Surgery',
        'other': 'Other'
      };
      return specializations[code] || code;
    }
  
    
  
    populateData(doctor) {
      // Use batch DOM updates for better performance
      this.batchUpdate(() => {
        this.populateBasicInfo(doctor);
        this.populateProfessionalInfo(doctor);
        this.populateAppointments(doctor);
        this.populateAvailability(doctor);
      });
      
      // Reset to first tab
      this.switchTab('basic');
    }
  
    batchUpdate(updateFunction) {
      // Group DOM updates to minimize reflow/repaint
      requestAnimationFrame(() => {
        updateFunction();
      });
    }
  
    populateBasicInfo(doctor) {
      const els = this.elements;
      
      // Header information with fallbacks
      els.docProfilePic.src = doctor.profilePic || '/static/images/default-avatar.png';
      els.docProfilePic.alt = `${doctor.name || 'Doctor'} Profile Picture`;
      els.docName.textContent = doctor.name || 'N/A';
      els.docSpecialization.textContent = doctor.specialization || 'General Practitioner';
      els.docRating.textContent = doctor.star_rating || '0.0';
      els.docReviews.textContent = doctor.total_reviews || '0';
  
      // Active/verified status with better UX
      this.setActiveStatus(doctor.is_active);
      this.setVerifiedStatus(doctor.is_verified);
  
      // Contact information
      els.docEmail.textContent = doctor.email || 'N/A';
      els.docPhone.textContent = doctor.phone || 'N/A';
      els.docAddress.textContent = doctor.address || 'N/A';
  
      // Personal details
      els.docUsername.textContent = doctor.username ? `@${doctor.username}` : 'N/A';
      els.docGender.textContent = doctor.gender || 'N/A';
      els.docDob.textContent = doctor.dob || 'N/A';
    }
  
    setActiveStatus(isActive) {
      const indicator = this.elements.docActiveIndicator;
      const indicatorSmall = this.elements.docActiveIndicatorSmall;
      const status = this.elements.docActiveStatus;
      
      if (isActive) {
        indicator.className = 'absolute -bottom-1 -right-1 w-5 h-5 sm:w-6 sm:h-6 bg-green-500 rounded-full border-2 border-white';
        indicatorSmall.className = 'w-3 h-3 rounded-full mr-2 bg-green-500';
        status.textContent = 'Active';
        status.className = 'text-xs sm:text-sm text-green-600';
      } else {
        indicator.className = 'absolute -bottom-1 -right-1 w-5 h-5 sm:w-6 sm:h-6 bg-red-500 rounded-full border-2 border-white';
        indicatorSmall.className = 'w-3 h-3 rounded-full mr-2 bg-red-500';
        status.textContent = 'Inactive';
        status.className = 'text-xs sm:text-sm text-red-600';
      }
    }
  
    setVerifiedStatus(isVerified) {
      const verifiedBadge = this.elements.docVerifiedBadge;
      const verifiedStatus = this.elements.docVerifiedStatus;
      
      if (isVerified) {
        verifiedBadge.classList.remove('hidden');
        verifiedStatus.innerHTML = `
          <svg class="w-3 h-3 sm:w-4 sm:h-4 mr-1 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
          </svg>
          <span class="text-xs sm:text-sm text-green-600">Verified</span>
        `;
      } else {
        verifiedBadge.classList.add('hidden');
        verifiedStatus.innerHTML = `
          <svg class="w-3 h-3 sm:w-4 sm:h-4 mr-1 text-red-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
          </svg>
          <span class="text-xs sm:text-sm text-red-600">Unverified</span>
        `;
      }
    }
  
    populateProfessionalInfo(doctor) {
      const els = this.elements;
      
      els.docQualifications.textContent = doctor.qualifications || 'N/A';
      els.docExperience.textContent = doctor.experience || '0';
      els.docLicense.textContent = doctor.licenseNumber || 'N/A';
  
      // Board certification with optimized rendering
      this.setBoardCertification(doctor.boardCertified);
      this.setLanguages(doctor.languages);
      this.setStarRating(parseFloat(doctor.star_rating) || 0);
      
      els.docTotalReviews.textContent = doctor.total_reviews || '0';
    }
  
    setBoardCertification(isCertified) {
      const badge = this.elements.docBoardCertBadge;
      
      if (isCertified) {
        badge.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
        badge.innerHTML = `
          <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
          </svg>
          Board Certified
        `;
      } else {
        badge.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800';
        badge.textContent = 'Not Board Certified';
      }
    }
  
    setLanguages(languages) {
      const languagesList = this.elements.docLanguagesList;
      const langs = Array.isArray(languages) ? languages : 
                   (languages ? languages.split(',').map(l => l.trim()) : []);
      
      if (langs.length > 0) {
        languagesList.innerHTML = langs.map(lang => 
          `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${lang}</span>`
        ).join('');
      } else {
        languagesList.innerHTML = '<span class="text-slate-500 text-xs sm:text-sm">No languages specified</span>';
      }
    }
  
    setStarRating(rating) {
      const starsDisplay = this.elements.docStarsDisplay;
      const fullStars = Math.floor(rating);
      const hasHalfStar = rating % 1 >= 0.5;
      
      let starsHTML = '';
      for (let i = 0; i < 5; i++) {
        if (i < fullStars) {
          starsHTML += '<svg class="w-3 h-3 sm:w-4 sm:h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>';
        } else if (i === fullStars && hasHalfStar) {
          starsHTML += '<svg class="w-3 h-3 sm:w-4 sm:h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><defs><clipPath id="half"><rect x="0" y="0" width="10" height="20"/></clipPath></defs><path clip-path="url(#half)" d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>';
        } else {
          starsHTML += '<svg class="w-3 h-3 sm:w-4 sm:h-4 text-slate-300" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>';
        }
      }
      starsDisplay.innerHTML = starsHTML;
    }
  
    populateAppointments(doctor) {
      const els = this.elements;
      
      // Fee and status
      els.docFees.textContent = doctor.fees || '0.00';
      els.docFeesDisplay.textContent = doctor.fees || '0.00';
      this.setAcceptingNewPatients(doctor.accepts_new_patients);
  
      // Appointment count
      const appointmentCount = doctor.appointments ? doctor.appointments.length : 0;
      els.docAppointmentCount.textContent = appointmentCount;
  
      // Appointments list with virtual scrolling concept for large lists
      this.renderAppointmentsList(doctor.appointments || []);
    }
  
    setAcceptingNewPatients(accepts) {
      const statusEl = this.elements.docAcceptsNewStatus;
      const statusDisplayEl = this.elements.docAcceptsNewStatusDisplay;
      
      const statusHTML = accepts ? `
        <span class="inline-flex items-center text-green-600 text-xs sm:text-sm">
          <svg class="w-3 h-3 sm:w-4 sm:h-4 mr-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
          </svg>
          <span class="hidden xs:inline">Accepting New Patients</span>
          <span class="xs:hidden">Accepting</span>
        </span>
      ` : `
        <span class="inline-flex items-center text-red-600 text-xs sm:text-sm">
          <svg class="w-3 h-3 sm:w-4 sm:h-4 mr-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
          </svg>
          <span class="hidden xs:inline">Not Accepting</span>
          <span class="xs:hidden">Not Accepting</span>
        </span>
      `;
      
      statusEl.innerHTML = statusHTML;
      statusDisplayEl.innerHTML = statusHTML;
    }
  
    renderAppointmentsList(appointments) {
      const appointmentsList = this.elements.docAppointmentsList;
      
      if (appointments.length > 0) {
        // Use DocumentFragment for better performance
        const fragment = document.createDocumentFragment();
        const container = document.createElement('div');
        
        const appointmentsHTML = appointments.map(appointment => 
          this.templates.appointmentCard(appointment)
        ).join('');
        
        container.innerHTML = appointmentsHTML;
        while (container.firstChild) {
          fragment.appendChild(container.firstChild);
        }
        
        appointmentsList.innerHTML = '';
        appointmentsList.appendChild(fragment);
      } else {
        appointmentsList.innerHTML = this.templates.emptyAppointments();
      }
    }
  
    populateAvailability(doctor) {
      const availabilityList = this.elements.docAvailabilityList;
      
      if (doctor.availableSlots && doctor.availableSlots.length > 0) {
        const availabilityHTML = doctor.availableSlots.map(slot => 
          this.templates.availabilitySlot(slot)
        ).join('');
        
        availabilityList.innerHTML = availabilityHTML;
      } else {
        availabilityList.innerHTML = this.templates.emptyAvailability();
      }
    }
  }
  
  // Initialize the modal when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    // Initialize modal only if the required elements exist
    if (document.getElementById('doctorModal')) {
      window.doctorModal = new FastDoctorModalWithEdit();
    }
  });
  
  // Keep your existing DocData array here - no changes needed to the structure
  // Just make sure it's available globally
  if (typeof window !== 'undefined') {
    window.DocData = window.DocData || [
      {% for eachDoc in doctors %}
      {
        // Basic Info
        username: "{{ eachDoc.user.username }}",
        name: "{{ eachDoc.user.get_full_name }}",
        profilePic: "{{ eachDoc.profile_pic.url }}",
        email: "{{ eachDoc.user.email }}",
        phone: "{{ eachDoc.ph_number|default:'' }}",
        address: "{{ eachDoc.address|default:'' }}",
        gender: "{{ eachDoc.gender|default:'' }}",
        dob: "{{ eachDoc.date_of_birth|date:'Y-m-d'|default:'' }}",
        is_active: {{ eachDoc.is_active|yesno:"true,false" }},
        is_verified: {{ eachDoc.is_verified|yesno:"true,false" }},
      
        // Doctor Info
        slug: "{{ eachDoc.doctor_profile.slug }}",
        createdAt: "{{ eachDoc.doctor_profile.created_at|date:'Y-m-d H:i:s' }}",
        specialization: "{{ eachDoc.doctor_profile.get_specialization_display }}",
        specialization_code: "{{ eachDoc.doctor_profile.specialization }}",
        qualifications: `{{ eachDoc.doctor_profile.qualifications|default:'' }}`,
        experience: "{{ eachDoc.doctor_profile.experience_years|default:'' }}",
        licenseNumber: "{{ eachDoc.doctor_profile.license_number|default:'' }}",
        boardCertified: {{ eachDoc.doctor_profile.board_certified|yesno:"true,false" }},
        languages: {{ eachDoc.doctor_profile.languages_spoken|default:'[]'|safe }},
        
        star_rating: {{ eachDoc.doctor_profile.star_rating|default:'0' }},
        total_reviews: {{ eachDoc.doctor_profile.total_reviews|default:'0' }},
        
        // Appointment Info
        fees: "{{ eachDoc.doctor_profile.fees|default:'0.00' }}",
        accepts_new_patients: {{ eachDoc.doctor_profile.accepts_new_patients|yesno:"true,false" }},
        appointments: [
        {% for appointment in eachDoc.doctor_profile.doctors_appointments.all %}
        {
          appo_uuid: "{{ appointment.uuid }}",
          patientName: "{{ appointment.profile.user.get_full_name }}",
          patientUsername: "{{ appointment.profile.user.username }}",
  
          reason: "{{ appointment.reason|default:'' }}",
          appointmentType: "{{ appointment.appointment_type }}",
          status: "{{ appointment.status }}",
          appointmentDate: "{{ appointment.appointment_date|date:'Y-m-d' }} {{ appointment.appointment_date|time:'H:i:s' }}",
          
          canceledBy: "{{ appointment.canceled_by.user.get_full_name|default:'' }}",
          cancelReason: "{{ appointment.cancel_reason|default:'' }}",
          confirmedBy: "{{ appointment.confirm_by.user.get_full_name|default:'' }}",
          createdAt: "{{ appointment.created_at|date:'Y-m-d H:i:s'|default:'' }}",
          updatedAt: "{{ appointment.updated_at|date:'Y-m-d H:i:s'|default:'' }}",
        },
        {% endfor %}
        ],
  
        availableSlots: [
          {% for dateslot in eachDoc.doctor_profile.datetime_slots.all %}
          {
            date: "{{ dateslot.date }}",
            timeslot: [
              {% for timeslot in dateslot.appointment_times.all %}
                  {% if timeslot.status == 'available' %}
                    {
                    "duration": "{{ timeslot.duration }}",
                    "from_time": "{{ timeslot.from_time }}",
                    "to_time": "{{ timeslot.to_time }}",
                    "appointment_type": "{{ timeslot.appointment_type }}",
                    "unique_id": "{{ timeslot.unique_id }}",
                    "status": "{{ timeslot.status }}"
                    },
                  {% endif %}
              {% endfor %}
            ]
          },
          {% endfor %}
        ]
      },
      {% endfor %}
    ];
  }
  
  // Utility function to manually trigger modal (for testing or external use)
  window.showDoctorModal = function(slug) {
    if (window.doctorModal) {
      window.doctorModal.show(slug);
    }
  };
  
  // Error handling for missing elements
  window.addEventListener('error', (e) => {
    if (e.message.includes('doctorModal') || e.message.includes('DocData')) {
      console.warn('Doctor Modal: Some required elements or data may be missing');
    }
  });

</script>




{% endblock content %}


{% block scripts %}

<script>

  document.addEventListener('DOMContentLoaded', function() {
    // DOM Elements
    const addModalTriggers = document.getElementById('add-doctor-trigger');
    const addModalOverlay = document.getElementById('add-doctor-modal-overlay');
    const addModal = document.getElementById('add-doctor-modal');
    const closeAddModalBtn = document.getElementById('close-add-doctor-modal');
    const addDoctorForm = document.getElementById('add-doctor-form');
    const submitBtn = document.getElementById('submit-doctor-btn');
    const submitSpinner = document.getElementById('doctor-submit-spinner');
    
    // Form steps buttons
    const nextStepBtns = document.querySelectorAll('.next-step-btn');
    const prevStepBtns = document.querySelectorAll('.prev-step-btn');
    const formSteps = document.querySelectorAll('.form-step');
    
    // Step indicators
    const stepIndicators = {
        1: document.getElementById('step-indicator-1'),
        2: document.getElementById('step-indicator-2'),
        3: document.getElementById('step-indicator-3')
    };
    
    // Language management
    const languagesContainer = document.getElementById('languages-container');
    const newLanguageInput = document.getElementById('new-language');
    const addLanguageBtn = document.getElementById('add-language-btn');
    const languagesSpokenInput = document.getElementById('languages-spoken');
    
    // Profile picture preview
    const profilePicInput = document.getElementById('doctor-profile-pic');
    const profilePicPreview = document.getElementById('profile-pic-preview');
    
    // Current step tracker
    let currentStep = 1;
    
    // Languages array
    let languages = ['English'];
    
    // ---- Event Listeners ----
    
    // Open modal when clicking add doctor buttons
    addModalTriggers.addEventListener('click', openAddModal);
    
    // Close modal when clicking the close button
    closeAddModalBtn.addEventListener('click', function() {
        if (isFormDirty() && !confirm('You have unsaved changes. Are you sure you want to close?')) {
            return;
        }
        closeAddModal();
    });
    
    // Close modal when clicking outside
    addModalOverlay.addEventListener('click', function(e) {
        if (e.target === addModalOverlay) {
            if (isFormDirty() && !confirm('You have unsaved changes. Are you sure you want to close?')) {
                return;
            }
            closeAddModal();
        }
    });
    
    // Next step buttons
    nextStepBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const nextStep = parseInt(this.dataset.next);
            if (validateCurrentStep()) {
                goToStep(nextStep);
            }
        });
    });
    
    // Previous step buttons
    prevStepBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const prevStep = parseInt(this.dataset.prev);
            goToStep(prevStep);
        });
    });
    
    // Add language button
    if (addLanguageBtn) {
        addLanguageBtn.addEventListener('click', addLanguage);
    }
    
    // New language input - add on Enter key
    if (newLanguageInput) {
        newLanguageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addLanguage();
            }
        });
    }
    
    // Profile picture change event
    if (profilePicInput) {
        profilePicInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    profilePicPreview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover" alt="Profile Preview">`;
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Remove language button (delegation)
    document.addEventListener('click', function(e) {
        if (e.target.closest('.language-remove-btn')) {
            const btn = e.target.closest('.language-remove-btn');
            const language = btn.dataset.language;
            removeLanguage(language);
        }
    });
    
    // Form submission
    if (addDoctorForm) {
        addDoctorForm.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent default form submission
            
            // Validate the current step (last step)
            if (!validateCurrentStep()) {
                return false;
            }
            
            // Disable submit button and show spinner
            submitBtn.disabled = true;
            submitSpinner.classList.remove('hidden');
            
            // Get form data including file
            const formData = new FormData(addDoctorForm);
            
            // Add languages as JSON string
            formData.set('languages_spoken', JSON.stringify(languages));
            
            // Get CSRF token from cookie
            const csrfToken = getCsrfToken();
            
            
            // Make the API request
            fetch('/m/create-doctors/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || 'Error creating doctor');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Show success notification
                showNotification({
                    color: "bg-green-500",
                    title: "Success ✅",
                    message: "Doctor registered successfully."
                });
                
                // Close the modal
                closeAddModal();
                
                // Reload the page to show the new doctor
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            })
            .catch(error => {
                // Show error notification
                showNotification({
                    color: "bg-red-500",
                    title: "Registration Failed",
                    message: error.message || "Failed to register doctor."
                });
            })
            .finally(() => {
                // Re-enable submit button and hide spinner
                submitBtn.disabled = false;
                submitSpinner.classList.add('hidden');
            });
            
            return false;
        });
    }
    
    // ---- Functions ----
    
    /**
     * Check if the form has been modified
     * @returns {boolean} Whether the form is dirty
     */
    function isFormDirty() {
        // Check if any field has been filled
        const formElements = addDoctorForm.elements;
        for (let i = 0; i < formElements.length; i++) {
            const element = formElements[i];
            if (element.type !== 'submit' && element.type !== 'button') {
                if ((element.type === 'checkbox' || element.type === 'radio') && element.checked !== element.defaultChecked) {
                    return true;
                } else if (element.type !== 'checkbox' && element.type !== 'radio' && element.value !== element.defaultValue) {
                    return true;
                }
            }
        }
        
        // Check if languages have been modified
        if (JSON.stringify(languages) !== '["English"]') {
            return true;
        }
        
        // Check if profile pic has been selected
        if (profilePicInput.files.length > 0) {
            return true;
        }
        
        return false;
    }
    
    /**
     * Open the add doctor modal
     */
    function openAddModal() {
        // Reset form if it exists
        if (addDoctorForm) {
            addDoctorForm.reset();
            
            // Reset to first step
            goToStep(1);
            
            // Reset languages
            languages = ['English'];
            updateLanguagesUI();
            
            // Reset profile pic preview
            profilePicPreview.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
            `;
            
            // Clear error messages
            document.querySelectorAll('.field-error').forEach(el => el.remove());
            document.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500'));
        }
        
        // Show the modal with animation
        addModalOverlay.classList.remove('hidden');
        setTimeout(() => {
            addModalOverlay.classList.add('opacity-100');
            addModal.classList.add('opacity-100', 'scale-100');
            addModal.classList.remove('scale-95', 'opacity-0');
        }, 10);
        
        // Focus on the first field
        setTimeout(() => {
            document.getElementById('doctor-email').focus();
        }, 300);
        
        // Update current time
        updateCurrentTime();
    }
    
    /**
     * Close the add doctor modal
     */
    function closeAddModal() {
        // Hide the modal with animation
        addModalOverlay.classList.remove('opacity-100');
        addModal.classList.remove('opacity-100', 'scale-100');
        addModal.classList.add('scale-95', 'opacity-0');
        
        setTimeout(() => {
            addModalOverlay.classList.add('hidden');
        }, 300);
    }
    
    /**
     * Go to a specific step in the form
     * @param {number} step - The step number to go to
     */
    function goToStep(step) {
        // Hide all steps
        formSteps.forEach(formStep => {
            formStep.classList.add('hidden');
        });
        
        // Show the selected step
        document.getElementById(`form-step-${step}`).classList.remove('hidden');
        
        // Update step indicators
        updateStepIndicators(step);
        
        // Update current step
        currentStep = step;
        
        // Scroll to top of modal content
        const modalContent = document.querySelector('.flex-1.overflow-y-auto');
        if (modalContent) {
            modalContent.scrollTop = 0;
        }
    }
    
    /**
     * Update the step indicators
     * @param {number} currentStep - The current step
     */
    function updateStepIndicators(currentStep) {
        // Update all step indicators
        for (let i = 1; i <= 3; i++) {
            const indicator = stepIndicators[i];
            
            if (i < currentStep) {
                // Completed step
                indicator.className = 'rounded-full transition duration-500 ease-in-out h-12 w-12 py-3 border-2 border-teal-600 bg-teal-600 text-white font-bold flex items-center justify-center';
                indicator.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                `;
            } else if (i === currentStep) {
                // Current step
                indicator.className = 'rounded-full transition duration-500 ease-in-out h-12 w-12 py-3 border-2 border-teal-600 bg-teal-600 text-white font-bold flex items-center justify-center';
                indicator.textContent = i;
            } else {
                // Future step
                indicator.className = 'rounded-full transition duration-500 ease-in-out h-12 w-12 py-3 border-2 border-gray-300 bg-white font-bold flex items-center justify-center text-gray-500';
                indicator.textContent = i;
            }
        }
        
        // Update connector lines
        const connectors = document.querySelectorAll('.flex-auto.border-t-2');
        connectors.forEach((connector, index) => {
            if (index < currentStep - 1) {
                connector.classList.remove('border-gray-300');
                connector.classList.add('border-teal-600');
            } else {
                connector.classList.remove('border-teal-600');
                connector.classList.add('border-gray-300');
            }
        });
    }
    
    /**
     * Add a language to the list
     */
    function addLanguage() {
        const language = newLanguageInput.value.trim();
        
        if (!language) {
            return;
        }
        
        // Check if already exists
        if (languages.includes(language)) {
            showNotification({
                color: "bg-yellow-500",
                title: "Warning",
                message: `Language "${language}" is already in the list.`
            });
            newLanguageInput.value = '';
            return;
        }
        
        // Add to array
        languages.push(language);
        
        // Update UI
        updateLanguagesUI();
        
        // Clear input
        newLanguageInput.value = '';
    }
    
    /**
     * Remove a language from the list
     * @param {string} language - The language to remove
     */
    function removeLanguage(language) {
        // Remove from array
        const index = languages.indexOf(language);
        if (index !== -1) {
            languages.splice(index, 1);
            
            // Update UI
            updateLanguagesUI();
        }
    }
    
    /**
     * Update the languages UI
     */
    function updateLanguagesUI() {
        // Clear container
        languagesContainer.innerHTML = '';
        
        // Add each language
        languages.forEach(language => {
            const languageTag = document.createElement('div');
            languageTag.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800';
            languageTag.innerHTML = `
                <span>${language}</span>
                <button type="button" class="ml-1 text-blue-600 hover:text-blue-800 language-remove-btn" data-language="${language}">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
            `;
            languagesContainer.appendChild(languageTag);
        });
        
        // Update hidden input
        languagesSpokenInput.value = JSON.stringify(languages);
    }
    
    /**
     * Validate the current step
     * @returns {boolean} Whether the current step is valid
     */
    function validateCurrentStep() {
        let isValid = true;
        
        // Clear previous error messages
        document.querySelectorAll('.field-error').forEach(el => el.remove());
        document.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500'));
        
        // Step 1 validation
        if (currentStep === 1) {
            // Required fields
            const email = document.getElementById('doctor-email');
            const phone = document.getElementById('doctor-phone');
            const fullName = document.getElementById('doctor-name');
            const password = document.getElementById('doctor-password');
            
            // Validate email
            if (!email.value.trim()) {
                showFieldError(email, 'Email is required');
                isValid = false;
            } else if (!isValidEmail(email.value.trim())) {
                showFieldError(email, 'Please enter a valid email address');
                isValid = false;
            }
            
            // Validate phone
            if (!phone.value.trim()) {
                showFieldError(phone, 'Phone number is required');
                isValid = false;
            } else if (!isValidPhone(phone.value.trim())) {
                showFieldError(phone, 'Please enter a valid phone number format');
                isValid = false;
            }
            
            // Validate name
            if (!fullName.value.trim()) {
                showFieldError(fullName, 'Full name is required');
                isValid = false;
            }
            
            // Validate password
            if (!password.value) {
                showFieldError(password, 'Password is required');
                isValid = false;
            } else if (password.value.length < 8) {
                showFieldError(password, 'Password must be at least 8 characters');
                isValid = false;
            }
            
            // Validate date of birth (if provided)
            const dob = document.getElementById('doctor-dob');
            if (dob.value) {
                const dobDate = new Date(dob.value);
                const today = new Date();
                
                if (dobDate > today) {
                    showFieldError(dob, 'Date of birth cannot be in the future');
                    isValid = false;
                }
                
                // Check if doctor is at least 18 years old
                const minAge = new Date();
                minAge.setFullYear(minAge.getFullYear() - 18);
                
                if (dobDate > minAge) {
                    showFieldError(dob, 'Doctor must be at least 18 years old');
                    isValid = false;
                }
            }
        }
        
        // Step 2 validation
        else if (currentStep === 2) {
            // Required fields
            const specialization = document.getElementById('specialization');
            const experienceYears = document.getElementById('experience-years');
            
            // Validate specialization
            if (!specialization.value) {
                showFieldError(specialization, 'Specialization is required');
                isValid = false;
            }
            
            // Validate experience years
            if (!experienceYears.value) {
                showFieldError(experienceYears, 'Years of experience is required');
                isValid = false;
            } else {
                const years = parseInt(experienceYears.value);
                if (years < 0) {
                    showFieldError(experienceYears, 'Years of experience cannot be negative');
                    isValid = false;
                } else if (years > 70) {
                    showFieldError(experienceYears, 'Years of experience cannot exceed 70');
                    isValid = false;
                }
            }
        }
        
        // Step 3 validation
        else if (currentStep === 3) {
            // Required fields
            const fees = document.getElementById('fees');
            
            // Validate fees
            if (!fees.value) {
                showFieldError(fees, 'Consultation fee is required');
                isValid = false;
            } else {
                const fee = parseFloat(fees.value);
                if (fee < 0) {
                    showFieldError(fees, 'Consultation fee cannot be negative');
                    isValid = false;
                }
            }
        }
        
        return isValid;
    }
    
    /**
     * Show an error message for a field
     * @param {HTMLElement} field - The field with the error
     * @param {string} message - The error message
     */
    function showFieldError(field, message) {
        // Add error class to the field
        field.classList.add('border-red-500');
        
        // Create error message element
        const errorElement = document.createElement('p');
        errorElement.className = 'mt-1 text-sm text-red-600 field-error';
        errorElement.textContent = message;
        
        // Insert the error message after the field
        field.parentNode.insertBefore(errorElement, field.nextSibling);
        
        // Focus on the first field with an error
        if (!document.querySelector('.field-error ~ .field-error')) {
            field.focus();
        }
    }
    
    /**
     * Check if an email is valid
     * @param {string} email - The email to validate
     * @returns {boolean} Whether the email is valid
     */
    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }
    
    /**
     * Check if a phone number is valid
     * @param {string} phone - The phone number to validate
     * @returns {boolean} Whether the phone number is valid
     */
    function isValidPhone(phone) {
        const phoneRegex = /^\+?1?\d{9,15}$/;
        return phoneRegex.test(phone);
    }
    
    /**
     * Get CSRF token from cookie
     * @returns {string} The CSRF token
     */
    function getCsrfToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        
        return cookieValue;
    }
    
    /**
     * Update the current time display
     */
    function updateCurrentTime() {
        const timeElement = document.getElementById('current-time');
        if (timeElement) {
            const now = new Date();
            const year = now.getUTCFullYear();
            const month = String(now.getUTCMonth() + 1).padStart(2, '0');
            const day = String(now.getUTCDate()).padStart(2, '0');
            const hours = String(now.getUTCHours()).padStart(2, '0');
            const minutes = String(now.getUTCMinutes()).padStart(2, '0');
            const seconds = String(now.getUTCSeconds()).padStart(2, '0');
            
            timeElement.textContent = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
    }
});
</script>



<script>

    // DOM Elements
    const searchInput = document.getElementById('searchInput');

    // Event Listeners
    searchInput.addEventListener('input', (e) => {
        searchTerm = e.target.value;
        const rows = document.querySelectorAll('#patientTableBody tr');
        rows.forEach(row => {
            const patientName = row.querySelector('[data-patient]').getAttribute('data-patient').toLowerCase();
            if (patientName.includes(searchTerm.toLowerCase())) {
            row.style.display = '';
            } else {
            row.style.display = 'none';
            }
        });
    });

</script>

<script>
    dashboard_nav_all = document.querySelectorAll('.ViewDoctors-nav a');
    dashboard_nav_all.forEach((nav) => {
        nav_innertab =
            nav.classList.add('border-l-4', 'border-blue-500', 'bg-blue-50', 'rounded');
    });
</script>


{% endblock scripts %}